//******************************************************************************
// ДоначислениеАмортизацииДляЦелейНалоговогоУчета()
//
// Параметры:
//  Нет.
//
// Вызывается из формул элементов диалога:
//  Нет.
//
// Описание:
//  Здесь описывается процедура.
//
Процедура ДоначислениеАмортизацииДляЦелейНалоговогоУчета(СведенияОбОбъекте)
	
	РассчитаннаяАмортизация = СведенияОбОбъекте.Получить("РассчитаннаяАмортизацияНалог");
	КапВложенияНаправленныеНаРасходы = СведенияОбОбъекте.Получить("КапВложенияНаправленныеНаРасходы");  
	Если РассчитаннаяАмортизация <> 0  Тогда
		СчетИАналитикаДляОтнесенияРасходов = глПолучитьСчетРасходовДляЦелейНалоговогоУчета(ОсновноеСредство.ВидРасхода.Получить(ДатаДок), ОсновноеСредство.ЭлементРасхода.Получить(ДатаДок), ОсновноеСредство.Объект.Получить(ДатаДок), ДатаДок);
		СчетРасходов = СчетИАналитикаДляОтнесенияРасходов.Получить("Счет");
		Если ПустоеЗначение(СчетРасходов) = 1 Тогда
			ТекстСообщения = "На закладке ""Налоговый учет"" неверно указано направление отнесения расходов по начисленной амортизации для объекта: "
				+ ОсновноеСредство.Наименование + ", инв.№" + ОсновноеСредство.Код + ".";
			глНеПроводить(Контекст, ТекстСообщения, ОсновноеСредство.ТекущийЭлемент());
			Возврат;
		КонецЕсли;
		СчетРасходов = глПолучитьСчетУчетаКосвенныхРасходовНУ(ДатаДок, ОсновноеСредство.СчетЗатрат.Получить(ДатаДок), ОсновноеСредство.Субконто1.Получить(ДатаДок), СчетРасходов);
		
	    Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
		Операция.НомерЖурнала = "НУ";
		Операция.СодержаниеПроводки = "Аморт.за "+Формат(ДатаДок,"Д ММММГГГГ");
		Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
		Если ПустоеЗначение(СчетРасходов) = 0 Тогда
		    Операция.Дебет.Счет = СчетРасходов;
			Операция.Дебет.Субконто(1, СчетИАналитикаДляОтнесенияРасходов.Получить("Субконто1"));
			Операция.Дебет.Субконто(2, СчетИАналитикаДляОтнесенияРасходов.Получить("Субконто2"));
			Операция.Дебет.Субконто(3, СчетИАналитикаДляОтнесенияРасходов.Получить("Субконто3"));
		КонецЕсли;
		Операция.Кредит.Счет = СчетПоКоду("Н05.02");
		Операция.Кредит.Субконто(1, ОсновноеСредство);
		Операция.Сумма = РассчитаннаяАмортизация;
	КонецЕсли;     
	
	Если КапВложенияНаправленныеНаРасходы <> 0 Тогда
		
		ВариантУчетаРасходовПоАмортизационнойПремии = Константа.ВариантУчетаРасходовПоАмортизационнойПремии.Получить(ДатаДок);
		Если ВариантУчетаРасходовПоАмортизационнойПремии = Перечисление.ВариантыУчетаРасходовПоАмортизационнойПремии.ВСоставеКосвенныхРасходов Тогда
			СчетИАналитикаДляОтнесенияРасходов = глПолучитьСчетРасходовДляЦелейНалоговогоУчета(Перечисление.ВидыРасходов.КосвенныеРасходы, Перечисление.ГруппыВидыРасходов.АмортизационнаяПремия, "");
			СчетРасходов = СчетИАналитикаДляОтнесенияРасходов.Получить("Счет");
		Иначе
			СчетИАналитикаДляОтнесенияРасходов = глПолучитьСчетРасходовДляЦелейНалоговогоУчета(ОсновноеСредство.ВидРасхода.Получить(ДатаДок), ОсновноеСредство.ЭлементРасхода.Получить(ДатаДок), ОсновноеСредство.Объект.Получить(ДатаДок), ДатаДок);
			СчетРасходов = СчетИАналитикаДляОтнесенияРасходов.Получить("Счет");
		КонецЕсли; 
		
		СчетРасходов = глПолучитьСчетУчетаКосвенныхРасходовНУ(ДатаДок, ОсновноеСредство.СчетЗатрат.Получить(ДатаДок), ОсновноеСредство.Субконто1.Получить(ДатаДок), СчетРасходов);

		Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
		Операция.НомерЖурнала = "ОС";
		Операция.СодержаниеПроводки = "Включение кап.вложений в расходы";
		Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
		Если ПустоеЗначение(СчетРасходов) = 0 Тогда
			Операция.Дебет.Счет = СчетРасходов;
			Операция.Дебет.Субконто(1, СчетИАналитикаДляОтнесенияРасходов.Получить("Субконто1"));
			Операция.Дебет.Субконто(2, СчетИАналитикаДляОтнесенияРасходов.Получить("Субконто2"));
			Операция.Дебет.Субконто(3, СчетИАналитикаДляОтнесенияРасходов.Получить("Субконто3"));
		КонецЕсли;
		Операция.Кредит.Счет = СчетПоКоду("Н05.01");
		Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
		Операция.Кредит.УсловияПоступленияИВыбытия = Перечисление.УсловияПоступленияИВыбытия.Другие;
		Операция.Сумма = КапВложенияНаправленныеНаРасходы; 
		
		Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
		Операция.НомерЖурнала = "ОС";
		Операция.СодержаниеПроводки = "Включение кап.вложений в расходы";
		Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
		Операция.Кредит.Счет = СчетПоКоду("Н05.КВ");
		Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
		Операция.Сумма = КапВложенияНаправленныеНаРасходы;		
	КонецЕсли;		                                      
	
	КапВложенияНаправленныеНаРасходыОстаток = СведенияОбОбъекте.Получить("КапВложенияНаправленныеНаРасходыОстаток") - КапВложенияНаправленныеНаРасходы;
	Если КапВложенияНаправленныеНаРасходыОстаток <> 0 Тогда
		Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
		Операция.НомерЖурнала = "ОС";
		Операция.СодержаниеПроводки = "Списание суммы кап.вложений";
		Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
		Операция.Дебет.Счет = СчетПоКоду("Н05.КВ");
		Операция.Дебет.ОсновныеСредства = ОсновноеСредство;
		Операция.Сумма = -КапВложенияНаправленныеНаРасходыОстаток;
		СведенияОбОбъекте.Установить("КапВложенияНаправленныеНаРасходыОстаток",0); 		
	КонецЕсли;
	
КонецПроцедуры // ДоначислениеАмортизацииДляЦелейНалоговогоУчета()

//******************************************************************************
Процедура ОбработкаПроведения()

	Сч01_1 = СчетПоКоду("01.1");
	Сч01_2 = СчетПоКоду("01.2");
	    
	БухИтНПР = СоздатьОбъект("БухгалтерскиеИтоги"); БухИтНПР.ИспользоватьРазделительУчета(ЮрЛицо);
	БухИтНПР.ПериодМ(ДатаДок);
	
	ВыбратьСтроки();
	Пока ПолучитьСтроку() = 1 Цикл
		СведенияОбОС = глРасчетАмортизацииОС(ОсновноеСредство, ДатаДок); 
		СведенияОбОС.Установить("КапВложенияНаправленныеНаРасходыОстаток",БухИтНПР.СКД("Н05.КВ",,, ОсновноеСредство)); 
		НачисленнаяАмортизацияНач = СведенияОбОС.Получить("НачисленнаяАмортизацияКон");
		СчетНачисленияАмортизации = СведенияОбОС.Получить("СчетНачисленияАмортизации");
		
		ДоначисленнаяАмортизация = НачисленнаяАмортизация - НачисленнаяАмортизацияНач;
		Если (ДоначисленнаяАмортизация <> 0) и (ПустоеЗначение(СчетНачисленияАмортизации) = 0) Тогда
			Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
			Операция.НомерЖурнала = "ОС";
			Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
			Операция.Сумма = ДоначисленнаяАмортизация;
			
			Если СчетНачисленияАмортизации.Забалансовый = 1 Тогда
				Операция.СодержаниеПроводки = "Износ за "+Формат(ДатаДок,"Д ММММГГГГ");
				Операция.Дебет.Счет = СчетНачисленияАмортизации;
				Операция.Дебет.ОсновныеСредства = ОсновноеСредство;
				
			Иначе
				Если ОсновноеСредство.СчетЗатрат.Получить(ДатаДок).Выбран() = 0 Тогда
					ТекстСообщения = "Не указан счет отнесения затрат по начисленной амортизации для ОС: "+ОсновноеСредство.Наименование+", инв.№"+ОсновноеСредство.Код+".";
					глНеПроводить(Контекст, ТекстСообщения, ОсновноеСредство.ТекущийЭлемент());
					Возврат;
				КонецЕсли;
				Операция.СодержаниеПроводки = "Аморт.за "+Формат(ДатаДок,"Д ММММГГГГ");
				
				Операция.Дебет.Счет = ОсновноеСредство.СчетЗатрат.Получить(ДатаДок);
				Операция.Дебет.Субконто(1, ОсновноеСредство.Субконто1.Получить(ДатаДок));
				Операция.Дебет.Субконто(2, ОсновноеСредство.Субконто2.Получить(ДатаДок));
				Операция.Дебет.Субконто(3, ОсновноеСредство.Субконто3.Получить(ДатаДок));
				Операция.Кредит.Счет = СчетНачисленияАмортизации;
				Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
			КонецЕсли;
			
			// Списание постоянных разниц
			Если СчетНачисленияАмортизации.Забалансовый <> 1 Тогда
				Если Константа.ПрименяетсяПБУ18.Получить(ДатаДок) = Да Тогда
					ВсегоПостоянныхРазниц = БухИтНПР.СНД("НПР.01",,, ОсновноеСредство);
					Если ВсегоПостоянныхРазниц <> 0 Тогда
	                    БалансоваяСтоимостьНач		= СведенияОбОС.Получить("БалансоваяСтоимостьНач");
						НачисленнаяАмортизацияНач   = СведенияОбОС.Получить("НачисленнаяАмортизацияНач");
						ОстаточнаяСтоимостьНаНачало = БалансоваяСтоимостьНач - НачисленнаяАмортизацияНач;
					    СписатьПостоянныхРазниц = ВсегоПостоянныхРазниц * (ДоначисленнаяАмортизация / ОстаточнаяСтоимостьНаНачало);
						Если СписатьПостоянныхРазниц <> 0 Тогда
							СчетДт = ОсновноеСредство.СчетЗатрат.Получить(ДатаДок);
							СчетНПР = глПолучитьСчетДебетаНПР(СчетДт, ОсновноеСредство.Субконто1.Получить(ДатаДок));
							
							Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
							Операция.НомерЖурнала = "ПР";
							Операция.СодержаниеПроводки = "Списание постоянных разниц";
							Если ПустоеЗначение(СчетНПР) = 0 Тогда
								Операция.Дебет.Счет = СчетНПР;
								Операция.Дебет.Субконто(1, ОсновноеСредство.Субконто1.Получить(ДатаДок));
								Операция.Дебет.Субконто(2, ОсновноеСредство.Субконто2.Получить(ДатаДок));
								Операция.Дебет.Субконто(3, ОсновноеСредство.Субконто3.Получить(ДатаДок));
							КонецЕсли;
							Операция.Кредит.Счет = СчетПоКоду("НПР.01");
							Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
							Операция.Сумма = СписатьПостоянныхРазниц;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Доначислим амортизацию для целей налогового учета.
		Если глНовыеПравилаВеденияНУ(ДатаДок) = 1 Тогда
			ДоначислениеАмортизацииДляЦелейНалоговогоУчета(СведенияОбОС);
		КонецЕсли;
		
		Если (НачисленнаяАмортизация <> 0) и (ПустоеЗначение(СчетНачисленияАмортизации) = 0) Тогда
			Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
			Операция.НомерЖурнала = "ОС";
			Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
			Операция.Сумма = НачисленнаяАмортизация;
			
			Если СчетНачисленияАмортизации.Забалансовый = 1 Тогда
				Операция.СодержаниеПроводки = "Списан износ";
				Операция.Кредит.Счет = СчетНачисленияАмортизации;
				Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
				
			Иначе
				Операция.СодержаниеПроводки = "Списана амортизация";
				Операция.Кредит.Счет = Сч01_2;
				Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
				Операция.Дебет.Счет = СчетНачисленияАмортизации;
				Операция.Дебет.ОсновныеСредства = ОсновноеСредство;
			КонецЕсли;
		КонецЕсли;
		
		Если БалансоваяСтоимость <> 0 Тогда
			Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
			Операция.НомерЖурнала = "ОС";
			Операция.СодержаниеПроводки = "Списана баланс.ст-ть";
			Операция.ПервичныйДокумент  = глПредставлениеПервичногоДокумента(Контекст);
			Операция.Сумма = БалансоваяСтоимость;
			Операция.Кредит.Счет = Сч01_1;
			Операция.Кредит.ОсновныеСредства = ОсновноеСредство;
			Операция.Дебет.Счет = Сч01_2;
			Операция.Дебет.ОсновныеСредства = ОсновноеСредство;
		КонецЕсли; 
		
		// Амортизация больше не должна начисляться (как в налоговом учете, так и в бухгалтерском).
		УстановитьРеквизитСправочника(ОсновноеСредство, "НачислятьАмортизацию", 0, ДатаДок);
	КонецЦикла;
		
	Операция.Записать();
	
	ТекстСообщения = "Документ проведен.";
	глСообщениеПроведения(ТекстСообщения, ТекущийДокумент(), 0);
	глПриПроведении(Контекст);
	
КонецПроцедуры
//_____________________________________________________________________________