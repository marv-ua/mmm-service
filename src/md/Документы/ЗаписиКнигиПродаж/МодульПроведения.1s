// ********************
//
Процедура ОбработкаПроведения()
	
	Учтены = СоздатьОбъект("ТаблицаЗначений");
	Учтены.НоваяКолонка("СФ","Документ");
	Учтены.НоваяКолонка("Сумма","Число","15","2");
	
	Сч76_Н1 = СчетПоКоду("76.Н.1");
	Сч68_2  = СчетПоКоду("68.2");
	
	ВыбратьСтроки();
	Пока ПолучитьСтроку()=1 Цикл
		//Если Авто=0 Тогда
		//	Продолжить;
		//КонецЕсли;  
		Если (ЗаписьДопЛиста = 1) и (ПустоеЗначение(ДатаДопЛиста) = 1) Тогда
			ТекстСообщения = "В строке №" + НомерСтроки + " не указана дата записи дополнительного листа книги продаж.";
			глНеПроводить(Контекст, ТекстСообщения);
			Возврат;
		КонецЕсли;
        
		Если ((ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ВозвратОплаченного) или (ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ВозвратНеОплаченного))
		и (СчетФактура.Вид() <> "СчетФактура") Тогда
			ТекстСообщения = "Тип записи """ + ТипЗаписи + """ следует указывать только для документов ""Счет-фактура выданный"".";
			глНеПроводить(Контекст, ТекстСообщения);
			Возврат;
		КонецЕсли;

		СуммаНДС = НДС10 + НДС20;
		БухИт = СоздатьОбъект("БухгалтерскиеИтоги"); БухИт.ИспользоватьРазделительУчета(ЮрЛицо);
		Если СуммаНДС = 0 Тогда
		Иначе
			Если ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ВозвратОплаченного Тогда 
				ТаблицаДокумента = СоздатьОбъект("ТаблицаЗначений");
				Оплата.ВыгрузитьТабличнуюЧасть(ТаблицаДокумента, "Товар,Количество,НДС,НП,Всего");
				ТаблицаДокумента.НоваяКолонка("ВидНоменклатуры");
				ТаблицаДокумента.НоваяКолонка("СтавкаНДС");
				ТаблицаДокумента.НоваяКолонка("СтавкаНП");
				Оплата.ВыбратьСтроки();
				Пока Оплата.ПолучитьСтроку() = 1 Цикл
					ТаблицаДокумента.ПолучитьСтрокуПоНомеру(Оплата.НомерСтроки);
					ТаблицаДокумента.ВидНоменклатуры = ТаблицаДокумента.Товар.ВидНоменклатуры;
					ТаблицаДокумента.СтавкаНДС = глСтавкаНалога(Оплата, "НДС");
					ТаблицаДокумента.СтавкаНП = глСтавкаНалога(Оплата, "НП");
				КонецЦикла;
				ДокВсего = ?(Оплата.Курс>0, Оплата.Итог("Всего")*Оплата.Курс, Оплата.Итог("Всего"));
				К = Всего/ДокВсего;
				
				ТаблицаДокумента.Свернуть("ВидНоменклатуры,СтавкаНДС","НДС,Всего");
				ТаблицаДокумента.ВыбратьСтроки();
				
				Пока ТаблицаДокумента.ПолучитьСтроку()=1 Цикл
					Если ТаблицаДокумента.НДС>0 Тогда
						Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
						Операция.СодержаниеПроводки = "Сторно НДС при возврате от покупателя";
						Операция.НомерЖурнала = "ФР";
						Операция.Кредит.Счет = Сч68_2;
						Операция.Кредит.ВидыПлатежейВБюджет = Перечисление.ВидыПлатежейВБюджет.Налог;
						Операция.Дебет.Счет = СчетПоКоду("90.3");
						Операция.Дебет.Субконто(1,ТаблицаДокумента.ВидНоменклатуры);
						Операция.Дебет.Субконто(2,ТаблицаДокумента.СтавкаНДС );
						Операция.Сумма = (?(Оплата.Курс>0, ТаблицаДокумента.НДС*Оплата.Курс, ТаблицаДокумента.НДС))*К;
					КонецЕсли;
				КонецЦикла;
				
			ИначеЕсли ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ВозвратНеОплаченного Тогда
				ТаблицаДокумента = СоздатьОбъект("ТаблицаЗначений");
				Оплата.ВыгрузитьТабличнуюЧасть(ТаблицаДокумента, "Товар,Количество,НДС,НП,Всего");
				ТаблицаДокумента.НоваяКолонка("ВидНоменклатуры");
				ТаблицаДокумента.НоваяКолонка("СтавкаНДС");
				ТаблицаДокумента.НоваяКолонка("СтавкаНП");
				Оплата.ВыбратьСтроки();
				Пока Оплата.ПолучитьСтроку() = 1 Цикл
					ТаблицаДокумента.ПолучитьСтрокуПоНомеру(Оплата.НомерСтроки);
					ТаблицаДокумента.ВидНоменклатуры = ТаблицаДокумента.Товар.ВидНоменклатуры;
					ТаблицаДокумента.СтавкаНДС = глСтавкаНалога(Оплата, "НДС");
					ТаблицаДокумента.СтавкаНП = глСтавкаНалога(Оплата, "НП");
				КонецЦикла;
				ДокВсего = ?(Оплата.Курс>0, Оплата.Итог("Всего")*Оплата.Курс, Оплата.Итог("Всего"));
				К = Всего/ДокВсего;
				
				ТаблицаДокумента.Свернуть("ВидНоменклатуры,СтавкаНДС","НДС,Всего");
				ТаблицаДокумента.ВыбратьСтроки(); 
				Пока ТаблицаДокумента.ПолучитьСтроку()=1 Цикл
					Если ТаблицаДокумента.НДС>0 Тогда
						Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
						Операция.СодержаниеПроводки = "Сторно НДС при возврате от покупателя";
						Операция.НомерЖурнала = "ФР";
						Операция.Дебет.Счет = СчетПоКоду("90.3");
						Операция.Дебет.Субконто(1,ТаблицаДокумента.ВидНоменклатуры);
						Операция.Дебет.Субконто(2,ТаблицаДокумента.СтавкаНДС);
						Операция.Кредит.Счет = Сч76_Н1;
						Операция.Кредит.Субконто(1, Контрагент);
						Операция.Кредит.Субконто(2, СчетФактура);
						Операция.Сумма = (?(Оплата.Курс>0, ТаблицаДокумента.НДС*Оплата.Курс, ТаблицаДокумента.НДС))*К; 
					КонецЕсли;
				КонецЦикла;
				Продолжить;
				
			ИначеЕсли ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ВозвратОплаченногоПК Тогда 
				Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
				Операция.СодержаниеПроводки = "Восстановлен НДС с возврата товара";
				Операция.НомерЖурнала = "ФР";
				Операция.Кредит.Счет = Сч68_2;
				Операция.Кредит.ВидыПлатежейВБюджет = Перечисление.ВидыПлатежейВБюджет.Налог;
				Операция.Дебет.Счет = СчетПоКоду("19.3");
				Операция.Дебет.Субконто(1, Контрагент);
				Если (СчетФактура.Вид()="СчетФактураПолученный") или (СчетФактура.Вид()="СчетФактура") Тогда
					Операция.Дебет.Субконто(2, СчетФактура);                        
				ИначеЕсли ПустоеЗначение(СчетФактура.ДатаНомерСчетаФактуры) = 0 Тогда
					Операция.Дебет.Субконто(2, СчетФактура);
				КонецЕсли;
				Операция.Сумма = СуммаНДС; 
			ИначеЕсли ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ВозвратНеОплаченногоПК Тогда
				Продолжить;
			ИначеЕсли ТипЗаписи = Перечисление.ТипыЗаписейКнигиПродаж.ЗачетАванса Тогда 
				Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
				Операция.СодержаниеПроводки = "Восстановлен НДС с аванса";
				Операция.НомерЖурнала = "ФР";
				Операция.Кредит.Счет = Сч68_2;
				Операция.Кредит.ВидыПлатежейВБюджет = Перечисление.ВидыПлатежейВБюджет.Налог;
				Операция.Дебет.Счет = СчетПоКоду("76.ВА");
				Операция.Дебет.Субконто(1, Контрагент);
				Если (СчетФактура.Вид()="СчетФактураПолученный") или (СчетФактура.Вид()="СчетФактура") Тогда
					Операция.Дебет.Субконто(2, СчетФактура);                        
				ИначеЕсли ПустоеЗначение(СчетФактура.ДатаНомерСчетаФактуры) = 0 Тогда
					Операция.Дебет.Субконто(2, СчетФактура);
				КонецЕсли;
				Операция.Сумма = СуммаНДС; 
			ИначеЕсли СчетФактура.СчетНДС = 2 Тогда
				НС=0;
				Если Учтены.НайтиЗначение(СчетФактура,НС,1)=1 Тогда
				    УчтеноРанее = Учтены.ПолучитьЗначение(НС,2);
				Иначе
					УчтеноРанее = 0;
				КонецЕсли;
					
				Если СчетФактура.ДатаДок < '01.01.2006' Тогда
					БухИт.ИспользоватьСубконто(ВидыСубконто.Контрагенты, Контрагент, 2);
					БухИт.ИспользоватьСубконто(ВидыСубконто.СчетаФактурыВыданные, СчетФактура, 2);
					БухИт.ВыполнитьЗапрос(НачМесяца(ДатаДок), ТекущийДокумент(), Сч76_Н1);
					Если (БухИт.СКК()-УчтеноРанее) < СуммаНДС Тогда
						ТекстСообщения = "По строке документа"+ НомерСтроки +" Сумма НДС ( "+
						СокрЛП(Формат(СуммаНДС,"Ч15.2"))+" руб.) превышает сальдо по кредиту счета "+Сч76_Н1+" ( "+
						СокрЛП(Формат((БухИт.СКК()-УчтеноРанее),"Ч15.2"))+" руб.)";;;
						глНеПроводить(Контекст, ТекстСообщения);
						Возврат;
					КонецЕсли;
				КонецЕсли;
				
				Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
				Операция.СодержаниеПроводки = "Начислен НДС";
				Операция.НомерЖурнала = "ФР";
				Операция.Кредит.Счет = Сч68_2;
				Операция.Кредит.ВидыПлатежейВБюджет = Перечисление.ВидыПлатежейВБюджет.Налог;
				Операция.Дебет.Счет = Сч76_Н1;
				Операция.Дебет.Субконто(1, Контрагент);
				Операция.Дебет.Субконто(2, СчетФактура);
				Операция.Сумма = СуммаНДС;
				
				Если НС>0 Тогда
					Учтены.УстановитьЗначение(НС,2,УчтеноРанее+СуммаНДС);
				Иначе
					Учтены.НоваяСтрока();
					Учтены.СФ = СчетФактура;
					Учтены.Сумма = СуммаНДС; 
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		Если ТипЗаписи <> Перечисление.ТипыЗаписейКнигиПродаж.ЗачетАванса Тогда
			
			Если (ТипЗаписи <> Перечисление.ТипыЗаписейКнигиПродаж.ВозвратОплаченногоПК) 
			и (ТипЗаписи <> Перечисление.ТипыЗаписейКнигиПродаж.ВозвратНеОплаченногоПК) Тогда 
				
				Если БезНДС20<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Дебет.Счет = СчетПоКоду("ЗПР.20.Б");
					Операция.Дебет.Субконто(1,СчетФактура.Контрагент);
					Операция.Дебет.Субконто(2,СчетФактура.Договор);
					Операция.Дебет.Субконто(3,СчетФактура);
					Операция.Сумма = БезНДС20;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если НДС20<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Дебет.Счет = СчетПоКоду("ЗПР.20.Н");
					Операция.Дебет.Субконто(1,СчетФактура.Контрагент);
					Операция.Дебет.Субконто(2,СчетФактура.Договор);
					Операция.Дебет.Субконто(3,СчетФактура);
					Операция.Сумма = НДС20;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если БезНДС10<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Дебет.Счет = СчетПоКоду("ЗПР.10.Б");
					Операция.Дебет.Субконто(1,СчетФактура.Контрагент);
					Операция.Дебет.Субконто(2,СчетФактура.Договор);
					Операция.Дебет.Субконто(3,СчетФактура);
					Операция.Сумма = БезНДС10;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если НДС10<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Дебет.Счет = СчетПоКоду("ЗПР.10.Н");
					Операция.Дебет.Субконто(1,СчетФактура.Контрагент);
					Операция.Дебет.Субконто(2,СчетФактура.Договор);
					Операция.Дебет.Субконто(3,СчетФактура);
					Операция.Сумма = НДС10;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если НДС0<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Дебет.Счет = СчетПоКоду("ЗПР.0");
					Операция.Дебет.Субконто(1,СчетФактура.Контрагент);
					Операция.Дебет.Субконто(2,СчетФактура.Договор);
					Операция.Дебет.Субконто(3,СчетФактура);
					Операция.Сумма = НДС0;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если Освобождаемые<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Дебет.Счет = СчетПоКоду("ЗПР.БН");
					Операция.Дебет.Субконто(1,СчетФактура.Контрагент);
					Операция.Дебет.Субконто(2,СчетФактура.Договор);
					Операция.Дебет.Субконто(3,СчетФактура);
					Операция.Сумма = Освобождаемые;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
			Иначе
				Если БезНДС20<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Кредит.Счет = СчетПоКоду("ЗПК.20.Б");
					Операция.Кредит.Субконто(1,СчетФактура.Контрагент);
					Операция.Кредит.Субконто(2,СчетФактура.Договор);
					Операция.Кредит.Субконто(3,СчетФактура);
					Операция.Сумма = БезНДС20;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если НДС20<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Кредит.Счет = СчетПоКоду("ЗПК.20.Н");
					Операция.Кредит.Субконто(1,СчетФактура.Контрагент);
					Операция.Кредит.Субконто(2,СчетФактура.Договор);
					Операция.Кредит.Субконто(3,СчетФактура);
					Операция.Сумма = НДС20;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если БезНДС10<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Кредит.Счет = СчетПоКоду("ЗПК.10.Б");
					Операция.Кредит.Субконто(1,СчетФактура.Контрагент);
					Операция.Кредит.Субконто(2,СчетФактура.Договор);
					Операция.Кредит.Субконто(3,СчетФактура);
					Операция.Сумма = БезНДС10;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если НДС10<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Кредит.Счет = СчетПоКоду("ЗПК.10.Н");
					Операция.Кредит.Субконто(1,СчетФактура.Контрагент);
					Операция.Кредит.Субконто(2,СчетФактура.Договор);
					Операция.Кредит.Субконто(3,СчетФактура);
					Операция.Сумма = НДС10;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если НДС0<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Кредит.Счет = СчетПоКоду("ЗПК.0");
					Операция.Кредит.Субконто(1,СчетФактура.Контрагент);
					Операция.Кредит.Субконто(2,СчетФактура.Договор);
					Операция.Кредит.Субконто(3,СчетФактура);
					Операция.Сумма = НДС0;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
				Если Освобождаемые<>0 Тогда
					Операция.НоваяПроводка(); Операция.РазделительУчета = ЮрЛицо;
					Операция.НомерЖурнала = "АВ";
					Операция.Кредит.Счет = СчетПоКоду("ЗПК.БН");
					Операция.Кредит.Субконто(1,СчетФактура.Контрагент);
					Операция.Кредит.Субконто(2,СчетФактура.Договор);
					Операция.Кредит.Субконто(3,СчетФактура);
					Операция.Сумма = Освобождаемые;
					Операция.СодержаниеПроводки = "Данные для автоматического учета НДС";
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	Операция.Записать();
	
	ТекстСообщения = "Документ проведен.";
	глСообщениеПроведения(ТекстСообщения, ТекущийДокумент(), 0);
	глПриПроведении(Контекст);
КонецПроцедуры
