Перем МаксимальнокКоличествоТерминалов;	

Процедура КвоТерминалоПриИзменении()
	Если КвоТерминалов > 5 Тогда
		КвоТерминалов = 5;
	КонецЕсли;	    
	
	Форма.Терминал1.Видимость(0);
	Форма.Терминал2.Видимость(0);
	Форма.Терминал3.Видимость(0);
	Форма.Терминал4.Видимость(0);
	Форма.Терминал5.Видимость(0); 
	
	Для Сч = 1 По КвоТерминалов Цикл  
		Если Сч = 1 Тогда
			Форма.Терминал1.Видимость(1); 
		ИначеЕсли Сч = 2 Тогда
			Форма.Терминал2.Видимость(1);	   
		ИначеЕсли Сч = 3 Тогда
			Форма.Терминал3.Видимость(1);
		ИначеЕсли Сч = 4 Тогда
			Форма.Терминал4.Видимость(1);
		ИначеЕсли Сч = 5 Тогда
			Форма.Терминал5.Видимость(1);
		КонецЕсли;	
	КонецЦикла;
	
КонецПроцедуры 

Процедура Загрузить()
	КрайняяКолонка = 0;
	ПерваяСтрока = 5;
	ПерваяКолонка = 2;
	КоличествоСтрок = 50;
	КоличествоКолонок = 10;
	//
	КолонкаДата = 0;
	КолонкаВыручка = 0;
	КолонкаСкидка = 0;
	КолонкаТерминал1 = 0;
	КолонкаТерминал2 = 0;
	КолонкаТерминал3 = 0;
	КолонкаТерминал4 = 0;
	КолонкаТерминал5 = 0;
	//
	ИмяФайла = "";	

	Результат = Вопрос("При загрузке табличная часть будет очищена.
	|Загрузить с листа №"+нЛист+"?", 4);
	
	Если Результат = 6 Тогда   
		ИмяПути = КаталогИБ()+"ProgFile\";
		Если ФС.ВыбратьФайл(0, ИмяФайла, ИмяПути, "Выберите файл для загрузки", "Файлы Excel (*.xls)|*.xls", ,) = 1 Тогда
			//Сообщить(ИмяПути + ИмяФайла);
			Попытка
				Эксель = СоздатьОбъект("Excel.Application");   
				Эксель.DisplayAlerts = 0;
				Эксель.Visible = 0;				
			Исключение
				Сообщить(ОписаниеОшибки() + " Программа Exсel не установлена на данном компьютере!");  
				Возврат;
			КонецПопытки;
			
			Книга = Эксель.WorkBooks.Open(ИмяПути + ИмяФайла); 
			Если Книга.Sheets.Count < нЛист Тогда
				Сообщить("Неверно указан номер листа");
				Возврат;
			КонецЕсли;
			
			Лист = Книга.WorkSheets(нЛист); 
			КоличествоСтрок = Лист.Cells.SpecialCells(11).Row;
			
			// определить количество терминалов  
			Для Стр	= ПерваяСтрока По КоличествоСтрок Цикл      
				Значение = Лист.Cells(Стр, ПерваяКолонка).Value; 
				
				Если СокрЛП(Значение) = "" Тогда
					Продолжить;
				КонецЕсли;	
				
				// заголовок в комментарий
				Если (Найти(НРег(Значение), "реализ") > 0) И (Стр < 9) Тогда
					Комментарий = СокрЛП(Значение);
					Продолжить;
				КонецЕсли;
				   
				// определение колонок  
				НомерТерминала = 1;
				Если Найти(НРег(Значение), "дата") > 0 Тогда     
					КолонкаДата = ПерваяКолонка;  
					ПерваяСтрока = Стр + 1;
					Для Стб = (ПерваяКолонка + 1) По КоличествоКолонок Цикл 
						Значение = Лист.Cells(Стр, Стб).Value;
						ЗначениеВыше = Лист.Cells(Стр-1, Стб).Value;  
						 
						Если (Найти(НРег(Значение), "выручка") > 0) ИЛИ (Найти(НРег(ЗначениеВыше), "выручка") > 0) Тогда
							КолонкаВыручка = Стб;
						ИначеЕсли (Найти(НРег(Значение), "скидк") > 0) ИЛИ (Найти(НРег(ЗначениеВыше), "скидк") > 0) Тогда
						    КолонкаСкидка = Стб;
						ИначеЕсли (Найти(НРег(Значение), "реализ") > 0) ИЛИ (Найти(НРег(ЗначениеВыше), "реализ") > 0) Тогда		
							КрайняяКолонка = Стб;
							Прервать;
						ИначеЕсли (Найти(НРег(Значение), "термин") > 0) ИЛИ (Найти(НРег(ЗначениеВыше), "термин") > 0) Тогда
							Если НомерТерминала = 1 Тогда
								КолонкаТерминал1 = Стб;
							ИначеЕсли НомерТерминала = 2 Тогда
								КолонкаТерминал2 = Стб;	
							ИначеЕсли НомерТерминала = 3 Тогда
								КолонкаТерминал3 = Стб;
							ИначеЕсли НомерТерминала = 4 Тогда
								КолонкаТерминал4 = Стб;
							ИначеЕсли НомерТерминала = 5 Тогда
								КолонкаТерминал5 = Стб;
							КонецЕсли;
							НомерТерминала = НомерТерминала + 1;
						КонецЕсли;
							
					КонецЦикла;	
					КвоТерминалов = НомерТерминала - 1;  
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			УдалитьСтроки();  

			Для Стр = ПерваяСтрока По КоличествоСтрок Цикл 
				ИтогоПоСтроке = 0;
				Значение = Лист.Cells(Стр, ПерваяКолонка).Value; 
				
				Если СокрЛП(Значение) = "" Тогда
					Продолжить;
				ИначеЕсли Найти(НРег(Значение), "итог") > 0 Тогда
					Прервать;
				КонецЕсли;	 
				       
				НоваяСтрока();
				Если КолонкаДата > 0 Тогда 
					ТекЗначение = СокрЛП(Лист.Cells(Стр, КолонкаДата).Value);  
					ДатаСтроки = Дата(ТекЗначение);
				КонецЕсли;	
				Если КолонкаСкидка > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаСкидка).Value;
					Скидка = Число(ТекЗначение);
					ИтогоПоСтроке = ИтогоПоСтроке + Скидка;
				КонецЕсли;
				Если КолонкаТерминал1 > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаТерминал1).Value;
					Терминал1 = Число(ТекЗначение);  
					ИтогоПоСтроке = ИтогоПоСтроке + Терминал1;
				КонецЕсли;
				Если КолонкаТерминал2 > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаТерминал2).Value;
					Терминал2 = Число(ТекЗначение);  
					ИтогоПоСтроке = ИтогоПоСтроке + Терминал2;
				КонецЕсли;
				Если КолонкаТерминал3 > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаТерминал3).Value;
					Терминал3 = Число(ТекЗначение);  
					ИтогоПоСтроке = ИтогоПоСтроке + Терминал3;
				КонецЕсли;
				Если КолонкаТерминал4 > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаТерминал4).Value;
					Терминал4 = Число(ТекЗначение);  
					ИтогоПоСтроке = ИтогоПоСтроке + Терминал4;
				КонецЕсли;
				Если КолонкаТерминал5 > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаТерминал5).Value;
					Терминал5 = Число(ТекЗначение);  
					ИтогоПоСтроке = ИтогоПоСтроке + Терминал5;
				КонецЕсли; 
				Если КолонкаВыручка > 0 Тогда
					ТекЗначение = Лист.Cells(Стр, КолонкаВыручка).Value;
					Выручка = Число(ТекЗначение);  
					ИтогоПоСтроке = ИтогоПоСтроке + Выручка;
				КонецЕсли;				

				Реализация = ИтогоПоСтроке; 				
				
			КонецЦикла;	
			         
			КвоТерминалоПриИзменении();
			Эксель.Workbooks.Close();
		//	Эксель.Application.Quit();		
		КонецЕсли
	КонецЕсли;	
КонецПроцедуры

Процедура СтрокаПриИзменении()
	
	Реализация = Выручка + Скидка + Терминал1 + Терминал2 + Терминал3 + Терминал4 + Терминал5;
	
КонецПроцедуры	

Функция МагазинК21()  
	
	спр = СоздатьОбъект("Справочник.Магазины");
	Если спр.НайтиПоНаименованию("К21") = 0 Тогда
	 	спр.Новый();
	 	спр.Наименование = "К21";
	 	спр.Записать();
	КонецЕсли;
	
	Возврат спр.ТекущийЭлемент();
	
КонецФункции	  

Функция МагазинХ14()
	
	спр = СоздатьОбъект("Справочник.Магазины");
	Если спр.НайтиПоНаименованию("Х14") = 0 Тогда
	 	спр.Новый();
	 	спр.Наименование = "Х14";
	 	спр.Записать();
	КонецЕсли;
	
	Возврат спр.ТекущийЭлемент();
	
КонецФункции

Процедура МагазинПриИзменении()  
	Если выбМагазин = 1 Тогда
		Магазин = МагазинК21();
	ИначеЕсли выбМагазин = 2 Тогда
		Магазин = МагазинХ14();
	КонецЕсли;	
		
КонецПроцедуры	

Процедура ПриОткрытии()
	ПриЗаписиПерепроводить(1);
	КвоТерминалоПриИзменении();
	Если нЛист = 0 Тогда нЛист = 1; КонецЕсли; 
	
	Если Магазин = МагазинК21() Тогда 
		выбМагазин = 1; 
	ИначеЕсли Магазин = МагазинХ14() Тогда
		выбМагазин = 2;
	Иначе
		выбМагазин = 1;
	КонецЕсли;
	МагазинПриИзменении();  
	      
	спрЮрЛицо = СоздатьОбъект("Справочник.СвоиЮрЛица"); 
	спрЮрЛицо.НайтиПоКоду("00001");
	ЮрЛицо = спрЮрЛицо.ТекущийЭлемент(); 
	
КонецПроцедуры   

Функция ИтоговаяСтрока()
      
	Возврат "Выручка: " + Итог("Выручка") + ", Скидка: " + Итог("Скидка") + ", Реал.: " + Итог("Реализация");	
	
КонецФункции	

МаксимальнокКоличествоТерминалов = 5;