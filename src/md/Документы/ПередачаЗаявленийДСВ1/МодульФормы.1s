ѕерем конст–азмерѕачки;
ѕерем —писокЌередактируемых онтролов;

//******************************************************************************
//	ѕри¬ыборе—отрудника()
//
//	ѕараметры:
// 
//	ќписание:
//		«аполн€ет пол€ документа данными из выбранного сотрудника.
//
ѕроцедура ѕри¬ыборе—отрудника()  
	
	≈сли ѕустое«начение(—тр«аменить(—отрудник.—траховойЌомерѕ‘–, "-", "")) = 0 “огда 
		—траховойЌомерѕ‘– = —отрудник.—траховойЌомерѕ‘–;
	 онец≈сли; 
	
	‘»ќ = гл–азложить(—ќ –Ћѕ(—отрудник.Ќаименование)," ");
	
	≈сли ‘»ќ.–азмер—писка() > 0 “огда
		‘амили€ = ‘»ќ.ѕолучить«начение(1);
		≈сли ‘»ќ.–азмер—писка() > 1 “огда
			»м€		= ‘»ќ.ѕолучить«начение(2);
			≈сли ‘»ќ.–азмер—писка() > 2 “огда 
				// а вот отчество бывает и не из одного слова				
				ƒл€ —ч = 3 ѕо ‘»ќ.–азмер—писка() ÷икл
					ќтчество1 = ќтчество1 + ‘»ќ.ѕолучить«начение(—ч) + " ";
				 онец÷икла;
				≈сли ѕустое«Ќачение(ќтчество1) = 0 “огда
					ќтчество1 = Ћев(ќтчество1,—трƒлина(ќтчество1)-1);
				 онец≈сли;
				ќтчество = ќтчество1;
			 онец≈сли;
		 онец≈сли;
	 онец≈сли; 
		
	ѕропискајдрес = —отрудник.јдресѕрописка;
	‘актическийјдрес = —отрудник.јдрес‘акт;
	≈сли (ѕустое«начение(—тр«аменить(‘актическийјдрес,",",""))=0) и (‘актическийјдрес<>ѕропискајдрес) “огда
		јдресƒл€»нформировани€ = ‘актическийјдрес;
	»наче≈сли ѕустое«начение(—тр«аменить(ѕропискајдрес,",",""))=0 “огда 
		јдресƒл€»нформировани€ = ѕропискајдрес;
	 онец≈сли;
	
 онецѕроцедуры //ѕри¬ыборе—отрудника
 
 
 //******************************************************************************
// Ќайтиѕервый—уществующий‘айл(—писок¬озможныхћест)
//
// ѕараметры: 
//  —писок¬озможныхћест
//
// ¬озвращаемое значение:
//
// ќписание:
//
‘ункци€ Ќайтиѕервый—уществующий‘айл(—писок¬озможныхћест)
	
	ƒл€ —ч = 1 ѕо —писок¬озможныхћест.–азмер—писка() ÷икл
		ѕолное»м€	=	—писок¬озможныхћест.ѕолучить«начение(—ч);
		≈сли ‘с.—уществует‘айл(ѕолное»м€) = 1 “огда	¬озврат(ѕолное»м€)	 онец≈сли;
	 онец÷икла;

	¬озврат("");

 онец‘ункции // Ќайтиѕервый—уществующий‘айл()

//******************************************************************************
//—формировать‘айл()
//	¬‘айлXML()
//
//	ѕараметры: нет
// 
//	ќписание:
//		‘ормирование файла передачи в ѕ‘–.
//
ѕроцедура —формировать‘айл() 
	
	≈сли (ѕроведен() = 0) или (ћодифицированность() = 1) “огда
		ѕредупреждение("ѕеред формированием файла документ следует провести!");
		¬озврат;
	 онец≈сли;
	
	 тлг=—окрЋѕ( аталог);
	≈сли ѕрав( тлг,1)="\" “огда
		ѕуть¬ывода = Ћев( тлг,—трƒлина( тлг)-1);
	»наче
		ѕуть¬ывода =  тлг;
	 онец≈сли;
	
	// ѕроверим, существует ли " аталог".
	≈сли (Ћев(ѕуть¬ывода, 2) <> "\\") и ((Ћев(ѕуть¬ывода,2)="a:")или (Ћев(ѕуть¬ывода,2)="A:")) тогда
		≈сли ‘—.—уществует‘айл(ѕуть¬ывода+"\NUL")=0 “огда
			—ообщить("Ќе возможен вывод файла данных дл€ передачи в ѕ‘– в каталог "+ѕуть¬ывода+"!");
			¬озврат;                     
		 онец≈сли;
	 онец≈сли;  
	
	// проверку правильности заполнени€ не проводим
	// все проверки при проведении документа

	// ѕолучим »ЌЌ.
	»ЌЌ=—окрЋѕ( онстанта.»ЌЌќрганизации);
	ќдинадцатый—имвол=—ред(»ЌЌ,11,1);
	≈сли (—трока(„исло(ќдинадцатый—имвол))=ќдинадцатый—имвол) и (ѕуста€—трока(ќдинадцатый—имвол) = 0) “огда 
		// оказалось физическое лицо
		»ЌЌ=Ћев(»ЌЌ,12);
		 ѕѕ = "0";
	»наче  // оказалась организаци€
		»ЌЌ = Ћев( онстанта.»ЌЌќрганизации,10);
		 ѕѕ = ѕрав( онстанта.»ЌЌќрганизации,9);
	 онец≈сли;
	≈сли ѕустое«начение( ѕѕ)=1 “огда
		 ѕѕ = "0"
	 онец≈сли;
	
	Ќаименование =  онстанта.Ќазваниеќрганизации;         
	Ќаименованиеѕолное =  онстанта.ќфициальноеЌазваниеќрганизации;
	–егЌомерѕ‘– = —окрЋѕ(глѕолучитьЌалог("ѕ‘–_страх").–егЌомер);
	
	Ќаименование = ¬–ег(гл«аменить—имвол¬—троке(—окрЋѕ(Ћев(—тр«аменить(Ќаименование,"""","'"),100))));
	Ќаименованиеѕолное = ¬–ег(гл«аменить—имвол¬—троке(—окрЋѕ(Ћев(—тр«аменить(Ќаименованиеѕолное,"""","'"),100))));

	Ќомѕачка— = глƒополнить—троку(—окрЋѕ(Ќомерƒок),5,"0");                                                       
	
	
	//«агрузим внешнюю компоненту V7Plus.dll
	—писок¬озможныхћест	=	—оздатьќбъект("—писок«начений");
	—писок¬озможныхћест.ƒобавить«начение( аталог»Ѕ()		+	"v7plus.dll"	);
	—писок¬озможныхћест.ƒобавить«начение( аталогѕрограммы()	+	"v7plus.dll"	);
	—писок¬озможныхћест.ƒобавить«начение( аталог»Ѕ()		+	"ExtForms\"	+	"v7plus.dll"	);
	
	гѕутьќбъекта_ омпонентаV7plus	=	Ќайтиѕервый—уществующий‘айл(—писок¬озможныхћест);
	
	≈сли «агрузить¬нешнюю омпоненту(гѕутьќбъекта_ омпонентаV7plus) <> 1	“огда
		ѕредупреждение(" омпонента v7plus.dll не найдена! ‘айл выгрузки не сформирован");
		¬озврат;
	 онец≈сли;
	
	XMLјнализатор	=	—оздатьќбъект("AddIn.XMLParser");
	’ћЋ‘айлƒанных	=	XMLјнализатор.—оздатьƒокумент();	         

	хмл орень 		= ’ћЋ‘айлƒанных.—оздатьѕодчиненныйЁлемент("‘айлѕ‘–");
	
	хмл»м€‘айла		= хмл орень.—оздатьѕодчиненныйЁлемент("»м€‘айла");
	
	»м€‘айла = "PFR-700-Y-" + ƒата√од(ƒатаƒок) + "-ORG-"+ ѕрав(–егЌомерѕ‘–,15) + "-DCK-"+Ћев(Ќомѕачка—,5)+"-DPT-000000-DCK-00000.XML"; 
	хмл»м€‘айла.«начение	= »м€‘айла;
	
	хмл«аголовок‘айла	 		= хмл орень.—оздатьѕодчиненныйЁлемент("«аголовок‘айла");
	хмл¬ерси€‘ормата			= хмл«аголовок‘айла.—оздатьѕодчиненныйЁлемент("¬ерси€‘ормата");
	хмл¬ерси€‘ормата.«начение	= "07.00";
	
	хмл“ип‘айла				= хмл«аголовок‘айла.—оздатьѕодчиненныйЁлемент("“ип‘айла");
	хмл“ип‘айла.«начение	= "¬Ќ≈ЎЌ»…";
	
	хмлѕрограммаѕодготовкиƒанных	= хмл«аголовок‘айла.—оздатьѕодчиненныйЁлемент("ѕрограммаѕодготовкиƒанных");
	хмлЌазваниеѕрограммы			= хмлѕрограммаѕодготовкиƒанных.—оздатьѕодчиненныйЁлемент("Ќазваниеѕрограммы");
	хмлЌазваниеѕрограммы.«начение	= "1—:«ј–ѕЋј“ј »  јƒ–џ";
		
	хмл¬ерси€						= хмлѕрограммаѕодготовкиƒанных.—оздатьѕодчиненныйЁлемент("¬ерси€");
	хмл¬ерси€.«начение				=  онстанта.Ќомер–елиза;
	
	хмл»сточникƒанных				= хмл«аголовок‘айла.—оздатьѕодчиненныйЁлемент("»сточникƒанных");
	хмл»сточникƒанных.«начение		= "—“–ј’ќ¬ј“≈Ћ№";
	
	хмлѕачка¬ход€щихƒокументов	 	= хмл орень.—оздатьѕодчиненныйЁлемент("ѕачка¬ход€щихƒокументов");	                          
	хмлѕачка¬ход€щихƒокументов.”становитьјтрибут("ќкружение","¬ составе файла");
	хмлѕачка¬ход€щихƒокументов.”становитьјтрибут("—тади€","ƒо обработки");
	хмлѕачка¬ход€щихƒокументов.”становитьјтрибут("ƒобровольныеѕравоотношени€","ƒ—¬");	
	
	хмл¬ход€ща€ќпись				= хмлѕачка¬ход€щихƒокументов.—оздатьѕодчиненныйЁлемент("¬’ќƒяўјя_ќѕ»—№");		
	

	//¬’ќƒяўјя_ќѕ»—№
	хмлЌомер¬пачке = хмл¬ход€ща€ќпись.—оздатьѕодчиненныйЁлемент("Ќомер¬пачке");
	хмлЌомер¬пачке.«начение	= 1;
	
	хмл“ип¬ход€щейќписи	=  хмл¬ход€ща€ќпись.—оздатьѕодчиненныйЁлемент("“ип¬ход€щейќписи");
	хмл“ип¬ход€щейќписи.«начение = "ќѕ»—№ ѕј„ »";
	
	хмл—оставительѕачки = хмл¬ход€ща€ќпись.—оздатьѕодчиненныйЁлемент("—оставительѕачки");
	
	глхмл—трахователь(хмл—оставительѕачки, »ЌЌ,  ѕѕ, –егЌомерѕ‘–);
	
	хмлЌомерѕачки	= хмл¬ход€ща€ќпись.—оздатьѕодчиненныйЁлемент("Ќомерѕачки");
	хмлќсновной		= хмлЌомерѕачки.—оздатьѕодчиненныйЁлемент("ќсновной");
	хмлќсновной.«начение = „исло(Ќомѕачка—);
	
	хмл—оставƒокументов	= хмл¬ход€ща€ќпись.—оздатьѕодчиненныйЁлемент("—оставƒокументов");
	
	хмл оличество			= хмл—оставƒокументов.—оздатьѕодчиненныйЁлемент(" оличество");
	хмл оличество.«начение	= 1;
	
	хмлЌаличиеƒокументов	= хмл—оставƒокументов.—оздатьѕодчиненныйЁлемент("Ќаличиеƒокументов");	
	
	хмл“ипƒокумента				= хмлЌаличиеƒокументов.—оздатьѕодчиненныйЁлемент("“ипƒокумента");
	хмл“ипƒокумента.«начение	= "«јя¬Ћ≈Ќ»≈_ќ_ƒќЅ–ќ¬ќЋ№Ќќћ_¬—“”ѕЋ≈Ќ»»_¬_ѕ–ј¬ќќ“ЌќЎ≈Ќ»я_¬_÷≈Ћя’_”ѕЋј“џ_ƒ—¬";
	
	хмл оличество			= хмлЌаличиеƒокументов.—оздатьѕодчиненныйЁлемент(" оличество");
	хмл оличество.«начение	=  оличество—трок();		
        
	хмлƒата—оставлени€	=  хмл¬ход€ща€ќпись.—оздатьѕодчиненныйЁлемент("ƒата—оставлени€");			
	хмлƒата—оставлени€.«начение = ‘ормат(ƒатаƒок,"ƒƒƒћћ√√√√");			
                         

	
	¬ыбрать—троки();
	ѕока ѕолучить—троку() = 1 ÷икл  
		
		“ипјдреса = "–ќ——»…— »…";
		јдрес—писком = "";
		≈сли глјдрес—оответствует“ребовани€мћЌ—(јдресƒл€»нформировани€) = 0 “огда
			“ипјдреса = "Ќ≈—“–” “”–»–ќ¬јЌЌџ…"
		»наче
			јдрес—писком = гл–азложить(—окрЋѕ(јдресƒл€»нформировани€));
		 онец≈сли;        
		
		// –еквизиты не провер€ютс€ на пустое значение, так как эта проверка есть при проведении.
		// «аполним общие реквизиты используемые в обоих документах.
		Ќомерƒокумента¬ѕачке = Ќомер—троки;
		
		‘амили€¬‘айл  = ¬–ег(гл«аменить—имвол¬—троке(‘амили€));
		»м€¬‘айл	  = ¬–ег(гл«аменить—имвол¬—троке(»м€));
		ќтчество¬‘айл = ¬–ег(гл«аменить—имвол¬—троке(ќтчество));
		
		«јя¬Ћ≈Ќ»≈ = хмлѕачка¬ход€щихƒокументов.—оздатьѕодчиненныйЁлемент("«јя¬Ћ≈Ќ»≈_ќ_ƒќЅ–ќ¬ќЋ№Ќќћ_¬—“”ѕЋ≈Ќ»»_¬_ѕ–ј¬ќќ“ЌќЎ≈Ќ»я_¬_÷≈Ћя’_”ѕЋј“џ_ƒ—¬");	
		
		xmlЌомер¬пачке				= «јя¬Ћ≈Ќ»≈.—оздатьѕодчиненныйЁлемент("Ќомер¬пачке");
		xmlЌомер¬пачке.«начение		= Ќомерƒокумента¬ѕачке +1 ;	
		
		xmlЌаименование“ерриториальногоќрганаѕ‘– = «јя¬Ћ≈Ќ»≈.—оздатьѕодчиненныйЁлемент("Ќаименование“ерриториальногоќрганаѕ‘–");
		xmlЌаименование“ерриториальногоќрганаѕ‘–.«начение = ¬–ег(гл«аменить—имвол¬—троке(—ќ –Ћѕ(Ќаименованиеѕ‘–))); 
		
		
		xml‘»ќ = «јя¬Ћ≈Ќ»≈.—оздатьѕодчиненныйЁлемент("‘»ќ");
		
		xml‘амили€	         = xml‘»ќ.—оздатьѕодчиненныйЁлемент("‘амили€");
		xml‘амили€.«начение	 = ‘амили€¬‘айл;  
		
		xml»м€  	         = xml‘»ќ.—оздатьѕодчиненныйЁлемент("»м€");
		xml»м€.«начение		 = »м€¬‘айл;
		
		xmlќтчество	         = xml‘»ќ.—оздатьѕодчиненныйЁлемент("ќтчество");
		xmlќтчество.«начение = ќтчество¬‘айл;
		
		
		xml—траховойЌомер			= «јя¬Ћ≈Ќ»≈.—оздатьѕодчиненныйЁлемент("—траховойЌомер");
		xml—траховойЌомер.«начение	= —траховойЌомерѕ‘–; 
		
		
		xmlјдресћеста∆ительства	= «јя¬Ћ≈Ќ»≈.—оздатьѕодчиненныйЁлемент("јдресћеста∆ительства");
		
		хмл“ипјдреса			= xmlјдресћеста∆ительства.—оздатьѕодчиненныйЁлемент("“ипјдреса");
		хмл“ипјдреса.«начение	= “ипјдреса;
		
		≈сли “ипјдреса = "Ќ≈—“–” “”–»–ќ¬јЌЌџ…" “огда 
			
			хмлЌеструктурированныйјдрес	= xmlјдресћеста∆ительства.—оздатьѕодчиненныйЁлемент("Ќеструктурированныйјдрес");
			хмлјдрес					= хмлЌеструктурированныйјдрес.—оздатьѕодчиненныйЁлемент("јдрес");
			хмлјдрес.«начение			= ¬рег(гл«аменить—имвол¬—троке(—ќ –Ћѕ(јдресƒл€»нформировани€)));
			
		»наче //российский адрес
			
			
			хмл»ндекс = xmlјдресћеста∆ительства.—оздатьѕодчиненныйЁлемент("»ндекс");						
			хмл»ндекс.«начение	= јдрес—писком.ѕолучить«начение(2);
			
			хмл–оссийскийјдрес	= xmlјдресћеста∆ительства.—оздатьѕодчиненныйЁлемент("–оссийскийјдрес"); 						
			
			глxml–оссийскийјдрес(хмл–оссийскийјдрес, јдрес—писком);
			
		 онец≈сли;
		
		
		хмлƒата«аполнени€			= «јя¬Ћ≈Ќ»≈.—оздатьѕодчиненныйЁлемент("ƒата«аполнени€");
		хмлƒата«аполнени€.«начение	= ‘ормат(ƒата«аполнени€,"ƒƒƒћћ√√√√");
		
			
	 онец÷икла;
	
	гл«аписатьXML‘айлѕ‘–( тлг + "\" + »м€‘айла,’ћЋ‘айлƒанных);
	≈сли ‘—.—уществует‘айл( тлг + "\" + »м€‘айла)=1 “огда

		ѕредупреждение("—формирован файл: " + »м€‘айла);
		
	 онец≈сли;

	
 онецѕроцедуры // —формировать‘айл() 

//******************************************************************************
//	”становитьƒоступностьЁлементов‘ормыƒл€ѕроведенногоƒокумента()
//
//	ѕараметры: нет
// 
//	ќписание:
//		”станавливает доступность дл€ реквизитов документа.
//
ѕроцедура ”становитьƒоступностьЁлементов‘ормыƒл€ѕроведенногоƒокумента()
	ƒл€ —четчик = 1 ѕо —писокЌередактируемых онтролов.–азмер—писка() ÷икл
		‘орма.ѕолучитьјтрибут(—писокЌередактируемых онтролов.ѕолучить«начение(—четчик)).ƒоступность(0);
	 онец÷икла;
	‘орма.кн¬‘айл.ƒоступность(1);	
 онецѕроцедуры // ”становитьƒоступностьЁлементов‘ормыƒл€ѕроведенногоƒокумента   

//******************************************************************************
// ¬водЌового()
//
ѕроцедура ¬водЌового( опирование)
	гл«аполнитьЎапку( онтекст,  опирование);
	Ќаименованиеѕ‘– =  онстанта.Ќаименование“ерриториальногоќрганаѕ‘–;
	
 онецѕроцедуры //¬водЌового

//******************************************************************************

ѕроцедура ѕриќткрытии() 
	
	
	// восстановим значение " аталог".
	 аталог = ¬осстановить«начение("ѕутьƒл€—охранени€");
	≈сли ѕустое«начение( аталог)=1 “огда
		 аталог =  аталогѕользовател€();
	 онец≈сли;
	
	—трокаЌередактируемых онтролов = "Ќомерƒок,ƒатаƒок,—отрудник, омментарий,Ќаименованиеѕ‘–,"
	+"—траховойЌомерѕ‘–,‘амили€,»м€,ќтчество,ƒата«аполнени€";
	—писокЌередактируемых онтролов = гл–азложить(—трокаЌередактируемых онтролов);
	
	≈сли ѕроведен() = 1 “огда
		”становитьƒоступностьЁлементов‘ормыƒл€ѕроведенногоƒокумента();
	 онец≈сли;
	
	
 онецѕроцедуры   

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ѕри«акрытии()
	
	—охранить«начение("ѕутьƒл€—охранени€",  аталог);
	
 онецѕроцедуры 

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ѕри¬воде—троки()  
	
	≈сли ѕроведен() = 1 “огда
		—ообщить("–едактирование проведенного документа запрещено!",10);
		—татус¬озврата(0); 
		¬озврат;
	 онец≈сли; 
	
	// –азмер пачки не может быть больше "конст–азмерѕачки".
	≈сли  оличество—трок() >= конст–азмерѕачки “огда
		ѕредупреждение("¬ пачке уже содержитс€ "+конст–азмерѕачки+" документов. "+
		–азделитель—трок+"¬вод нового документа в пачку невозможен!");
		—татус¬озврата(0); ¬озврат;
	 онец≈сли;
	
 онецѕроцедуры	// ѕри¬воде—троки   

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ѕри”далении—троки()
	≈сли ѕроведен() = 1 “огда
		—татус¬озврата(0); ¬озврат;
	 онец≈сли;
 онецѕроцедуры // ѕри”далении—троки

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ѕри»змененииѕор€дка—трок()
	≈сли ѕроведен() = 1 “огда
		—татус¬озврата(0); ¬озврат;
	 онец≈сли;
 онецѕроцедуры // ѕри»змененииѕор€дка—трок

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ќбработка¬ыбора«начени€(¬ыб«нач, »дентЁлемƒиалога, ‘лаг—тандќбр)
	// внутренних совместителей включать в документ не будем и
	≈сли »дентЁлемƒиалога = "—отрудник" “огда
		// сотрудника два раза вводить нельз€.
		¬ыбрать—троки();
		ѕока ѕолучить—троку() = 1 ÷икл
			≈сли —отрудник = ¬ыб«нач “огда
				ѕредупреждение("ƒанный сотрудник уже введен в документ.");
				‘лаг—тандќбр = 0;
			 онец≈сли;
		 онец÷икла;
	 онец≈сли;
 онецѕроцедуры	// ќбработка¬ыбора«начени€

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ѕриЌачале–едактировани€—троки()
	// ¬ызов редактировани€ адреса через нажатие на текстовое поле.
	≈сли ѕроведен() = 0 “огда
		≈сли ‘орма.јктивныйЁлемент() = "ѕредставлениејдреса" “огда
			гл¬водјдреса(јдресƒл€»нформировани€);
			≈сли —окрЋѕ(јдресƒл€»нформировани€) = ",,,,,,,,," “огда
				јдресƒл€»нформировани€ = "";
			 онец≈сли;
		 онец≈сли;	
	»наче
		—ообщить("–едактирование проведенного документа запрещено!",10);
		—татус¬озврата(0);
	 онец≈сли;
 онецѕроцедуры // ѕриЌачале–едактировани€—троки

//******************************************************************************
// ѕредопределенна€ процедура
//
ѕроцедура ѕриЌачале¬ыбора«начени€(»дентЁлемƒиалога, ‘лаг—тандќбр) 
	
	≈сли »дентЁлемƒиалога = " аталог" “огда  
		
		‘лаг—тандќбр = 0;   
		≈сли ‘—.—уществует‘айл( аталог+"\NUL")=1 “огда
			 ат =  аталог;
		»наче
			 ат = "C:\";
		 онец≈сли;
		≈сли ‘—.¬ыбрать аталог( ат,"¬ыбор каталога дл€ вывода файла данных")=1 “огда
			 аталог =  ат;
		 онец≈сли;
   
	 онец≈сли;   
	
 онецѕроцедуры // ѕриЌачале¬ыбора«начени€()    

конст–азмерѕачки = 200;