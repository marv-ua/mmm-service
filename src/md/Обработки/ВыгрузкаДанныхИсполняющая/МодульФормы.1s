ѕерем	г—трѕуть;
ѕерем	г»м€‘айла;

ѕерем	г—четчик¬ыгруженныхќбъектов;

//ѕерем	—писок—писков¬ыгруженныхќбъектов;
ѕерем	“аб¬ыгруженныхќбъектов;

ѕерем	—писок”зловƒобавл€емыхѕослеѕроведени€;

//ѕерем	г—писокќбработанныхѕравил;
//ѕерем	г—писокЌеобработанныхѕравил;

ѕерем	“абќбласть1;
ѕерем	“абќбласть2;
ѕерем	“абќбласть3;
ѕерем	“абќбласть4;

ѕерем	г онт;
ѕерем	гЅезќткрыти€‘ормы;

ѕерем	г—писокѕараметров;

ѕерем	гXMLјнализатор;
ѕерем	г‘айлƒанных;
ѕерем	гѕравила;

ѕерем	гѕутьќбъекта_»сполн€емый од;

ѕерем	г“абќбъектов;	//	таблица интерактивно заданных объектов выгрузки

ѕерем	г“аб эшѕравил;
ѕерем	г“аб эш–еквизитов;
ѕерем	г“аб эш–еквизитов«начений;
ѕерем	г“аб эшѕараметров«агрузки;


////////////////////////////////////////////////////////////////////////////////////////////////////
//	ѕеременные переданные из интерфейсной формы

ѕерем	‘ормƒатаЌач;
ѕерем	‘ормƒата он;
ѕерем	‘орм»м€‘айлаƒанных;
                                                                    
ѕерем	‘орм‘лЌе¬ыгружатьЅух»тоги;
ѕерем	‘ормƒата–асчетаЅух»тогов;
ѕерем	‘орм од—четаƒл€¬водаќстатков;
ѕерем	‘ормћакс олвоѕроводок;
ѕерем	‘ормѕланы—четов;
ѕерем	‘орм–азделители”чета;

ѕерем	‘орм олвоЅуферизуемыхќбъектов;
ѕерем	‘орм‘л¬ключатьѕравила¬‘айл;
ѕерем	‘орм‘лЌеќбрабатыватьѕроведение;
ѕерем	‘орм‘л¬ыгружать“олько»нтерактивные;

ѕерем	‘орм‘л«апоминать—сылки;


////////////////////////////////////////////////////////////////////////////////////////////////////
//	ѕеременные дл€ свертки бух. итогов

ѕерем	г“екущийѕлан—четов;
ѕерем	г“екущий–азделитель”чета;
ѕерем	г“екуща€ќпераци€ќстатков;
ѕерем	г“екущее олвоѕроводок;
ѕерем	гЅух»тоги;
ѕерем	г олвоќпераций—ќстатками;


//**************************************************************************************************
//----	Ќачало предварительного описани€ функций	------------------------------------------------
//**************************************************************************************************

‘ункци€	ƒополнительныеѕреобразовани€(¬ид="", »д="", »сточник="", ѕриемник="", —писокѕараметровѕравила="")					ƒалее
‘ункци€	¬ыгрузить(»сточник, »дѕравила="", ”зел—сылки=0, ѕараметрыѕравила="", «нач “ипѕриемника="", «нач ¬идѕриемника="")	ƒалее
‘ункци€	ѕроверить√руппу”словий(«нач ”слови€, «нач ќбъект, «нач “ип”слови€="»")												ƒалее
‘ункци€	”слови€¬ыполн€ютс€(«нач ”слови€, «нач ќбъект, »дѕравилаƒок="")														ƒалее
‘ункци€	ѕолучить»дќбъекта»сточника(»сточник, »д—инхронизирующего–еквизита="")												ƒалее
‘ункци€ ѕолучить«начениећетодом(»сточник, ћетод)																			ƒалее
‘ункци€ ƒобавить–еквизит(“аб, »сточник, ѕриемник="", «нач «н="#ѕолучить", «нач —пособ«агрузкиѕо”молчанию="", —писокƒопѕараметровѕравила="")	ƒалее

ѕроцедура «аписатьќперациюЅух»тогов(ƒок)	ƒалее
ѕроцедура Ќачальна€»нициализаци€()			ƒалее

//**************************************************************************************************
//----	 онец предварительного описани€ функций	----------------------------------------------------
//**************************************************************************************************
               


//**************************************************************************************************
//----	Ќачало процедур и функций свертки бух. итогов
//**************************************************************************************************

‘ункци€ ƒобавитьѕроводку(—чет, —писок—убконто, ¬алюта, —умма, ¬ал—умма,  оличество)
	
	// если все остатки равны нулю то не делать проводку
	≈сли (—умма = 0) » (¬ал—умма = 0) » ( оличество = 0) “огда
	    ¬озврат 1;
	 онец≈сли;    
	
	г“екуща€ќпераци€ќстатков.Ќова€ѕроводка(); г“екуща€ќпераци€ќстатков.–азделитель”чета =  онстанта.ќсновноеёрЋицо;
	// выбор корреспонденции счета
	≈сли —чет.јктивный = 1 “огда
		ќсновна€ орреспонденци€ = г“екуща€ќпераци€ќстатков.ƒебет;
		¬спом орреспонденци€ = г“екуща€ќпераци€ќстатков. редит;
		«нак = 1;
    »наче≈сли —чет.јктивный = 2 “огда
		ќсновна€ орреспонденци€ = г“екуща€ќпераци€ќстатков. редит;
		¬спом орреспонденци€ = г“екуща€ќпераци€ќстатков.ƒебет;
		«нак = -1;
	»наче≈сли (—умма < 0) »ли ((—умма = 0) » (¬ал—умма < 0)) »ли 
			  ((—умма = 0) » (¬ал—умма = 0) » ( оличество < 0)) “огда
		ќсновна€ орреспонденци€ = г“екуща€ќпераци€ќстатков. редит;
		¬спом орреспонденци€ = г“екуща€ќпераци€ќстатков.ƒебет;
		«нак = -1;
	»наче
		ќсновна€ орреспонденци€ = г“екуща€ќпераци€ќстатков.ƒебет;
		¬спом орреспонденци€ = г“екуща€ќпераци€ќстатков. редит;
		«нак = 1;
	 онец≈сли;
	                                     
	ќсновна€ орреспонденци€.—чет = —чет.“екущий—чет();
	≈сли ѕустое«начение(—писок—убконто) = 0 “огда
		ƒл€ »нд=1 ѕо —писок—убконто.–азмер—писка() ÷икл
			¬ид—убконто = —чет.¬ид—убконто(—писок—убконто.ѕолучить«начение(»нд));
			ќсновна€ орреспонденци€.—убконто(¬ид—убконто, гЅух»тоги.—убконто(¬ид—убконто));
		 онец÷икла;                                           
	 онец≈сли;

	≈сли —чет.«абалансовый = 0 “огда
	    ¬спом орреспонденци€.—чет = —четѕо оду(‘орм од—четаƒл€¬водаќстатков, г“екущийѕлан—четов);
	 онец≈сли;
	
	≈сли —чет.¬алютный = 1 “огда
		г“екуща€ќпераци€ќстатков.¬алюта = ¬алюта;  
	 онец≈сли;
	
	≈сли ћетаданные.–азделитель”чета.¬ыбран() = 1 “огда
		г“екуща€ќпераци€ќстатков.”становитьјтрибут(ћетаданные.–азделитель”чета.»дентификатор, гЅух»тоги.»спользовать–азделитель”чета());
	 онец≈сли;
	
	г“екуща€ќпераци€ќстатков.—умма		=	«нак * —умма;
	г“екуща€ќпераци€ќстатков.¬ал—умма	=	«нак * ¬ал—умма;
	г“екуща€ќпераци€ќстатков. оличество	=	«нак *  оличество;
	
	г“екущее олвоѕроводок = г“екущее олвоѕроводок + 1;
	≈сли г“екущее олвоѕроводок = ‘ормћакс олвоѕроводок “огда
		
		г“екуща€ќпераци€ќстатков.ƒатаќперации	=	‘ормƒата он;
		г“екуща€ќпераци€ќстатков.—одержание		=	"#ќстатки по счетам (" + г олвоќпераций—ќстатками + ")";
		
		«аписатьќперациюЅух»тогов(г“екуща€ќпераци€ќстатков.ƒокумент);
		
		г олвоќпераций—ќстатками	=	г олвоќпераций—ќстатками + 1;
		
		г“екуща€ќпераци€ќстатков.Ќова€();
		г“екущее олвоѕроводок = 0;
		
	 онец≈сли;
	
	¬озврат 1;
	
 онец‘ункции		//	ƒобавитьѕроводку()

//--------------------------------------------------------------------------------------------------

‘ункци€ —формироватьќстаткиѕо—убконто(Ќомер—убконто, —чет, —писок—убконто, ¬алюта, —умма, ¬ал—умма,  оличество, ѕо—умме, ѕо¬ал—умме, ѕо оличеству)
	
	≈сли Ќомер—убконто > —писок—убконто.–азмер—писка() “огда
        ƒобавитьѕроводку(—чет, —писок—убконто, ¬алюта, —умма, ¬ал—умма,  оличество);
		—умма = 0;
		¬ал—умма = 0;
		 оличество = 0;
	»наче                  
		ѕозици€—убконто = —писок—убконто.ѕолучить«начение(Ќомер—убконто);
		¬ид—убконто = —чет.¬ид—убконто(ѕозици€—убконто);
		гЅух»тоги.¬ыбрать—убконто(¬ид—убконто);
		ѕока гЅух»тоги.ѕолучить—убконто(¬ид—убконто) = 1 ÷икл
			≈сли (—чет.”четѕо—умме(ѕозици€—убконто) = 1) » (ѕо—умме = 1) “огда
				—умма = гЅух»тоги.— ƒ()-гЅух»тоги.—  ();
			 онец≈сли;
			≈сли (—чет.”четѕо¬алютной—умме(ѕозици€—убконто) = 1) » (ѕо¬ал—умме = 1) “огда
				¬ал—умма = гЅух»тоги.— ƒ(2)-гЅух»тоги.—  (2);
			 онец≈сли;
			≈сли (—чет.”четѕо оличеству(ѕозици€—убконто) = 1) » (ѕо оличеству = 1) “огда
				 оличество = гЅух»тоги.— ƒ(3)-гЅух»тоги.—  (3);
			 онец≈сли;
		    —формироватьќстаткиѕо—убконто(Ќомер—убконто+1, —чет, —писок—убконто, ¬алюта, —умма, ¬ал—умма,  оличество, ѕо—умме, ѕо¬ал—умме, ѕо оличеству);
		 онец÷икла;
	 онец≈сли;
	
	¬озврат 1;
	
 онец‘ункции		//	—формироватьќстаткиѕо—убконто()

//--------------------------------------------------------------------------------------------------

‘ункци€ —формироватьќстаткиѕо¬алюте(—чет, —писок—убконто, ѕо—умме, ѕо¬ал—умме, ѕо оличеству)
	
	—умма = 0;
	¬ал—умма = 0;
	 оличество = 0;
	≈сли —чет.¬алютный = 1 “огда
	    гЅух»тоги.¬ыбрать¬алюты();
		ѕока гЅух»тоги.ѕолучить¬алюту() = 1 ÷икл
			≈сли ѕо—умме = 1 “огда
				—умма = гЅух»тоги.— ƒ()-гЅух»тоги.—  ();
			 онец≈сли;
			≈сли ѕо¬ал—умме = 1 “огда
				¬ал—умма = гЅух»тоги.— ƒ(2)-гЅух»тоги.—  (2);
			 онец≈сли;
			≈сли ѕо оличеству = 1 “огда
				 оличество = гЅух»тоги.— ƒ(3)-гЅух»тоги.—  (3);
			 онец≈сли;
		    ≈сли —формироватьќстаткиѕо—убконто(1, —чет, —писок—убконто, гЅух»тоги.¬алюта, —умма, ¬ал—умма,  оличество, ѕо—умме, ѕо¬ал—умме, ѕо оличеству) = 0 “огда
				¬озврат 0;
			 онец≈сли;
		 онец÷икла;
	»наче
		≈сли ѕо—умме = 1 “огда
			—умма = гЅух»тоги.— ƒ()-гЅух»тоги.—  ();
		 онец≈сли;
		≈сли ѕо¬ал—умме = 1 “огда
			¬ал—умма = гЅух»тоги.— ƒ(2)-гЅух»тоги.—  (2);
		 онец≈сли;
		≈сли ѕо оличеству = 1 “огда
			 оличество = гЅух»тоги.— ƒ(3)-гЅух»тоги.—  (3);
		 онец≈сли;
	    ≈сли —формироватьќстаткиѕо—убконто(1, —чет, —писок—убконто, 0, —умма, ¬ал—умма,  оличество, ѕо—умме, ѕо¬ал—умме, ѕо оличеству) = 0 “огда
			¬озврат 0;
		 онец≈сли;
	 онец≈сли;
	¬озврат 1;
	
 онец‘ункции //—формироватьќстаткиѕо¬алюте()

//--------------------------------------------------------------------------------------------------

‘ункци€ —формироватьќстаткиѕо—чету(—чет, –азделитель”чета)
	
	ѕерем —тр;
	
    —ообщение = "‘ормирование остатков ";

	// список позиций в счете видов субконто
	—писок—убконто = —оздатьќбъект("—писок«начений"); 
	
	≈сли ћетаданные.–азделитель”чета.¬ыбран() = 1 “огда   
		—ообщение = —ообщение + ":  " + –азделитель”чета;
		гЅух»тоги.»спользовать–азделитель”чета(–азделитель”чета);    
	 онец≈сли;                                                        
	
	≈сли ѕланы—четов. оличество«начений() > 1 “огда
		—ообщение = —ообщение + "  план: " + —чет.ѕлан—четов();
	 онец≈сли;
	—ообщение = —ообщение + " по счету: " + —чет;

	// ‘лаг показывающий что настройки субконто позвол€ют 
	// сформировать все проводки за 1 проход
	ѕо¬сем = 1;
	// добавл€ем группировки по видам субконто              
	ƒл€ »нд = 1 ѕо —чет. оличество—убконто() ÷икл
		// оборотные субконто пропускаем так как по ним нет остатков
		≈сли —чет.“олькоќбороты(»нд) = 1 “огда
			ѕродолжить;
		 онец≈сли;
		ј1 = 0;
		ј2 = 0;
		гЅух»тоги.»спользовать—убконто(—чет.¬ид—убконто(»нд));
		// дл€ последующего анализа на предмет возможности 
		// сформировать все проводки за 1 проход
		≈сли —чет.”четѕо—умме(»нд) = 1 “огда
			ј1 = ј1+1;
			ј2 = ј2+1;
		 онец≈сли;
		≈сли (—чет.¬алютный = 1) » (—чет.”четѕо¬алютной—умме(»нд) = 1) “огда
			ј1 = ј1+1;
			ј2 = ј2+2;
		 онец≈сли;
		≈сли (—чет. оличественный = 1) » (—чет.”четѕо оличеству(»нд) = 1) “огда
			ј1 = ј1+1;
			ј2 = ј2+4;
		 онец≈сли;
		—писок—убконто.ƒобавить«начение(»нд, ""+ј1+ј2+»нд);
	 онец÷икла;
	—писок—убконто.—ортироватьѕоѕредставлению(1);         

	// анализ возможности сформировать все проводки за 1 проход
	ј1 = 0;
	ј2 = 0;
	ƒл€ »нд=1 ѕо —писок—убконто.–азмер—писка() ÷икл
		—писок—убконто.ѕолучить«начение(»нд, —тр);
		ј11 = „исло(—ред(—тр, 1, 1));
		ј22 = „исло(—ред(—тр, 2, 1));
		≈сли ј1 = ј11 “огда
			≈сли ј2 <> ј22 “огда
			  ѕо¬сем = 0;
			  ѕрервать;
			 онец≈сли;
		»наче≈сли (ј1 <> 3) » (ј11 <> 3) “огда
			≈сли 7-ј2 = ј22 “огда
			  ѕо¬сем = 0;
			  ѕрервать;
			 онец≈сли;
		 онец≈сли;
		ј1 = ј11;
		ј2 = ј22;
	 онец÷икла;
	        
	// выборка итогов по счету
	¬ид—уммы = "—";
	≈сли —чет.¬алютный = 1 “огда
	    ¬ид—уммы = ¬ид—уммы+"¬";
	 онец≈сли;
	≈сли —чет. оличественный = 1 “огда
	    ¬ид—уммы = ¬ид—уммы+" ";
	 онец≈сли;                
	
	≈сли гЅух»тоги.¬ыполнить«апрос(, ‘ормƒата–асчетаЅух»тогов, —чет,,, 1,, ¬ид—уммы) = 0 “огда
		¬озврат 0;
	 онец≈сли;
	
	—осто€ние(—ообщение);
	                          
	≈сли ѕо¬сем = 1 “огда
		// формирование за один проход 
		≈сли —формироватьќстаткиѕо¬алюте(—чет, —писок—убконто, 1, 1, 1) = 0 “огда
			¬озврат 0;
		 онец≈сли;
	»наче                                      
		// формирование за несколько проходов 
		—писок—убконто.”далить¬се();
		ƒл€ »нд=1 ѕо —чет. оличество—убконто() ÷икл
			≈сли (—чет.“олькоќбороты(»нд) = 0) » (—чет.”четѕо—умме(»нд) =  1) “огда
			    —писок—убконто.ƒобавить«начение(»нд);
			 онец≈сли;                               
		 онец÷икла;
		≈сли —формироватьќстаткиѕо¬алюте(—чет, —писок—убконто, 1, 0, 0) = 0 “огда
			¬озврат 0;
		 онец≈сли;
                                                             
		≈сли —чет.¬алютный = 1 “огда
			—писок—убконто.”далить¬се();
			ƒл€ »нд=1 ѕо —чет. оличество—убконто() ÷икл
				≈сли (—чет.“олькоќбороты(»нд) = 0) » (—чет.”четѕо¬алютной—умме(»нд) =  1) “огда
				    —писок—убконто.ƒобавить«начение(»нд);
				 онец≈сли;                               
			 онец÷икла;
			≈сли —формироватьќстаткиѕо¬алюте(—чет, —писок—убконто, 0, 1, 0) = 0 “огда
				¬озврат 0;
			 онец≈сли;
		 онец≈сли;              
		
		≈сли —чет. оличественный = 1 “огда
			—писок—убконто.”далить¬се();
			ƒл€ »нд=1 ѕо —чет. оличество—убконто() ÷икл
				≈сли (—чет.“олькоќбороты(»нд) = 0) » (—чет.”четѕо оличеству(»нд) =  1) “огда
				    —писок—убконто.ƒобавить«начение(»нд);
				 онец≈сли;                               
			 онец÷икла;
			≈сли —формироватьќстаткиѕо¬алюте(—чет, —писок—убконто, 0, 0, 1) = 0 “огда
				¬озврат 0;
			 онец≈сли;
		 онец≈сли;
	 онец≈сли;
	
	¬озврат 1;
	
 онец‘ункции		//	—формироватьќстаткиѕо—чету()

//--------------------------------------------------------------------------------------------------

‘ункци€ —формироватьќстаткиѕо—четам(ѕлан—четов, –азделитель”чета)
	
    //—одержаниеќперации = "#ќстатки по счетам";
	//≈сли ћетаданные.–азделитель”чета.¬ыбран() = 1 “огда   
	//    —одержаниеќперации = —одержаниеќперации + " разделитель учета: " + –азделитель”чета +  "  ";
	// онец≈сли;
	//≈сли ѕланы—четов. оличество«начений() > 1 “огда
	//    —одержаниеќперации = —одержаниеќперации + "план счетов: " + ѕлан—четов + "  ";
	// онец≈сли;                                  
	
	—писок¬ыбранных—четов	=	‘ормѕланы—четов.ѕолучить(г“екущийѕлан—четов.»дентификатор());
	
	
	—чет = —оздатьќбъект("—чет." + ѕлан—четов.»дентификатор());
	—чет.¬ыбрать—чета();
	ѕока —чет.ѕолучить—чет() = 1 ÷икл
		
		≈сли —писок¬ыбранных—четов.ѕринадлежит(—чет.“екущий—чет()) = 0 “огда ѕродолжить  онец≈сли;
		
		≈сли —чет.”ровень() = 1 “огда
			≈сли г“екущее олвоѕроводок > ‘ормћакс олвоѕроводок “огда
				
				г“екуща€ќпераци€ќстатков.ƒатаќперации	=	‘ормƒата он;
				г“екуща€ќпераци€ќстатков.—одержание		=	"#ќстатки по счетам (" + г олвоќпераций—ќстатками + ")";
				
				«аписатьќперациюЅух»тогов(г“екуща€ќпераци€ќстатков.ƒокумент);
				
				г олвоќпераций—ќстатками	=	г олвоќпераций—ќстатками + 1;
				
				г“екуща€ќпераци€ќстатков.Ќова€();
				г“екущее олвоѕроводок = 0;
				
			 онец≈сли;
		 онец≈сли;
		
		≈сли —чет.Ёто√руппа() = 1 “огда ѕродолжить  онец≈сли;
		
	    ≈сли —формироватьќстаткиѕо—чету(—чет, –азделитель”чета) = 0 “огда ¬озврат(0)  онец≈сли;
		
	 онец÷икла;   
	
	≈сли г“екущее олвоѕроводок > 0 “огда
		
		г“екуща€ќпераци€ќстатков.ƒатаќперации	=	‘ормƒата он;
		г“екуща€ќпераци€ќстатков.—одержание		=	"#ќстатки по счетам (" + г олвоќпераций—ќстатками + ")";
		
		«аписатьќперациюЅух»тогов(г“екуща€ќпераци€ќстатков.ƒокумент);
		
		г олвоќпераций—ќстатками	=	г олвоќпераций—ќстатками + 1;
		
		г“екуща€ќпераци€ќстатков.Ќова€();
		г“екущее олвоѕроводок = 0;
		
	 онец≈сли;
	
	//≈сли ћетаданные.–азделитель”чета.¬ыбран() = 1 “огда   
	//	—ообщить("—формированы остатки по счетам по разделителю учета:  """+—окрЋѕ(–азделитель”чета)+"""");
	//»наче
	//	—ообщить("—формированы остатки по счетам.");
	// онец≈сли;
	
	¬озврат(1);
	
 онец‘ункции		//	—формироватьќстаткиѕо—четам()

//--------------------------------------------------------------------------------------------------

‘ункци€ —формироватьќстаткиѕо–азделител€м”чета()
		 
	≈сли ‘орм–азделители”чета.ѕолучить«начение(1) = "<Ќе используетс€>" “огда
		г“екущий–азделитель”чета = ѕолучитьѕустое«начение();
		¬озврат	—формироватьќстаткиѕо—четам(г“екущийѕлан—четов, г“екущий–азделитель”чета);
	 онец≈сли;
	
	ƒл€ —ч = 1 ѕо ‘орм–азделители”чета.–азмер—писка() ÷икл
		≈сли ‘орм–азделители”чета.ѕометка(—ч)=0 “огда ѕродолжить  онец≈сли;
		г“екущий–азделитель”чета	=	‘орм–азделители”чета.ѕолучить«начение(—ч);
		≈сли —формироватьќстаткиѕо—четам(г“екущийѕлан—четов, г“екущий–азделитель”чета) = 0 “огда ¬озврат(0)  онец≈сли;
	 онец÷икла;
	
	¬озврат 1;
		
 онец‘ункции		//	—формироватьќстаткиѕо–азделител€м”чета()

//--------------------------------------------------------------------------------------------------

ѕроцедура «акрытие—четов()
	
	ƒл€ —ч = 1 ѕо ‘ормѕланы—четов.–азмер—писка() ÷икл
		≈сли ‘ормѕланы—четов.ѕометка(—ч)=0 “огда ѕродолжить  онец≈сли;
		г“екуща€ќпераци€ќстатков = —оздатьќбъект("ќпераци€");
		г“екуща€ќпераци€ќстатков.Ќова€();
		г“екущее олвоѕроводок	= 0;
		
		//г“екущийѕлан—четов	=	‘ормѕланы—четов.ѕолучить«начение(—ч);
		
		г“екущийѕлан—четов		=	ѕланы—четов.«начениеѕоЌомеру(—ч);
		
		≈сли —формироватьќстаткиѕо–азделител€м”чета() = 0 “огда ¬озврат  онец≈сли;
	 онец÷икла;
	
 онецѕроцедуры		//	«акрытие—четов()


//**************************************************************************************************
//----	 онец процедур и функций свертки бух. итогов
//**************************************************************************************************


//--------------------------------------------------------------------------------------------------
                                                                                                    
ѕроцедура ”становитьјтрибут(Ёлемент, »дјтрибута, «нјтрибута, ѕроверить=1);
	
	≈сли	ѕроверить = 1 “огда
		≈сли ѕустое«начение(«нјтрибута) = 0 “огда
			«нјтрибута	=	—тр«аменить(«нјтрибута,	–азделитель—трок,	"#рс#" );
			«нјтрибута	=	—тр«аменить(«нјтрибута,	—имвол“абул€ции,	"#ст#" );
			Ёлемент.”становитьјтрибут(»дјтрибута, «нјтрибута);
		 онец≈сли;
	»наче
		«нјтрибута	=	—тр«аменить(«нјтрибута,	–азделитель—трок,	"#рс#" );
		«нјтрибута	=	—тр«аменить(«нјтрибута,	—имвол“абул€ции,	"#ст#" );
		Ёлемент.”становитьјтрибут(»дјтрибута, «нјтрибута);
	 онец≈сли;
	
 онецѕроцедуры		//	”становитьјтрибут()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€  опировать”зел(”зел)
	
	≈сли ѕустое«начение(”зел) = 1 “огда ¬озврат("")  онец≈сли;
	
	XML_DOM		=	гXMLјнализатор.—оздатьƒокумент();
	XML_DOM.«агрузить»з—троки(”зел.ѕредставлениеXML);
	 опи€”зла	=	XML_DOM.¬ыбрать”зел(”зел.»м€“эга);
	
	¬озврат(  опи€”зла );
	
 онец‘ункции		//	 опировать”зел()

//--------------------------------------------------------------------------------------------------

ѕроцедура «аписатьќшибку(—одержание, ћаркер="")
                        
	—ообщить(—одержание, ћаркер);
	
 онецѕроцедуры		//	«аписатьќшибку()

//--------------------------------------------------------------------------------------------------

‘ункци€ ќтделить–азделителем(—тр, «нач –азделитель, –ежим=0)

	ѕрава€„асть	=	"";
	–азделитель	=	Ќайти(—тр, –азделитель);
	≈сли –азделитель > 0 “огда
		ѕрава€„асть	=	—ред(—тр,		–азделитель + ?(–ежим=2, 0, 1));
		—тр			=	—окрЋѕ(Ћев(—тр,	–азделитель - ?(–ежим=1, 0, 1)));
	 онец≈сли;

	¬озврат(ѕрава€„асть);
	
 онец‘ункции		//	ќтделить–азделителем()

//--------------------------------------------------------------------------------------------------



//**************************************************************************************************
//----	Ќачало функций	проверки условий	--------------------------------------------------------
//**************************************************************************************************

‘ункци€ ѕривести “ипу(«н, “ип)
	
    ≈сли		“ип = "ƒата"	“огда
		¬озврат	ƒата(«н);                                  
	»наче≈сли	“ип = "„исло"	“огда
		¬озврат	„исло(«н);
	»наче
		¬озврат	Ќ–ег(—окрЋѕ(«н));
	 онец≈сли;
	
 онец‘ункции

//--------------------------------------------------------------------------------------------------

‘ункци€ ѕроверить”словие(«нач ”словие, «нач ќбъект)
	
	»д–еквизита			=	”словие.ѕолучитьјтрибут("–еквизит");
	¬ид”слови€			=	”словие.ѕолучитьјтрибут("¬ид”слови€");
	–еквизитќперации	=	”словие.ѕолучитьјтрибут("Ёто–еквизитќперации");
	≈сли Ќайти(»д–еквизита, "()") > 0 “огда
		«начение		=	ѕолучить«начениећетодом(ќбъект, »д–еквизита);
	»наче    
		≈сли		ѕустое«начение(»д–еквизита) = 1			“огда
			«начение	=	ќбъект;
		//»наче≈сли	ѕустое«начение(—окрЋѕ(ќбъект)) = 1		“огда
		//	¬озврат(0);	
		»наче≈сли	“ип«начени€—тр(ќбъект) = "ќпераци€"		“огда
			≈сли		»д–еквизита = "—четƒт" “огда
				«начение	=	ќбъект.ƒебет.—чет;
			»наче≈сли	»д–еквизита = "—чет т" “огда
				«начение	=	ќбъект. редит.—чет;
			»наче
				«начение	=	ќбъект.ѕолучитьјтрибут(»д–еквизита);
			 онец≈сли;
		»наче≈сли	ѕустое«начение(–еквизитќперации) = 1	“огда
			«начение		=	ќбъект.ѕолучитьјтрибут(»д–еквизита);
		»наче
			«начение		=	ќбъект.ќпераци€.ѕолучитьјтрибут(»д–еквизита);
		 онец≈сли;
	 онец≈сли;
	
	≈сли		¬ид”слови€	=	"”довлетвор€ет”словию" “огда
		
		¬озврат	”слови€¬ыполн€ютс€(”словие.¬ыбрать”зел("”слови€"), «начение);
		
	»наче
		“ип«нач		=	“ип«начени€—тр(«начение);
		
		«н			=	ѕривести “ипу(ѕолучить»дќбъекта»сточника(«начение), “ип«нач);
		
		«нач1		=	ѕривести “ипу(”словие.ѕолучитьјтрибут("«нач1"), 	“ип«нач);
		«нач2		=	ѕривести “ипу(”словие.ѕолучитьјтрибут("«нач2"), 	“ип«нач);
		
		≈сли		¬ид”слови€	=	"–авно"					“огда	¬озврат ?(	«н	=	«нач1					, 1, 0);
		»наче≈сли	¬ид”слови€	=	"Ќе–авно"				“огда	¬озврат ?(	«н	<>	«нач1					, 1, 0);
		»наче≈сли	¬ид”слови€	=	"ѕустое«начение"		“огда	¬озврат ?(	ѕустое«начение(«н) = 1			, 1, 0);
		»наче≈сли	¬ид”слови€	=	"Ќеѕустое«начение"		“огда	¬озврат ?(	ѕустое«начение(«н) = 0			, 1, 0);
		»наче≈сли	¬ид”слови€	=	"¬ключаетѕодстроку"		“огда	¬озврат ?(	Ќайти(«н, «нач1) > 0			, 1, 0);
		»наче≈сли	¬ид”слови€	=	"Ќе¬ключаетѕодстроку"	“огда	¬озврат	?(	Ќайти(«н, «нач1) = 0			, 1, 0);
		»наче≈сли	¬ид”слови€	=	"явл€етс€ѕодстрокой"	“огда	¬озврат ?(	Ќайти(«нач1, «н) > 0			, 1, 0);
		»наче≈сли	¬ид”слови€	=	"Ќеявл€етс€ѕодстрокой"	“огда	¬озврат	?(	Ќайти(«нач1, «н) = 0			, 1, 0);
		»наче≈сли	¬ид”слови€	=	"Ѕольше"				“огда	¬озврат ?(	«н	>	«нач1					, 1, 0);
		»наче≈сли	¬ид”слови€	=	"Ѕольше»ли–авно"		“огда	¬озврат ?(	«н	>=	«нач1					, 1, 0);
		»наче≈сли	¬ид”слови€	=	"ћеньше"				“огда	¬озврат ?(	«н	<	«нач1					, 1, 0);
		»наче≈сли	¬ид”слови€	=	"ћеньше»ли–авно"		“огда	¬озврат	?(	«н	<=	«нач1					, 1, 0);
		»наче≈сли	¬ид”слови€	=	"»нтервал—√раницами"	“огда	¬озврат ?(	(«н	>=	«нач1) » («н <=	«нач2)	, 1, 0);
		»наче≈сли	¬ид”слови€	=	"»нтервалЅез√раниц"		“огда	¬озврат ?(	(«н	>	«нач1) » («н <	«нач2)	, 1, 0);
		»наче		«аписатьќшибку("Ќе идентифицирован вид услови€:   " + ¬ид”слови€);
		 онец≈сли;
	 онец≈сли;
	
 онец‘ункции		//	ѕроверить”словие()

//--------------------------------------------------------------------------------------------------

‘ункци€ ѕроверить√руппу”словий(«нач ”слови€, «нач ќбъект, «нач “ип”слови€="»")
	
	≈сли ѕустое«начение(”слови€)	= 1				“огда	¬озврат(1)								 онец≈сли;
	≈сли ѕустое«начение(“ип”слови€) = 1				“огда	“ип”слови€ = "»"						 онец≈сли;
	
	≈сли “ип«начени€—тр(ќбъект)		= "—правочник"	“огда	ќбъект.»спользоватьƒату(‘ормƒата он, 1)	 онец≈сли;
	                                                                     
	¬ыборка”словий	=	”слови€.¬ыбрать”злы("”словие");
	ƒл€ —ч”словий = 0 ѕо ¬ыборка”словий. оличество”злов() - 1 ÷икл
		”словие		=	¬ыборка”словий.ѕолучить”зел(—ч”словий);
		–езультат	=	ѕроверить”словие(”словие, ќбъект);
		≈сли		(“ип”слови€ = "»")		»	(–езультат=0)	“огда	¬озврат(0);
		»наче≈сли	(“ип”слови€ = "»ли")	»	(–езультат=1)	“огда	¬озврат(1);
		»наче≈сли	(“ип”слови€ = "Ќе")		»	(1-–езультат=1)	“огда	¬озврат(1);
		 онец≈сли;
	 онец÷икла;
	
	¬ыборка√рупп	=	”слови€.¬ыбрать”злы("√руппа”словий");
	ƒл€ —ч√рупп = 0 ѕо ¬ыборка√рупп. оличество”злов() - 1 ÷икл
		√руппа”словий	=	¬ыборка√рупп.ѕолучить”зел(—ч√рупп);
		“ип”сл			=	√руппа”словий.ѕолучитьјтрибут("“ип”слови€");
		–езультат		=	ѕроверить√руппу”словий(√руппа”словий, ќбъект, “ип”сл);
		≈сли		(“ип”слови€ = "»")		»	(–езультат=0)	“огда	¬озврат(0);
		»наче≈сли	(“ип”слови€ = "»ли")	»	(–езультат=1)	“огда	¬озврат(1);
		»наче≈сли	(“ип”слови€ = "Ќе")		»	(1-–езультат=1)	“огда	¬озврат(1);
		 онец≈сли;
	 онец÷икла;
	
	≈сли		“ип”слови€ = "»"	“огда	¬озврат(1);
	»наче≈сли	“ип”слови€ = "»ли"	“огда	¬озврат(0);
	»наче≈сли	“ип”слови€ = "Ќе"	“огда	¬озврат(0);
	 онец≈сли;
	
 онец‘ункции

//--------------------------------------------------------------------------------------------------

‘ункци€ ”слови€¬ыполн€ютс€(«нач ”слови€, «нач ќбъект, »дѕравилаƒок="")
	
	≈сли ѕустое«начение(”слови€.ѕолучитьјтрибут("≈стьѕроцедура")) = 0 “огда
		¬озврат ƒополнительныеѕреобразовани€("”словие", ”слови€.ѕолучитьјтрибут("»д"), ќбъект, , »дѕравилаƒок);
	 онец≈сли;
	
	≈сли ѕроверить√руппу”словий(”слови€, ќбъект) = 0 “огда ¬озврат(0)  онец≈сли;	//	проверка одиночных условий
	
	¬ыборка√рупп	=	”слови€.¬ыбрать”злы("√руппа”словий");
	ƒл€ —ч√рупп = 0 ѕо ¬ыборка√рупп. оличество”злов() - 1 ÷икл
		√руппа”словий	=	¬ыборка√рупп.ѕолучить”зел(—ч√рупп);
		“ип”слови€		=	√руппа”словий.ѕолучитьјтрибут("“ип”слови€");
		≈сли ѕроверить√руппу”словий(√руппа”словий, ќбъект, “ип”слови€) = 0 “огда ¬озврат(0)  онец≈сли;
	 онец÷икла;
	
	¬озврат(1);
	
 онец‘ункции

//**************************************************************************************************
//----	 онец функций	проверки условий	--------------------------------------------------------
//**************************************************************************************************


//--------------------------------------------------------------------------------------------------

ѕроцедура «агрузитьѕараметры«агрузки(ѕравило, »д="")
                                     
	≈сли		(ѕустое«начение(»д) = 1)	» (ѕустое«начение(ѕравило) = 0)	“огда
		»д		=	ѕравило.ѕолучитьјтрибут("ѕараметры«агрузки");
	 онец≈сли;
	≈сли	ѕустое«начение(»д) = 1		“огда
		г“аб эшѕараметров«агрузки.ѕолучить—трокуѕоЌомеру(1);	//	в первой строке описаны параметры по умолчанию
		¬озврат;
	 онец≈сли;
	
	Ќом—тр	=	"";
	
	≈сли  г“аб эшѕараметров«агрузки.Ќайти«начение(»д, Ќом—тр, "»д") = 0 “огда

		ѕараметры«агрузки	=	гѕравила.¬ыбрать”зел("//ѕараметры«агрузки[@»д=""" + —окрЋѕ(»д) + """]");
		
		≈сли ѕустое«начение(ѕараметры«агрузки) = 1 “огда
			«аписатьќшибку("Ќе найдены параметры загрузки. »д = " + »д + "!", "!!");
			г“аб эшѕараметров«агрузки.ѕолучить—трокуѕоЌомеру(1);
			¬озврат;
		 онец≈сли;
		
		г“аб эшѕараметров«агрузки.Ќова€—трока();
		г“аб эшѕараметров«агрузки.»д							=	»д;
	    
		ƒата”становки											=	ƒата(ѕараметры«агрузки.ѕолучитьјтрибут("ƒата"));
		г“аб эшѕараметров«агрузки.ƒата							=	?(ѕустое«начение(ƒата”становки)=1, ‘ормƒата он, ƒата”становки);

		—пособ«агрузки											=	ѕараметры«агрузки.ѕолучитьјтрибут("—пособ«агрузки");
		г“аб эшѕараметров«агрузки.—пособ«агрузки				=	?(ѕустое«начение(—пособ«агрузки)=1, "«амещатьЌеѕустыми", —пособ«агрузки);
		
		г“аб эшѕараметров«агрузки.ѕравилоќпераций				=	ѕараметры«агрузки.ѕолучитьјтрибут("ѕравилоќпераций");
		
		г“аб эшѕараметров«агрузки.—татус”далени€				=	ѕараметры«агрузки.ѕолучитьјтрибут("—татус”далени€");
		г“аб эшѕараметров«агрузки.—татусѕроводок				=	ѕараметры«агрузки.ѕолучитьјтрибут("—татусѕроводок");
		г“аб эшѕараметров«агрузки.—татусѕроведени€				=	ѕараметры«агрузки.ѕолучитьјтрибут("—татусѕроведени€");
		г“аб эшѕараметров«агрузки.—татус–асчетныхƒокументов		=	ѕараметры«агрузки.ѕолучитьјтрибут("—татус–асчетныхƒокументов");
		
		г“аб эшѕараметров«агрузки.ƒата“екущегоѕериода∆–			=	ƒата(ѕараметры«агрузки.ѕолучитьјтрибут("ƒата“екущегоѕериода∆–"));
	
		г“аб эшѕараметров«агрузки.«амещатьЌайденные				=	„исло(ѕараметры«агрузки.ѕолучитьјтрибут("«амещатьЌайденные"));
		г“аб эшѕараметров«агрузки.ЌовыеЌе—оздавать				=	„исло(ѕараметры«агрузки.ѕолучитьјтрибут("ЌовыеЌе—оздавать"));
		
		г“аб эшѕараметров«агрузки.«агружатьќперации				=	„исло(ѕараметры«агрузки.ѕолучитьјтрибут("«агружатьќперации"));
		г“аб эшѕараметров«агрузки.«агружать«аписи∆–				=	„исло(ѕараметры«агрузки.ѕолучитьјтрибут("«агружать«аписи∆–"));
		                            	
	»наче
		
		г“аб эшѕараметров«агрузки.ѕолучить—трокуѕоЌомеру(Ќом—тр);
		
	 онец≈сли;
	
 онецѕроцедуры		//	«агрузитьѕараметры«агрузки()

//--------------------------------------------------------------------------------------------------

ѕроцедура «агрузитьѕравило–еквизитов(ѕравило, “аб)
                                       
	“аб.Ќова€—трока();
	
	»сточник					=	ѕравило.¬ыбрать”зел("»сточник");
	ѕриемник					=	ѕравило.¬ыбрать”зел("ѕриемник");
	
	“аб.»д						=	ѕравило.ѕолучитьјтрибут("»д");
	“аб.ѕреобразование			=	ѕравило.ѕолучитьјтрибут("ѕреобразование");
	“аб.ѕравило					=	ѕравило.ѕолучитьјтрибут("ѕравило");
	“аб.≈стьѕроцедура			=	ѕравило.ѕолучитьјтрибут("≈стьѕроцедура");
	“аб.ѕараметрыѕравила		=	ѕравило.ѕолучитьјтрибут("ѕараметрыѕравила");
	“аб.ѕолучить»зѕараметров	=	ѕравило.ѕолучитьјтрибут("ѕолучить»зѕараметров");
	“аб.—пособ¬ыгрузки			=	ѕравило.ѕолучитьјтрибут("—пособ¬ыгрузки");
	“аб.—пособ«агрузки			=	ѕравило.ѕолучитьјтрибут("—пособ«агрузки");
	
	”слови€						=	ѕравило.¬ыбрать”зел("”слови€");
	
	≈сли ѕустое«начение(»сточник) = 0 “огда
		“аб.»сточник_»д				=	»сточник.ѕолучитьјтрибут("»д");
		“аб.»сточник_“ипјтрибута	=	»сточник.ѕолучитьјтрибут("“ипјтрибута");
		“аб.»сточник_“ип			=	»сточник.ѕолучитьјтрибут("“ип");
		“аб.»сточник_¬ид			=	»сточник.ѕолучитьјтрибут("¬ид");
		//“аб.»сточник_ƒлина		=	»сточник.ѕолучитьјтрибут("ƒлина");
	 онец≈сли;

	≈сли ѕустое«начение(ѕриемник) = 0 “огда
		“аб.ѕриемник_»д				=	ѕриемник.ѕолучитьјтрибут("»д");
		“аб.ѕриемник_“ипјтрибута	=	ѕриемник.ѕолучитьјтрибут("“ипјтрибута");
		“аб.ѕриемник_“ип			=	ѕриемник.ѕолучитьјтрибут("“ип");
		“аб.ѕриемник_¬ид			=	ѕриемник.ѕолучитьјтрибут("¬ид");
		“аб.ѕриемник_ƒлина			=	ѕриемник.ѕолучитьјтрибут("ƒлина");
	 онец≈сли;
	
	≈сли ѕустое«начение(”слови€) = 0 “огда
		“аб.”слови€	=	”слови€;
		≈сли (ѕустое«начение(”слови€.ѕолучитьјтрибут("«аданыѕо–еквизиту")) = 1) » (“аб.»сточник_“ипјтрибута <> " ") » (“аб.»сточник_“ипјтрибута <> "ѕ ") “огда
			“аб.¬ид”слови€	=	1;
		»наче
			“аб.¬ид”слови€	=	2;
		 онец≈сли;
	 онец≈сли;
	
 онецѕроцедуры		//	«агрузитьѕравило–еквизитов()

//--------------------------------------------------------------------------------------------------

ѕроцедура «агрузитьѕравило–еквизитов«начени€(ѕравило, »д="")
                                       
	≈сли		(ѕустое«начение(»д) = 1)	» (ѕустое«начение(ѕравило) = 0)	“огда
		»д		=	ѕравило.ѕолучитьјтрибут("»д");
	»наче≈сли	ѕустое«начение(»д) = 1		“огда
		¬озврат;
	 онец≈сли;
	
	Ќом—тр	=	"";
	
	≈сли  г“аб эш–еквизитов«начений.Ќайти«начение(»д, Ќом—тр, "»д") = 0 “огда
		                    
		г“аб эш–еквизитов«начений.Ќова€—трока();
		
		»сточник										=	ѕравило.¬ыбрать”зел("»сточник");
		ѕриемник										=	ѕравило.¬ыбрать”зел("ѕриемник");
		
		г“аб эш–еквизитов«начений.»д					=	»д;
		г“аб эш–еквизитов«начений.ѕреобразование		=	ѕравило.ѕолучитьјтрибут("ѕреобразование");
		г“аб эш–еквизитов«начений.ѕравило				=	ѕравило.ѕолучитьјтрибут("ѕравило");
		г“аб эш–еквизитов«начений.≈стьѕроцедура			=	ѕравило.ѕолучитьјтрибут("≈стьѕроцедура");
		г“аб эш–еквизитов«начений.ѕараметрыѕравила		=	ѕравило.ѕолучитьјтрибут("ѕараметрыѕравила");
		
		
		”слови€											=	ѕравило.¬ыбрать”зел("”слови€");
		≈сли ѕустое«начение(”слови€) = 0 “огда
			г“аб эш–еквизитов«начений.”слови€		=	”слови€;
			г“аб эш–еквизитов«начений.¬ид”слови€	=	1;
			//≈сли ѕустое«начение(”слови€.ѕолучитьјтрибут("«аданыѕо–еквизиту")) = 1 “огда
			//	г“аб эш–еквизитов«начений.¬ид”слови€	=	1;
			//»наче
			//	г“аб эш–еквизитов«начений.¬ид”слови€	=	2;
			// онец≈сли;
		 онец≈сли;
		
		
		≈сли ѕустое«начение(»сточник) = 0 “огда
			г“аб эш–еквизитов«начений.»сточник_»д		=	»сточник.ѕолучитьјтрибут("»д");
			г“аб эш–еквизитов«начений.»сточник_“ип		=	»сточник.ѕолучитьјтрибут("“ип");
			г“аб эш–еквизитов«начений.»сточник_¬ид		=	»сточник.ѕолучитьјтрибут("¬ид");
		 онец≈сли;
	
		≈сли ѕустое«начение(ѕриемник) = 0 “огда
			г“аб эш–еквизитов«начений.ѕриемник_»д		=	ѕриемник.ѕолучитьјтрибут("»д");
			г“аб эш–еквизитов«начений.ѕриемник_“ип		=	ѕриемник.ѕолучитьјтрибут("“ип");
			г“аб эш–еквизитов«начений.ѕриемник_¬ид		=	ѕриемник.ѕолучитьјтрибут("¬ид");
			г“аб эш–еквизитов«начений.ѕриемник_ƒлина	=	ѕриемник.ѕолучитьјтрибут("ƒлина");
		 онец≈сли;
		
	»наче
		
		г“аб эш–еквизитов«начений.ѕолучить—трокуѕоЌомеру(Ќом—тр);

	 онец≈сли;
										
 онецѕроцедуры		//	«агрузитьѕравило–еквизитов«начени€()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ —истемноеѕредставлениеќбъекта(»сточник)
    
	//	Ќеобходимо позиционироватьс€ на объекты, т.к.
	//	если »сточник - реквизит неопределенного типа,
	//	то «начение¬—троку¬нутр - возвращает Ќ≈—“јЌƒј–“Ќќ≈
	//	строковое представление !!!
	
	“ип	=	“ип«начени€—тр(»сточник);
	
	≈сли		—окрЋѕ(»сточник) = "<ќбъект не найден>" “огда
		
		¬озврат("");	//	ќбъект не существует в »Ѕ
		
	»наче≈сли	“ип = "—правочник"	“огда
		
		ќб = —оздатьќбъект("—правочник." + »сточник.¬ид());
		ќб.ЌайтиЁлемент(»сточник);
		¬озврат	«начение¬—троку¬нутр(ќб.“екущийЁлемент());
		
	»наче≈сли	“ип = "ƒокумент"	“огда
		
		ќб = —оздатьќбъект("ƒокумент." + »сточник.¬ид());
		ќб.Ќайтиƒокумент(»сточник);
		¬озврат	«начение¬—троку¬нутр(ќб.“екущийƒокумент());
		
	»наче
		
		ќб	=	»сточник;
		¬озврат	«начение¬—троку¬нутр(ќб);
		
	 онец≈сли;
	
 онец‘ункции		//	—истемноеѕредставлениеќбъекта()

//--------------------------------------------------------------------------------------------------

‘ункци€ —оздать”зел—сылки(»сточник, “аб–еквизитовѕоиска, ѕараметрыѕравила)
	
	//≈сли “аб–еквизитовѕоиска. оличество—трок() = 0 “огда
	//	¬озврат(1);
	// онец≈сли;
    
	
	XML_DOM					=	гXMLјнализатор.—оздатьƒокумент();
	”зел—сылки				=	XML_DOM.—оздать”зел(1, "—сылка");
	     
	“ип»сточника			=	“ип«начени€—тр(»сточник);
	
    ≈сли (“ип»сточника = "—правочник") »ли (“ип»сточника = "—чет") “огда
		Ёто√руппа	=	»сточник.Ёто√руппа();
		”становитьјтрибут(”зел—сылки,	"Ёто√руппа",	Ёто√руппа);
     онец≈сли;
	
	≈сли “аб–еквизитовѕоиска. оличество—трок() > 0 “огда
		“аб–еквизитовѕоиска.¬ыбрать—троки();
		ѕока “аб–еквизитовѕоиска.ѕолучить—троку() = 1 ÷икл
			–езультат	=	ƒобавить–еквизит(“аб–еквизитовѕоиска, »сточник, ”зел—сылки, "#ѕолучить", "ѕоиск", ѕараметрыѕравила);
			≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
		 онец÷икла;
	»наче
		”становитьјтрибут(”зел—сылки, "—истемный»д", ”зел—сылки.ѕреобразовать¬_»ƒ(—истемноеѕредставлениеќбъекта(»сточник)));
	 онец≈сли;
	
	¬озврат(”зел—сылки);
	
 онец‘ункции	//	—оздать”зел—сылки()
                        
//--------------------------------------------------------------------------------------------------

‘ункци€ ќбъект”же¬ыгружен(»сточник, “аб–еквизитовѕоиска, »дѕравила, ”зел—сылки, –ежим=0, ѕараметрыѕравила="", ЌовыеЌе—оздавать=0, Ќе—инхронизироватьѕоƒопѕараметрам=0)
	
	ѕерем	Ќом—тр;
	
	
	≈сли (‘орм‘л«апоминать—сылки = 0) » (–ежим <> "ѕроведение") “огда
		”зел—сылки	=	—оздать”зел—сылки(»сточник, “аб–еквизитовѕоиска, ѕараметрыѕравила);
		≈сли ЌовыеЌе—оздавать = 1 “огда ¬озврат(1)  онец≈сли;	//	в данном случае нам нужна только ссылка
	 онец≈сли;
	
	
	//—писок¬ыгруженныхќбъектов = —писок—писков¬ыгруженныхќбъектов.ѕолучить(»дѕравила);

	≈сли “аб¬ыгруженныхќбъектов.Ќайти«начение(»дѕравила, Ќом—тр, "»дѕравила") = 0 “огда
		≈сли –ежим = "ѕроведение" “огда ¬озврат(0)  онец≈сли;
		“аб¬ыгруженныхќбъектов.Ќова€—трока();
		“аб¬ыгруженныхќбъектов.»дѕравила	=	»дѕравила;
		“аб¬ыгруженныхќбъектов.“абќбъектов	=	—оздатьќбъект("“аблица«начений");
		“абќбъектов							=	“аб¬ыгруженныхќбъектов.“абќбъектов;
		“абќбъектов.Ќова€ олонка("ќбъект");
		≈сли ‘орм‘л«апоминать—сылки = 1 “огда
			“абќбъектов.Ќова€ олонка("—сылка",	"—трока");
		 онец≈сли;
	»наче
		“абќбъектов							=	“аб¬ыгруженныхќбъектов.ѕолучить«начение(Ќом—тр, "“абќбъектов");
	 онец≈сли;
	
	//≈сли “ип«начени€—тр(—писок¬ыгруженныхќбъектов) <> "—писок«начений" “огда
	//	≈сли –ежим = "ѕроведение" “огда ¬озврат(0)  онец≈сли;
	//	—писок¬ыгруженныхќбъектов = —оздатьќбъект("—писок«начений");
	//	—писок—писков¬ыгруженныхќбъектов.”становить(»дѕравила, —писок¬ыгруженныхќбъектов);
	// онец≈сли;
                                                       
	
	≈сли ѕустое«начение(—окрЋѕ(»сточник)) = 1 “огда
		—истѕредставление = »дѕравила + ?(ѕустое«начение(ѕараметрыѕравила)=0, «начение¬—троку¬нутр(ѕараметрыѕравила), "");
	»наче
		≈сли (ѕустое«начение(ѕараметрыѕравила)=0) » (Ќе—инхронизироватьѕоƒопѕараметрам=0) “огда
			
			//“ип	=	“ип«начени€—тр(»сточник);
			//≈сли		—окрЋѕ(»сточник) = "<ќбъект не найден>" “огда
			//	//	ќбъект не существует в »Ѕ
			//	ќб					=	»сточник;
			//	—истѕредставление	=	"";
			//»наче≈сли	“ип = "—правочник"	“огда
			//	ќб = —оздатьќбъект("—правочник." + »сточник.¬ид());
			//	ќб.ЌайтиЁлемент(»сточник);
			//	—истѕредставление	=	«начение¬—троку¬нутр(ќб.“екущийЁлемент());
			//»наче≈сли	“ип = "ƒокумент"	“огда
			//	ќб = —оздатьќбъект("ƒокумент");
			//	ќб.Ќайтиƒокумент(»сточник);
			//	—истѕредставление	=	«начение¬—троку¬нутр(ќб.“екущийƒокумент());
			//»наче
			//	ќб					=	»сточник;
			//	—истѕредставление	=	«начение¬—троку¬нутр(ќб);
			// онец≈сли;
			//—истѕредставление		=	—истѕредставление + «начение¬—троку¬нутр(ѕараметрыѕравила);
			                                                                                       
			—истѕредставление		=	—истемноеѕредставлениеќбъекта(»сточник) + «начение¬—троку¬нутр(ѕараметрыѕравила);
			
		»наче
			—истѕредставление	=	»сточник;
		 онец≈сли;
	 онец≈сли;
                            
    //–езультат			=	—писок¬ыгруженныхќбъектов.ѕолучить(—истѕредставление);
	                       
	Ќом—тр = "";
	≈сли “абќбъектов.Ќайти«начение(—истѕредставление, Ќом—тр, "ќбъект") = 0 “огда
		
	//≈сли	ѕустое«начение(–езультат) = 1	“огда
		
		≈сли –ежим = "ѕроведение" “огда ¬озврат(0)  онец≈сли;
		
		“абќбъектов.Ќова€—трока();
		“абќбъектов.ќбъект = —истѕредставление;
		
		≈сли ‘орм‘л«апоминать—сылки = 1 “огда
			ЌомерЌовой—троки		=	“абќбъектов.Ќомер—троки;	//	при создании ссылки таблица может перепозиционироватьс€
			”зел—сылки				=	—оздать”зел—сылки(»сточник, “аб–еквизитовѕоиска, ѕараметрыѕравила);
			≈сли ”зел—сылки <> 1 “огда
				//“абќбъектов.—сылка	=	”зел—сылки.ѕредставлениеXML;
				“абќбъектов.”становить«начение(ЌомерЌовой—троки, "—сылка", ”зел—сылки.ѕредставлениеXML);
			 онец≈сли;
		 онец≈сли;
		
		//—писок¬ыгруженныхќбъектов.”становить(—истѕредставление, «начение”становки);
		
		≈сли ЌовыеЌе—оздавать = 1 “огда ¬озврат(1)  онец≈сли;	//	в данном случае нам нужна только ссылка
		
		¬озврат(0);
		
	»наче≈сли	‘орм‘л«апоминать—сылки = 1	“огда
		                            
		—тр—сылка	=	“абќбъектов.ѕолучить«начение(Ќом—тр, "—сылка");
		≈сли ѕустое«начение(—тр—сылка) = 0 “огда
			XML_DOM		=	гXMLјнализатор.—оздатьƒокумент();
			XML_DOM.«агрузить»з—троки(—тр—сылка);
			”зел—сылки	=	XML_DOM.¬ыбрать”зел("—сылка");
		 онец≈сли;
		
	»наче
	    
		≈сли –ежим = "ѕроведение" “огда
			”зел—сылки = —оздать”зел—сылки(»сточник, “аб–еквизитовѕоиска, ѕараметрыѕравила);
		 онец≈сли;
		
	 онец≈сли;
	    
	¬озврат(1);
	
 онец‘ункции		//	ќбъект”же¬ыгружен()

//--------------------------------------------------------------------------------------------------

ѕроцедура «аписатьќбъект¬‘айл(XML_DOM);
    
	г—четчик¬ыгруженныхќбъектов	=	г—четчик¬ыгруженныхќбъектов + 1;
	
	XML_DOM.”становитьјтрибут("Ќпп", г—четчик¬ыгруженныхќбъектов);
	
    г‘айлƒанных.¬ключитьЁлемент(XML_DOM);
	                                   
	
	≈сли г—четчик¬ыгруженныхќбъектов % ‘орм олвоЅуферизуемыхќбъектов = 0 “огда
		г‘айлƒанных.—бросить();
	 онец≈сли;
	
	≈сли г—четчик¬ыгруженныхќбъектов % 10 = 0 “огда	—осто€ние("¬ыгружено объектов:    " + г—четчик¬ыгруженныхќбъектов)  онец≈сли;
	
 онецѕроцедуры

//--------------------------------------------------------------------------------------------------

‘ункци€ ѕометка”далени€(»сточник, —татус”далени€)
                                
	≈сли ѕустое«начение(»сточник) = 1 “огда ¬озврат(0)  онец≈сли;
	
	≈сли		—татус”далени€	= "јвто"			“огда
		
		¬озврат(»сточник.ѕометка”далени€());
		
	//»наче≈сли —татус”далени€	= "ѕометить"		“огда	// это можно прочитать из правил...
	//»наче≈сли —татус”далени€	= "—н€тьѕометку"	“огда
	
	 онец≈сли;
	
	¬озврат(0);
	
 онец‘ункции		//	ѕометка”далени€()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ¬ыключитьѕроводки(»сточник, —татусѕроводок)
	
	≈сли		—татусѕроводок	= "јвто"			“огда	//	на бух. учет и —уществуетќпераци€() проверили раньше
		 
		¬озврат(1 - »сточник.ќпераци€.¬ключитьѕроводки());
		
	//»наче≈сли —татус”далени€	= "¬ключить "		“огда	// это можно прочитать из правил...
	//»наче≈сли —татус”далени€	= "¬ыключить "		“огда
	
	 онец≈сли;
	
	¬озврат(0);

 онец‘ункции

//--------------------------------------------------------------------------------------------------

‘ункци€ ќтменитьѕроведение(»сточник, —татусѕроведени€);
	
	≈сли		—татусѕроведени€	= "јвто"				“огда
		
		≈сли »сточник.ѕометка”далени€() = 1 “огда ¬озврат(0)  онец≈сли;
		
		≈сли ћетаданные.ƒокумент(»сточник.¬ид()).–азрешитьѕроведение = 0 “огда
			¬озврат(0);
		 онец≈сли;
		 
		¬озврат( 1 - »сточник.ѕроведен() );
		
	//»наче≈сли —татусѕроведени€	= "ѕровести"			“огда	// это можно прочитать из правил...
	//»наче≈сли —татусѕроведени€	= "ќтменитьѕроведение"	“огда
	
	 онец≈сли;
	
	¬озврат(0);
	
 онец‘ункции		//	ќтменитьѕроведение()

//--------------------------------------------------------------------------------------------------

‘ункци€ Ќужноѕровести(»сточник, —татусѕроведени€)
	                                             
	//≈сли »сточник.ѕометка”далени€() = 1 “огда ¬озврат(0)  онец≈сли;
	
	≈сли		—татусѕроведени€	= "јвто"			“огда
		     
		¬идƒокумента	=	»сточник.¬ид();
		
		≈сли		¬идƒокумента = "ќпераци€" “огда
			¬озврат(1);
		»наче≈сли	ћетаданные.ƒокумент(¬идƒокумента).–азрешитьѕроведение = 0 “огда
			¬озврат(0);
		 онец≈сли;
		 
		¬озврат( »сточник.ѕроведен() );
		
	»наче≈сли —татусѕроведени€	= "ѕровести"			“огда
		
		¬озврат(1);
		
	»наче≈сли —татусѕроведени€	= "ќтменитьѕроведение"	“огда
	
	 онец≈сли;
	
	¬озврат(0);

 онец‘ункции		//	Ќужноѕровести()
                      
//--------------------------------------------------------------------------------------------------

ѕроцедура «агрузитьѕравило(ѕравило, »д="")
                                       
	≈сли		(ѕустое«начение(»д) = 1)	» (ѕустое«начение(ѕравило) = 0)	“огда
		»д		=	ѕравило.ѕолучитьјтрибут("»д");
	»наче≈сли	ѕустое«начение(»д) = 1		“огда
		¬озврат;
	 онец≈сли;
	
	Ќом—тр	=	"";
	
	≈сли  г“аб эшѕравил.Ќайти«начение(»д, Ќом—тр, "»д") = 0 “огда
		
		≈сли		ѕустое«начение(ѕравило) = 1	“огда
			ѕравило	=	гѕравила.¬ыбрать”зел("//ѕравило[@»д=""" + »д + """]");
		 онец≈сли;
		
		»сточник									=	ѕравило.¬ыбрать”зел("ќбъект»сточник");
		ѕриемник									=	ѕравило.¬ыбрать”зел("ќбъектѕриемник");
		
		г“аб эшѕравил.Ќова€—трока();
		г“аб эшѕравил.»д							=	»д;
		г“аб эшѕравил.ѕравило						=	ѕравило;
		г“аб эшѕравил.ѕо—сылкам						=	„исло(ѕравило.ѕолучитьјтрибут("ѕо—сылкам"));
		г“аб эшѕравил.ѕреобразование				=	ѕравило.ѕолучитьјтрибут("ѕреобразование");
		г“аб эшѕравил.ѕравилоѕереадресации			=	ѕравило.ѕолучитьјтрибут("ѕравило");
		г“аб эшѕравил.ѕараметры«агрузки				=	ѕравило.ѕолучитьјтрибут("ѕараметры«агрузки");
		г“аб эшѕравил.»д—инхронизирующего–еквизита	=	ѕравило.ѕолучитьјтрибут("»д—инхронизирующего–еквизита");
		
		”слови€										=	ѕравило.¬ыбрать”зел("”слови€");
		≈сли ѕустое«начение(”слови€) = 0 “огда
			г“аб эшѕравил.”слови€		=	”слови€;
			г“аб эшѕравил.¬ид”слови€	=	1;
		 онец≈сли;
		                            	
		≈сли ѕустое«начение(»сточник) = 0 “огда
			г“аб эшѕравил.»сточник_“ип				=	»сточник.ѕолучитьјтрибут("“ип");
			г“аб эшѕравил.»сточник_¬ид				=	»сточник.ѕолучитьјтрибут("¬ид");
		 онец≈сли;
	
		≈сли ѕустое«начение(ѕриемник) = 0 “огда
			г“аб эшѕравил.ѕриемник_“ип				=	ѕриемник.ѕолучитьјтрибут("“ип");
			г“аб эшѕравил.ѕриемник_¬ид				=	ѕриемник.ѕолучитьјтрибут("¬ид");
			≈сли г“аб эшѕравил.ѕриемник_“ип = "∆урнал–асчетов" “огда
				г“аб эшѕравил.”никальность			=	ѕриемник.ѕолучитьјтрибут("”никальность");
				г“аб эшѕравил.ƒатаќтсчета			=	ѕриемник.ѕолучитьјтрибут("ƒатаќтсчета");
			 онец≈сли;
		 онец≈сли;
		
		ѕриемник_“ип								=	г“аб эшѕравил.ѕриемник_“ип;
		»сточник_“ип								=	г“аб эшѕравил.»сточник_“ип;
		//≈сли ѕустое«начение(ѕриемник_“ип) = 1 “огда ¬озврат  онец≈сли;
		
		//-------------------------------------------
		
		г“аб эшѕравил.“аб–еквизитовѕоиска			=	—оздатьќбъект("“аблица«начений");
		г“аб эшѕравил.“аб–еквизитов					=	—оздатьќбъект("“аблица«начений");
		г“аб эшѕравил.“аб–еквизитов—трок			=	—оздатьќбъект("“аблица«начений");
		
		–еквизиты = ѕравило.¬ыбрать”злы("–еквизит[@—пособ«агрузки=""ѕоиск""]");
		≈сли ѕустое«начение(–еквизиты. оличество”злов()) = 0 “огда
			г“аб эшѕравил.“аб–еквизитовѕоиска.«агрузить(г“аб эш–еквизитов);
			ƒл€ —ч–еквизитов = 0 ѕо –еквизиты. оличество”злов() - 1 ÷икл
				«агрузитьѕравило–еквизитов(–еквизиты.ѕолучить”зел(—ч–еквизитов), г“аб эшѕравил.“аб–еквизитовѕоиска);
			 онец÷икла;
		 онец≈сли;
		
		≈сли		ѕриемник_“ип = "—правочник"	“огда
        	«апрос	=	"–еквизит[(@—пособ«агрузки != ""ѕоиск"") or (not(@—пособ«агрузки))]";
		»наче≈сли	ѕриемник_“ип = "ƒокумент"	“огда
			«апрос	=	"–еквизит[( (@—пособ«агрузки != ""ѕоиск"") or (not(@—пособ«агрузки)) ) and ( (ѕриемник/@“ипјтрибута != ""–“ƒ"") or (not(ѕриемник)) ) and ( (@—пособ¬ыгрузки != ""ѕеребрать—трокиƒокумента"") or (not(—пособ¬ыгрузки)) )]";
		»наче≈сли	ѕриемник_“ип = "ќпераци€"	“огда
			«апрос	=	"–еквизит[ (ѕриемник/@“ипјтрибута = ""јќ"") or (ѕриемник/@“ипјтрибута = ""–ќ"") ]";
		»наче≈сли	(ѕустое«начение(ѕриемник_“ип) = 1) » (»сточник_“ип = "ƒокумент")	“огда
			«апрос	=	"–еквизит[(@—пособ¬ыгрузки != ""ѕеребрать—трокиƒокумента"")]";
		»наче
			«апрос	=	"–еквизит";
		 онец≈сли;
		
		–еквизиты = ѕравило.¬ыбрать”злы(«апрос);
		≈сли ѕустое«начение(–еквизиты. оличество”злов()) = 0 “огда
			г“аб эшѕравил.“аб–еквизитов.«агрузить(г“аб эш–еквизитов);
			ƒл€ —ч–еквизитов = 0 ѕо –еквизиты. оличество”злов() - 1 ÷икл
				«агрузитьѕравило–еквизитов(–еквизиты.ѕолучить”зел(—ч–еквизитов), г“аб эшѕравил.“аб–еквизитов);
			 онец÷икла;
		 онец≈сли;
		
		≈сли		ѕриемник_“ип = "ƒокумент"	“огда
			«апрос	=	"–еквизит[( (@—пособ«агрузки != ""ѕоиск"") or (not(@—пособ«агрузки)) ) and ( (ѕриемник/@“ипјтрибута = ""–“ƒ"") or (@—пособ¬ыгрузки = ""ѕеребрать—трокиƒокумента"") )]";
		»наче≈сли	ѕриемник_“ип = "ќпераци€"	“огда
			//«апрос	=	"–еквизит[ (ѕриемник/@“ипјтрибута != ""јќ"") and (ѕриемник/@“ипјтрибута != ""–ќ"") ]";
			«апрос	=	"–еквизит[( (ѕриемник/@“ипјтрибута != ""јќ"") and (ѕриемник/@“ипјтрибута != ""–ќ"") ) or (@—пособ¬ыгрузки = ""ѕеребрать—трокиƒокумента"")]";
		»наче≈сли	(ѕустое«начение(ѕриемник_“ип) = 1) » (»сточник_“ип = "ƒокумент")	“огда
			«апрос	=	"–еквизит[(@—пособ¬ыгрузки = ""ѕеребрать—трокиƒокумента"")]";
		»наче
			«апрос	=	"";
		 онец≈сли;
		
		≈сли «апрос <> "" “огда
			–еквизиты	=	ѕравило.¬ыбрать”злы(«апрос);
			≈сли ѕустое«начение(–еквизиты. оличество”злов()) = 0 “огда
				г“аб эшѕравил.“аб–еквизитов—трок.«агрузить(г“аб эш–еквизитов);
				ƒл€ —ч–еквизитов = 0 ѕо –еквизиты. оличество”злов() - 1 ÷икл
					«агрузитьѕравило–еквизитов(–еквизиты.ѕолучить”зел(—ч–еквизитов), г“аб эшѕравил.“аб–еквизитов—трок);
				 онец÷икла;
			 онец≈сли;
		 онец≈сли;
		
	»наче
		
		г“аб эшѕравил.ѕолучить—трокуѕоЌомеру(Ќом—тр);
		≈сли		ѕустое«начение(ѕравило) = 1	“огда
			ѕравило	=	г“аб эшѕравил.ѕравило;			//  нужно дл€ поиска значений и др.
		 онец≈сли;
		
	 онец≈сли;
	
 онецѕроцедуры		//	«агрузитьѕравило()

//--------------------------------------------------------------------------------------------------

‘ункци€ Ќайтиѕравило(»сточник, ѕравило="", »дѕравила="", “ипѕриемника="", ¬идѕриемника="", »дѕравилаƒок="")
	          
	«агрузитьѕравило(ѕравило, »дѕравила);
	
	≈сли ѕустое«начение(ѕравило) = 0 “огда
		≈сли г“аб эшѕравил.¬ид”слови€ = 1 “огда	//	т.е. условие задано
			≈сли ”слови€¬ыполн€ютс€(г“аб эшѕравил.”слови€, »сточник, »дѕравилаƒок) = 0 “огда ¬озврат(0)  онец≈сли;
		 онец≈сли;
		¬озврат(1);
	 онец≈сли;
	
	¬ид				=	"";
	«апрос			=	"";
	
	“ип				=	“ип«начени€—тр(»сточник);
	
	
	≈сли	ѕустое«начение(“ип) = 1									“огда ¬озврат(0)  онец≈сли;
	≈сли	(“ип = "—трока") » (“ипѕриемника = "Ќеопределенный")	“огда ¬озврат(0)  онец≈сли;
	
	
	«апрос			=	«апрос + "//ѕравило[(ќбъект»сточник/@“ип = """ + “ип + """)";
	
	≈сли (Ќайти("—трока,„исло,ƒата,ќпераци€, алендарь,¬ид—убконто,¬ид–асчета", “ип) = 0) » (“ип <> "ѕлан—четов") “огда
		¬ид			=	»сточник.¬ид();
		«апрос		=	«апрос + "and(ќбъект»сточник/@¬ид = """ + ¬ид + """)";
	 онец≈сли;
	
	≈сли (ѕустое«начение(“ипѕриемника) = 0) » (“ипѕриемника <> "Ќеопределенный") “огда
		«апрос		=	«апрос + "and(ќбъектѕриемник/@“ип = """ + “ипѕриемника + """)";
		≈сли ѕустое«начение(¬идѕриемника) = 0 “огда
			«апрос	=	«апрос + "and(ќбъектѕриемник/@¬ид = """ + ¬идѕриемника + """)";
		 онец≈сли;
	 онец≈сли;
	
	«апрос			=	«апрос + "]";
	                     
	¬ыборкаѕравил	=	гѕравила.¬ыбрать”злы(«апрос);
	ƒл€ —ч = 0 ѕо ¬ыборкаѕравил. оличество”злов() - 1 ÷икл
		¬ыбѕравило	=	¬ыборкаѕравил.ѕолучить”зел(—ч);
		»дѕравила	=	"";
		«агрузитьѕравило(¬ыбѕравило, »дѕравила);
		≈сли г“аб эшѕравил.¬ид”слови€ = 1 “огда	//	т.е. условие задано
			≈сли ”слови€¬ыполн€ютс€(г“аб эшѕравил.”слови€, »сточник, »дѕравилаƒок) = 1 “огда
				ѕравило	=	¬ыбѕравило;
				¬озврат(1);
			 онец≈сли;
		»наче
			ѕравило	=	¬ыбѕравило;
			¬озврат(1);
		 онец≈сли;
	 онец÷икла;
		       
	
	≈сли “ип <> "∆урнал–асчетов" “огда
		«аписатьќшибку("Ќе найдено правило конвертации объекта: " + “ип + "." + ¬ид + " - " + »сточник, "!!");
	 онец≈сли;
	
	
	¬озврат(0);
	
 онец‘ункции		//	Ќайтиѕравило()
            
//--------------------------------------------------------------------------------------------------

‘ункци€ Ќайтиѕравилоƒл€јтрибута«начени€(«нач »сточник, ѕравило="", »дѕравила="", ѕравилојтрибута«начени€="")
	              
	≈сли (ѕустое«начение(»дѕравила) = 1) » (ѕустое«начение(ѕравилојтрибута«начени€) = 0) “огда
		»дѕравила	=	ѕравилојтрибута«начени€.ѕолучитьјтрибут("ѕравило");
	 онец≈сли;
	
	«агрузитьѕравило(ѕравило, »дѕравила);
	
	≈сли ѕустое«начение(ѕравило) = 0 “огда
		≈сли г“аб эшѕравил.¬ид”слови€ = 1 “огда	//	т.е. условие задано
			≈сли ”слови€¬ыполн€ютс€(г“аб эшѕравил.”слови€, »сточник) = 0 “огда ¬озврат(0)  онец≈сли;
		 онец≈сли;
		¬озврат(1);
	 онец≈сли;
	
	≈сли ѕустое«начение(ѕравилојтрибута«начени€) = 1 “огда ¬озврат(0)  онец≈сли;
	
	«апрос				=	"";
	»сточник_“ип		=	"";
	»сточник_¬ид		=	"";
	ѕриемник_“ип		=	"";
	ѕриемник_¬ид		=	"";
	
	”зел»сточник		=	ѕравилојтрибута«начени€.¬ыбрать”зел("»сточник");
	”зелѕриемник		=	ѕравилојтрибута«начени€.¬ыбрать”зел("ѕриемник");
	
	≈сли ѕустое«начение(”зел»сточник) = 0 “огда
		»сточник_“ип	=	”зел»сточник.ѕолучитьјтрибут("“ип");
		»сточник_¬ид	=	”зел»сточник.ѕолучитьјтрибут("¬ид");
	 онец≈сли;

	≈сли ѕустое«начение(”зелѕриемник) = 0 “огда
		ѕриемник_“ип	=	”зелѕриемник.ѕолучитьјтрибут("“ип");
		ѕриемник_¬ид	=	”зелѕриемник.ѕолучитьјтрибут("¬ид");
	 онец≈сли;
	            
	≈сли ѕустое«начение(ѕриемник_“ип) = 1 “огда ¬озврат(0)								 онец≈сли;
	≈сли ѕустое«начение(»сточник_“ип) = 1 “огда »сточник_“ип = “ип«начени€—тр(»сточник)	 онец≈сли;
	≈сли ѕустое«начение(»сточник_“ип) = 1 “огда ¬озврат(0) 								 онец≈сли;

	«апрос			=	«апрос + "//ѕравило[(ќбъект»сточник/@“ип = """ + »сточник_“ип + """)";
	
	≈сли Ќайти("—трока,„исло,ƒата,ќпераци€", »сточник_“ип) = 0 “огда
		≈сли ѕустое«начение(»сточник_¬ид) = 1 “огда »сточник_¬ид = »сточник.¬ид()  онец≈сли;
		«апрос		=	«апрос + "and(ќбъект»сточник/@¬ид = """ + »сточник_¬ид + """)";
	 онец≈сли;
	
	«апрос			=	«апрос + "and(ќбъектѕриемник/@“ип = """ + ѕриемник_“ип + """)";
	
	≈сли Ќайти("—трока,„исло,ƒата,ќпераци€", ѕриемник_“ип) = 0 “огда
		≈сли ѕустое«начение(ѕриемник_¬ид) = 1 “огда ѕриемник_¬ид = »сточник_¬ид  онец≈сли;
		«апрос		=	«апрос + "and(ќбъектѕриемник/@¬ид = """ + ѕриемник_¬ид + """)";
	 онец≈сли;
	
	«апрос			=	«апрос + "]";
	                     
	¬ыборкаѕравил	=	гѕравила.¬ыбрать”злы(«апрос);
	ƒл€ —ч = 0 ѕо ¬ыборкаѕравил. оличество”злов() - 1 ÷икл
		¬ыбѕравило	=	¬ыборкаѕравил.ѕолучить”зел(—ч);
		»дѕравила	=	"";
		«агрузитьѕравило(¬ыбѕравило, »дѕравила);
		≈сли г“аб эшѕравил.¬ид”слови€ = 1 “огда	//	т.е. условие задано
			≈сли ”слови€¬ыполн€ютс€(г“аб эшѕравил.”слови€, »сточник) = 1 “огда
				ѕравило	=	¬ыбѕравило;
				¬озврат(1);
			 онец≈сли;
		»наче
			ѕравило	=	¬ыбѕравило;
			¬озврат(1);
		 онец≈сли;
	 онец÷икла;
		
	«аписатьќшибку("Ќе найдено правило конвертации атрибута значени€: " + ѕравилојтрибута«начени€.ѕолучитьјтрибут("»м€") + " - " + »сточник_“ип + "." + »сточник_¬ид + " - " + »сточник, "!!");
	¬озврат(0);
	
 онец‘ункции		//	Ќайтиѕравилоƒл€јтрибута«начени€()

//--------------------------------------------------------------------------------------------------

‘ункци€ ѕолучить«начениећетодом(»сточник, ћетод)
                                        
	≈сли ѕустое«начение(—окрЋѕ(»сточник)) = 1 “огда ¬озврат("")  онец≈сли;
	    
	≈сли		ћетод = "«начение()"				“огда
		¬озврат		»сточник;
	»наче≈сли	ћетод = "¬ид()"						“огда
		¬озврат		»сточник.¬ид();
	»наче≈сли	ћетод = "ѕометка”далени€()"			“огда
		¬озврат		»сточник.ѕометка”далени€();
	»наче≈сли	ћетод = "—истемноеѕредставление()"	“огда
		¬озврат		«начение¬—троку¬нутр(»сточник);
	»наче≈сли	ћетод = " од()"						“огда
		¬озврат		»сточник. од;
	 онец≈сли;
	
	
	“ип»сточника	=	“ип«начени€—тр(»сточник);
	
	
    ≈сли		“ип»сточника = "—правочник"			“огда
		      
		≈сли		ћетод = "“екущийЁлемент()"		“огда
			«н	=	»сточник.“екущийЁлемент();
		»наче≈сли	ћетод = "Ёто√руппа()"			“огда
			«н	=	»сточник.Ёто√руппа();
		 онец≈сли;
		                                     
	»наче≈сли	“ип»сточника = "ƒокумент"			“огда

		≈сли		ћетод = "“екущийƒокумент()"		“огда
			//«н	=	»сточник.“екущийƒокумент();
			¬озврат(»сточник);
		»наче≈сли	ћетод = "ѕроведен()"			“огда
			«н	=	»сточник.ѕроведен();
		»наче≈сли	ћетод = "ѕроводки¬ключены()"	“огда
			«н	=	»сточник.ќпераци€.¬ключитьѕроводки();
		 онец≈сли;
		
	»наче≈сли	“ип»сточника = "ѕеречисление"		“огда
		
		≈сли			ћетод = "“екущее«начение()"	“огда
			«н	=	»сточник;
		»наче≈сли		ћетод = "ѕредставление()"	“огда
			«н	=	—трока(»сточник);
		»наче≈сли		ћетод = "»дентификатор()"	“огда
			«н	=	»сточник.»дентификатор();
		»наче≈сли		ћетод = "ѕор€дковыйЌомер()"	“огда
			«н	=	»сточник.ѕор€дковыйЌомер();
		 онец≈сли;
		
	»наче≈сли	“ип»сточника = "—чет"				“огда
		
		≈сли		ћетод = "“екущий—чет()"			“огда
			«н	=	»сточник.“екущий—чет();
		»наче≈сли	ћетод = "–одитель()"			“огда
			«н	=	»сточник.–одитель();
		»наче≈сли	Ќайти(ћетод, "¬ид—убконто") > 0	“огда
			Ќомер—убконто	=	„исло(—ред(ћетод, 12, 1));
			≈сли Ќомер—убконто > ћаксимальное оличество—убконто() “огда
				¬озврат("");
			 онец≈сли;
			«н	=	»сточник.¬ид—убконто(Ќомер—убконто);
		 онец≈сли;
	
	»наче≈сли	“ип»сточника = "¬ид—убконто"		“огда
		
		≈сли		ћетод = "»дентификатор()"		“огда
			«н	=	»сточник.»дентификатор();
		»наче≈сли	ћетод = "ѕредставление()"		“огда
			«н	=	ћетаданные.¬ид—убконто(»сточник.»дентификатор()).ѕредставление();
		»наче≈сли	ћетод = "“ип—убконто()"			“огда
			«н	=	»сточник.“ип—убконто();
		»наче≈сли	ћетод = "ѕор€дковыйЌомер()"		“огда
			«н	=	»сточник.ѕор€дковыйЌомер();
		 онец≈сли;
		
	»наче≈сли	“ип»сточника = "ќпераци€"			“огда

		≈сли		ћетод = "ѕлан—четов()"			“огда
			≈сли »сточник.ѕроводка¬ыбрана() = 1 “огда
				«н	=	»сточник.ѕлан—четов().»дентификатор();
			»наче
				«аписатьќшибку("Ќе выбрана проводка дл€ получени€ плана счетов!", "!");
			 онец≈сли;
		»наче≈сли	ћетод = "¬идƒокумента()"		“огда
			«н	=	»сточник.ƒокумент.¬ид();
		 онец≈сли;
		
	 онец≈сли;
	
	¬озврат(«н);
	
 онец‘ункции		//	ѕолучить«начениећетодом()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ѕодобрать«начениеѕо“ипу(ќбъект, “ип«нач, ¬ид«нач, Ќомер—убконто»сточника="")
	
	≈сли  		“ип«начени€—тр(ќбъект) = "—писок«начений" “огда
		
		ƒл€ —ч = 1 ѕо ќбъект.–азмер—писка() ÷икл
			«начение = ќбъект.ѕолучить«начение(—ч);
			≈сли “ип«начени€—тр(«начение) = “ип«нач	“огда
				≈сли Ќайти("—трока,„исло,ƒата", “ип«нач) = 0 “огда
				    ≈сли «начение.¬ид() = ¬ид«нач “огда	¬озврат(«начение)	 онец≈сли;
				 онец≈сли;
			 онец≈сли;
		 онец÷икла;
		
	»наче≈сли  	“ип«начени€—тр(ќбъект) = "—правочник" “огда
	                                                       
		ќбъектћƒ	=	ћетаданные.—правочник(ќбъект.¬ид());
		
		≈сли ѕустое«начение(Ќомер—убконто»сточника) = 0 “огда
			»д–еквизита	=	"—убконто" + —окрЋѕ(Ќомер—убконто»сточника);
			≈сли ќбъектћƒ.–еквизит(»д–еквизита).¬ыбран() = 1 “огда
				¬озврат	ќбъект.ѕолучитьјтрибут(»д–еквизита);
			 онец≈сли;
		 онец≈сли;
		
		ƒл€ —ч = 1 ѕо ќбъектћƒ.–еквизит() ÷икл
		    –еквћƒ	=	ќбъектћƒ.–еквизит(—ч);
			≈сли –еквћƒ.“ип = "Ќеопределенный" “огда
				«начение = ќбъект.ѕолучитьјтрибут(–еквћƒ.»дентификатор);
				≈сли “ип«начени€—тр(«начение) = “ип«нач	“огда
					≈сли Ќайти("—трока,„исло,ƒата", “ип«нач) = 0 “огда
					    ≈сли «начение.¬ид() = ¬ид«нач “огда	¬озврат(«начение)	 онец≈сли;
					 онец≈сли;
				 онец≈сли;
			 онец≈сли;
		 онец÷икла;
		
	»наче≈сли	“ип«начени€—тр(ќбъект) = "ƒокумент" “огда
		
		ќбъектћƒ	=	ћетаданные.ƒокумент(ќбъект.¬ид());
		
		≈сли ѕустое«начение(Ќомер—убконто»сточника) = 0 “огда
			»д–еквизита	=	"—убконто" + —окрЋѕ(Ќомер—убконто»сточника);
			≈сли ќбъектћƒ.–еквизит(»д–еквизита).¬ыбран() = 1 “огда
				¬озврат	ќбъект.ѕолучитьјтрибут(»д–еквизита);
			 онец≈сли;
		 онец≈сли;
		
		ƒл€ —ч = 1 ѕо ќбъектћƒ.–еквизитЎапки() ÷икл
		    –еквћƒ	=	ќбъектћƒ.–еквизитЎапки(—ч);
			≈сли –еквћƒ.“ип = "Ќеопределенный" “огда
				«начение = ќбъект.ѕолучитьјтрибут(–еквћƒ.»дентификатор);
				≈сли “ип«начени€—тр(«начение) = “ип«нач	“огда
					≈сли Ќайти("—трока,„исло,ƒата", “ип«нач) = 0 “огда
					    ≈сли «начение.¬ид() = ¬ид«нач “огда	¬озврат(«начение)	 онец≈сли;
					 онец≈сли;
				 онец≈сли;
			 онец≈сли;
		 онец÷икла;
		
		ƒл€ —ч = 1 ѕо ќбъектћƒ.–еквизит“абличной„асти() ÷икл
		    –еквћƒ	=	ќбъектћƒ.–еквизит“абличной„асти(—ч);
			≈сли –еквћƒ.“ип = "Ќеопределенный" “огда
				«начение = ќбъект.ѕолучитьјтрибут(–еквћƒ.»дентификатор);
				≈сли “ип«начени€—тр(«начение) = “ип«нач	“огда
					≈сли Ќайти("—трока,„исло,ƒата", “ип«нач) = 0 “огда
					    ≈сли «начение.¬ид() = ¬ид«нач “огда	¬озврат(«начение)	 онец≈сли;
					 онец≈сли;
				 онец≈сли;
			 онец≈сли;
		 онец÷икла;
		
	 онец≈сли;
	
	¬озврат("");

 онец‘ункции		//	ѕодобрать«начениеѕо“ипу()

//-------------------------------------------------------------------------------------------------- 
             
‘ункци€ ¬ыделитьѕрефикс(«нач —тр, „ислова€„асть="", –ежим="")
    
	—тр		=	—окрЋѕ(—тр);
	ѕрефикс	=	—тр;
	ƒлина	=	—трƒлина(—тр);
	
	ƒл€ —ч = 1 ѕо ƒлина ÷икл
		„ислова€„асть	=	„исло(—тр);
		
	    ≈сли („ислова€„асть > 0) » (—трƒлина(„ислова€„асть) = ƒлина - —ч + 1) “огда 
			ѕрефикс	=	Ћев(ѕрефикс, —ч - 1);
			
			ѕока ѕрав(ѕрефикс, 1) = "0" ÷икл
			    ѕрефикс = Ћев(ѕрефикс, —трƒлина(ѕрефикс)-1);
			 онец÷икла;
			
			ѕрервать;		    				
	    »наче
			—тр = ѕрав(—тр, ƒлина - —ч);
		 онец≈сли;
		
		≈сли „ислова€„асть < 0 “огда	„ислова€„асть = - „ислова€„асть		 онец≈сли;
			
	 онец÷икла;
	              
	≈сли –ежим = "„исло" “огда
	    ¬озврат(„ислова€„асть);
	»наче
		¬озврат(ѕрефикс);
	 онец≈сли;

 онец‘ункции		//	¬ыделитьѕрефикс()

//--------------------------------------------------------------------------------------------------

‘ункци€ ƒополнитьЌул€ми(—тр, ƒлина)
                            
	—тр			=	—окрЋѕ(—тр);
	//ƒобавить	=	ƒлина - —трƒлина(—тр);
	
	//≈сли	ƒобавить > 0	“огда
		
		„ислова€„асть	=	"";
		–езультат		=	¬ыделитьѕрефикс(—тр, „ислова€„асть);
		ѕока ƒлина - —трƒлина(–езультат) - —трƒлина(„ислова€„асть) > 0 ÷икл
		    –езультат	=	–езультат + "0";
		 онец÷икла;
		–езультат	=	–езультат + —трока(„ислова€„асть);
		
		¬озврат(–езультат);
		
	//»наче
	//	¬озврат	—тр;
	// онец≈сли;
	
 онец‘ункции		//	ƒополнить—троку()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ƒобавить ѕрефиксу(—тр, ƒобавок="", ƒлина, –ежим="—лева")
	                     
	„ислова€„асть		=	"";
	ѕрефикс			=	¬ыделитьѕрефикс(—тр, „ислова€„асть);
	≈сли –ежим="—лева" “огда
		–езультат	=	—окрЋѕ(ƒобавок) + ѕрефикс;
	»наче
		–езультат	=	ѕрефикс + —окрЋѕ(ƒобавок);
	 онец≈сли;

	ѕока ƒлина - —трƒлина(–езультат) - —трƒлина(„ислова€„асть) > 0 ÷икл
	    –езультат	=	–езультат + "0";
	 онец÷икла;
	–езультат	=	–езультат + —трока(„ислова€„асть);
	
	¬озврат(–езультат);
	
	//¬озврат ƒополнитьЌул€ми(Ќовыйѕрефикс + „ислова€„асть, ƒлина);

 онец‘ункции

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ¬ыполнитьѕреобразование(—писок—трокой, «нач ќбъект, «нач –еквизит="", »дѕравила="", ѕриемник_ƒлина=0)
	
	≈сли ѕустое«начение(—писок—трокой) = 1 “огда ¬озврат("")  онец≈сли;
	
	—писок	=	«начение»з—троки(—писок—трокой);
	≈сли “ип«начени€—тр(—писок) <> "—писок«начений" “огда ¬озврат(—писок—трокой)  онец≈сли;	//	ƒл€ простых строковых значений...

	≈сли —писок.ѕолучить("ќбъект»ли–еквизит") = "–еквизит" “огда	ќбъект = –еквизит	 онец≈сли;

	«начение	=	—писок.ѕолучить("«начение");
	
	≈сли		«начение = "<ѕустое значение>" “огда
		¬озврат("");
	»наче≈сли	ѕустое«начение(«начение) = 0 “огда
		«начение	=	—тр«аменить(«начение,	—имв(10),			"#рс#" );
		//«начение	=	—тр«аменить(«начение,	—имвол“абул€ции,	"#ст#" );
		¬озврат(«начение);
	 онец≈сли;
	
	—трока—умма	=	"";
	
	ƒл€ —ч = 1 ѕо —писок.–азмер—писка() ÷икл
		
		ѕред	=	"";
	    «н		=	—писок.ѕолучить«начение(—ч, ѕред);
		
		≈сли		ѕред = "јтрибут"								“огда
			
			≈сли Ќайти(«н, "()") = 0 “огда
				≈сли “ип«начени€—тр(ќбъект) = "—правочник" “огда
					ќбъект.»спользоватьƒату(‘ормƒата он, 1);
				 онец≈сли;
				ќбъект	=	ќбъект.ѕолучитьјтрибут(«н);
			»наче
				ќбъект	=	ѕолучить«начениећетодом(ќбъект, «н);
			 онец≈сли;
			
		»наче≈сли	ѕред = "»тогѕо олонке"							“огда
			
			ќбъект	=	ќбъект.»тог(«н);
			                     
		»наче≈сли	ѕред = " онкатенаци€"							“огда
			
			≈сли Ќайти(«н, "()") = 0 “огда
				—трока—умма	=	—трока—умма	+	—окрЋ(ѕолучить»дќбъекта»сточника(ќбъект.ѕолучитьјтрибут(«н)));
			»наче
				—трока—умма	=	—трока—умма	+	—окрЋ(ѕолучить»дќбъекта»сточника(ѕолучить«начениећетодом(ќбъект, «н)));
			 онец≈сли;
			
		»наче≈сли	ѕред = "ƒополнитьЌул€ми"						“огда

			≈сли Ќайти(«н, "()") = 0 “огда
				ќбъект	=	ќбъект.ѕолучитьјтрибут(«н);
			»наче
				ќбъект	=	ѕолучить«начениећетодом(ќбъект, «н);
			 онец≈сли;
			
			ќбъект	=	ƒополнитьЌул€ми(ќбъект, ѕриемник_ƒлина);
			                      
		»наче≈сли	ѕред = "ѕолучить»зѕараметров"					“огда
			
			¬озврат("#ѕолучить»зѕараметров");
			
		»наче≈сли	Ќайти(ѕред, "»спользовать—убконто—чета") > 0	“огда
			
			ѕравило	=	"";
			—чет	=	ќбъект.ѕолучитьјтрибут(«н);
			≈сли ѕустое«начение(—чет)					= 1	“огда	¬озврат("")	 онец≈сли;
			≈сли Ќайтиѕравило(—чет, ѕравило, »дѕравила)	= 0	“огда	¬озврат("")	 онец≈сли;
			    
			»дѕравила			=	"";
			”зел«начени€		=	ѕравило.¬ыбрать”зел("«начение[@»сточник=""" + —чет. од + """]");
			≈сли ѕустое«начение(”зел«начени€) = 1 “огда	«аписатьќшибку("Ќе найдено правило конвертации значени€ " + —чет, "!"); ¬озврат("");	 онец≈сли;
			
			Ќомер—убконто		=	—окрЋѕ(—тр«аменить(ѕред, "»спользовать—убконто—чета_", ""));
			
			«апрос				=	"–еквизит[(ѕриемник/@Ќомер—убконто = """ + Ќомер—убконто + """)]";
			јтрибуты«начени€	=	”зел«начени€.¬ыбрать”злы(«апрос);
			 оличество”злов		=	јтрибуты«начени€. оличество”злов();
			≈сли ѕустое«начение( оличество”злов) = 1 “огда ¬озврат("")  онец≈сли;
			     
			—писок¬озможных«начений	=	–еквизит;
			
			ƒл€ —чјтрибутов = 0 ѕо  оличество”злов - 1 ÷икл
				јтрибут«начени€	=	јтрибуты«начени€.ѕолучить”зел(—чјтрибутов);
				                                                            
				≈сли (ѕустое«начение(–еквизит) = 1) »ли (–еквизит = "#ѕолучить") »ли (“ип«начени€—тр(—писок¬озможных«начений) = "—писок«начений") “огда
					–екв»сточник	=	јтрибут«начени€.¬ыбрать”зел("»сточник");
					≈сли ѕустое«начение(–екв»сточник) = 0 “огда
						“ип–екв»сточника		=	–екв»сточник.ѕолучитьјтрибут("“ип");
						¬ид–екв»сточника		=	–екв»сточник.ѕолучитьјтрибут("¬ид");
						Ќомер—убконто»сточника	=	–екв»сточник.ѕолучитьјтрибут("Ќомер—убконто");
						≈сли “ип«начени€—тр(—писок¬озможных«начений) = "—писок«начений" “огда
							–еквизит		=	ѕодобрать«начениеѕо“ипу(—писок¬озможных«начений, “ип–екв»сточника, ¬ид–екв»сточника);
						»наче
							–еквизит		=	ѕодобрать«начениеѕо“ипу(ќбъект, “ип–екв»сточника, ¬ид–екв»сточника, Ќомер—убконто»сточника);
						 онец≈сли;
					 онец≈сли;
				 онец≈сли;
				                        
				”сл	=	јтрибут«начени€.¬ыбрать”зел("”слови€");
				≈сли ѕустое«начение(”сл) = 0 “огда
					≈сли ”слови€¬ыполн€ютс€(”сл, –еквизит) = 0 “огда ѕродолжить	 онец≈сли;
				 онец≈сли;
				
				»дѕравила	=	"";
				Ќайтиѕравилоƒл€јтрибута«начени€(–еквизит, , »дѕравила, јтрибут«начени€);
				¬озврат(–еквизит);
			 онец÷икла;
			
		»наче≈сли	Ќайти("ќбъект»ли–еквизит,«начение", ѕред) > 0	“огда
			
			ѕродолжить;
			
		 онец≈сли;
		
	 онец÷икла;
	
	≈сли ѕустое«начение(—трока—умма) = 1 “огда
		¬озврат(ќбъект);
	»наче
		¬озврат(—трока—умма);
	 онец≈сли;
	
 онец‘ункции		//	¬ыполнитьѕреобразование()

//--------------------------------------------------------------------------------------------------
                                                                                           
‘ункци€ ѕолучитьѕараметрыѕравила(—писок—трокой, «нач ќбъект, «нач –еквизит="", —писокѕараметровѕравила="")

	—писок»сточник	=	«начение»з—троки(—писок—трокой);
	≈сли “ип«начени€—тр(—писок»сточник) <> "—писок«начений" “огда ¬озврат("")  онец≈сли;
	
	—писокѕриемник	=	—оздатьќбъект("—писок«начений");
    
	ƒл€ —ч = 1 ѕо —писок»сточник.–азмер—писка() ÷икл
		јтрибут		=	"";
		«начение	=	¬ыполнитьѕреобразование(—писок»сточник.ѕолучить«начение(—ч, јтрибут), ќбъект, –еквизит);
		≈сли «начение = "#ѕолучить»зѕараметров" “огда
			≈сли “ип«начени€—тр(—писокѕараметровѕравила) = "—писок«начений" “огда
				«начениејтрибута»з—писка = —писокѕараметровѕравила.ѕолучить(јтрибут);
				≈сли ѕустое«начение(«начениејтрибута»з—писка) = 0 “огда
					—писокѕриемник.ƒобавить«начение(«начениејтрибута»з—писка, јтрибут);
				 онец≈сли;
			 онец≈сли;
		»наче
			≈сли ѕустое«начение(«начение) = 0 “огда
				—писокѕриемник.ƒобавить«начение(«начение, јтрибут);
			 онец≈сли;
		 онец≈сли;
	 онец÷икла;
	
	¬озврат(—писокѕриемник);
	
 онец‘ункции		//	ѕолучитьѕараметрыѕравила()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ƒобавить–еквизит(“аб, »сточник, ѕриемник="", «нач «н="#ѕолучить", «нач —пособ«агрузкиѕо”молчанию="", —писокƒопѕараметровѕравила="")
	                                                       
	»дѕравила–еквизитов		=	“аб.»д;
	¬ид”слови€				=	“аб.¬ид”слови€;
	
	≈сли		¬ид”слови€ = 1 “огда		//	условие задано по объекту
		”слови€				=	“аб.”слови€;
		≈сли ”слови€¬ыполн€ютс€(”слови€, »сточник) = 0 “огда ¬озврат("")  онец≈сли;
	»наче≈сли	¬ид”слови€ = 2 “огда			//	условие задано по значению реквизита
		”слови€				=	“аб.”слови€;
	 онец≈сли;
	
	
	“ип»сточника			=	“ип«начени€—тр(»сточник);
	
	»сточник_»д				=	“аб.»сточник_»д;
	»сточник_“ип			=	“аб.»сточник_“ип;
	»сточник_“ипјтрибута	=	“аб.»сточник_“ипјтрибута;
	
	ѕриемник_»д				=	“аб.ѕриемник_»д;
	ѕриемник_“ипјтрибута	=	“аб.ѕриемник_“ипјтрибута;
	ѕриемник_“ип			=	“аб.ѕриемник_“ип;
	ѕриемник_¬ид			=	“аб.ѕриемник_¬ид;
	ѕриемник_ƒлина			=	“аб.ѕриемник_ƒлина;
	
	ѕреобразование			=	“аб.ѕреобразование;
	ѕравило¬ыгрузки			=	“аб.ѕравило;
	
	≈стьѕроцедура			=	“аб.≈стьѕроцедура;
	ѕараметрыѕравила		=	“аб.ѕараметрыѕравила;
	ѕолучить»зѕараметров	=	“аб.ѕолучить»зѕараметров;
	
	—пособ«агрузки			=	“аб.—пособ«агрузки;
	                         
	
	//-------------------------------------------
	
	
    ≈сли		(“ип»сточника = "—правочник") »ли (“ип»сточника = "—чет")	“огда
		
		Ёто√руппа		=	»сточник.Ёто√руппа();
		≈сли (Ќайти(»сточник_“ипјтрибута, "Ё") > 0) » (Ёто√руппа = 1)	“огда	¬озврат("")	 онец≈сли;
		≈сли (Ќайти(ѕриемник_“ипјтрибута, "Ё") > 0) » (Ёто√руппа = 1)	“огда	¬озврат("")	 онец≈сли;
		
		
		≈сли	(	(Ќайти(»сточник_“ипјтрибута, "√") > 0)		»ли
					(Ќайти(ѕриемник_“ипјтрибута, "√") > 0)	)	»	(Ёто√руппа = 0) “огда
			//	ѕроверим: не указано ли уже в xml-объекте что это все-таки группа
			≈сли ѕустое«начение(ѕриемник.ѕолучитьјтрибут("Ёто√руппа")) = 1 “огда
				”зелƒл€ѕроверки	=	ѕриемник.¬ыбрать”зел("—сылка");
				≈сли ѕустое«начение(”зелƒл€ѕроверки) = 0 “огда
					≈сли ѕустое«начение(”зелƒл€ѕроверки.ѕолучитьјтрибут("Ёто√руппа")) = 1 “огда
						¬озврат("");
					 онец≈сли;
				»наче
					¬озврат("");	
				 онец≈сли;
			 онец≈сли;
		 онец≈сли;
		
	»наче≈сли	“ип»сточника = "ƒокумент"		“огда
		
		≈сли »сточник_»д = "¬рем€ƒок" “огда
			«н	=	»сточник.ѕолучить¬рем€();
		 онец≈сли;
		
	»наче≈сли	“ип»сточника = "∆урнал–асчетов"	“огда
		    
		ѕервична€«апись	=	»сточник.ѕервична€«апись;	//	через две точки не работает!
		≈сли		»сточник_»д = "ƒокументѕервичной«аписи"		“огда
			≈сли ѕустое«начение(ѕервична€«апись) = 1 “огда ¬озврат("")  онец≈сли;
			«н	=	ѕервична€«апись.–одительскийƒокумент;
			≈сли ѕустое«начение(«н) = 1 “огда 	¬озврат("")  онец≈сли;
		»наче≈сли	»сточник_»д = "–егистраци€ѕервичной«аписи"	“огда
			≈сли ѕустое«начение(ѕервична€«апись) = 1 “огда ¬озврат("")  онец≈сли;
			ѕериод–егистрации	=	ѕервична€«апись.ѕериод–егистрации;
			«н					=	ѕериод–егистрации.ƒатаЌачала;
		 онец≈сли;
		
	 онец≈сли;
    
	
	//-------------------------------------------
	           
	
	ѕрерватьѕослеќбработки	=	0;
	≈сли	ѕустое«начение(≈стьѕроцедура) = 0 “огда
		«н	=	ƒополнительныеѕреобразовани€("ѕравило–еквизита", »дѕравила–еквизитов, »сточник, ѕриемник, —писокƒопѕараметровѕравила);
		≈сли		«н = 0 “огда
			
			¬озврат(0);
			
		»наче≈сли	«н = "#ѕрервать" “огда
			
			¬озврат("#ѕрервать");
			
		»наче≈сли	«н = "#ѕрерватьѕослеќбработки"	“огда
			
			≈стьѕроцедура			=	0;
			ѕрерватьѕослеќбработки	=	1;
			
		»наче≈сли	«н = "#ѕрерватьѕеребор—трок"	“огда
			
			¬озврат("#ѕрерватьѕеребор—трок");
			
		 онец≈сли;
	 онец≈сли;
	                                             
	
	//-------------------------------------------
	
	
	«начение»стории		=	"";
        
	≈сли	ѕустое«начение(≈стьѕроцедура) = 1 “огда
		
		≈сли		»сточник_“ипјтрибута = "ћ"								“огда
			«н	=	ѕолучить«начениећетодом(»сточник, »сточник_»д);
		»наче≈сли	(«н = "#ѕолучить") » (ѕустое«начение(»сточник_»д) = 0)	“огда
			≈сли		(Ќайти("јќ,–ќ", »сточник_“ипјтрибута) > 0) » (“ип»сточника <> "ќпераци€")	“огда
				«н		=	»сточник.ќпераци€.ѕолучитьјтрибут(»сточник_»д);
			»наче≈сли	»сточник_“ипјтрибута = "ѕ "	“огда
				¬рем	=	—оздатьќбъект("ѕериодический");
				¬рем.»спользоватьќбъект(»сточник_»д);
				«н		=	¬рем.«начениеЌаƒату( ?(ѕустое«начение(‘ормƒата он)=1, –абоча€ƒата(), ‘ормƒата он) );
			»наче≈сли	»сточник_“ипјтрибута = " "	“огда
				«н		=	 онстанта.ѕолучитьјтрибут(»сточник_»д);
			»наче
				//«н		=	»сточник.ѕолучитьјтрибут(»сточник_»д);
				
				//	Ёто помогает при отладке
				ѕопытка
					«н		=	»сточник.ѕолучитьјтрибут(»сточник_»д);
				»сключение
				    —ообщить("Ќеверное им€ реквизита! ќбъект:  " + »сточник + ";   –еквизит:  " + »сточник_»д + ";   ѕравило реквизита:  " + »дѕравила–еквизитов);
				 онецѕопытки;
			 онец≈сли;
		»наче≈сли	“ип«начени€—тр(«н) = "ѕериодический" “огда
			«начение»стории	=	«н;
			«н				=	«начение»стории.«начение;
			ƒата«начени€	=	«начение»стории.ƒата«нач;
		»наче≈сли	ѕустое«начение(ѕолучить»зѕараметров) = 0	“огда
			≈сли “ип«начени€—тр(—писокƒопѕараметровѕравила) = "—писок«начений" “огда
				«н			=	—писокƒопѕараметровѕравила.ѕолучить(ѕриемник_»д);
			 онец≈сли;
		 онец≈сли;
		
	 онец≈сли;
	
	
	
	≈сли ¬ид”слови€ = 2 “огда	//	т.е. условие задано по значению реквизита
		≈сли ”слови€¬ыполн€ютс€(”слови€, «н) = 0 “огда ¬озврат("")  онец≈сли;
	 онец≈сли;
	
	
	
	≈сли		ѕустое«начение(ѕреобразование) = 0	“огда
		«н	=	¬ыполнитьѕреобразование(ѕреобразование, »сточник, «н, ѕравило¬ыгрузки, ѕриемник_ƒлина);
	 онец≈сли;
	
	
	≈сли	«н = "#ѕолучить" “огда	// значит это виртуальный объект (которого нет в базе источнике)
		«н				=	"";
	//»наче≈сли	Ќайти("—трока,ƒата,„исло", ѕриемник_“ип) > 0 “огда
		// ’орошо бы здесь в таком случае сразу ѕолучить»дќбъекта»сточника()
	»наче≈сли	(—пособ«агрузки				=	"«амещатьЌеѕустыми")	»ли 
				((—пособ«агрузкиѕо”молчанию	=	"«амещатьЌеѕустыми")	»	(ѕустое«начение(—пособ«агрузки) = 1))	“огда
		≈сли ѕустое«начение(«н) = 1 “огда	¬озврат("")	 онец≈сли;
	 онец≈сли;

	
	≈сли	ѕустое«начение(ѕараметрыѕравила) = 0	“огда
		ѕараметрыѕравила = ѕолучитьѕараметрыѕравила(ѕараметрыѕравила, »сточник, «н, —писокƒопѕараметровѕравила);
	 онец≈сли;
	
	
	
	”зел—сылки				=	1;		// означает что нам нужна ссылка
	«начение				=	¬ыгрузить(«н, ѕравило¬ыгрузки, ”зел—сылки, ѕараметрыѕравила, ѕриемник_“ип, ѕриемник_¬ид);
	
	
	
	≈сли		ѕриемник_“ипјтрибута = "ћ"			“огда
		
		≈сли		ѕриемник_»д = "Ёто√руппа()"			“огда
			”становитьјтрибут(ѕриемник, "Ёто√руппа", «начение);
			¬озврат("");
		»наче≈сли	ѕриемник_»д = "—истемноеѕредставление()"	“огда
			
		»наче
			¬озврат(«начение);
		 онец≈сли;
		
	 онец≈сли;
	
    
	
	≈сли ѕустое«начение(ѕриемник_»д)	= 1	“огда	¬озврат(«начение)	 онец≈сли;
	≈сли ѕустое«начение(ѕриемник)		= 1	“огда	¬озврат(«начение)	 онец≈сли;
	
	
	
	//-------------- xml --------------
	
	≈сли ѕустое«начение(«начение»стории) = 1 “огда
		≈сли (ѕриемник_“ипјтрибута = " ") »ли (ѕриемник_“ипјтрибута = "ѕ ") “огда
		    –еквизит	=	ѕриемник;
		»наче
			–еквизит	=	ѕриемник.—оздатьѕодчиненныйЁлемент("–еквизит");
		 онец≈сли;
		”становитьјтрибут(–еквизит,	"»дентификатор",	ѕриемник_»д);
		”становитьјтрибут(–еквизит,	"«начение", 		«начение);
		≈сли —пособ«агрузки <> "ѕоиск" “огда
			”становитьјтрибут(–еквизит,	"—пособ«агрузки",	—пособ«агрузки);
		 онец≈сли;
	»наче
		≈сли —пособ«агрузки <> "ѕоиск" “огда
			”становитьјтрибут(ѕриемник,	"—пособ«агрузки",	—пособ«агрузки);
		 онец≈сли;
		–еквизит	=	ѕриемник.—оздатьѕодчиненныйЁлемент("»стори€");
		”становитьјтрибут(–еквизит,	"ƒата",			¬ыгрузить(ƒата«начени€));
		”становитьјтрибут(–еквизит,	"«начение",		«начение);
	 онец≈сли;
	
	
	≈сли 		Ќайти("јќ,–ќ", ѕриемник_“ипјтрибута) = 0	“огда
	»наче≈сли	“ип»сточника <> "ќпераци€"					“огда
		”становитьјтрибут(–еквизит,	"Ёто–еквизитќперации", "1");
	 онец≈сли;
	
        
	≈сли ”зел—сылки <> 1 “огда	// значит узел ссылки создан
		–еквизит.ƒобавитьѕодчиненный(”зел—сылки);
	 онец≈сли;
	
	
	≈сли	(ѕриемник_“ип	=	"Ќеопределенный")	»ли
			((ѕустое«начение(ѕриемник_¬ид) = 1)		»	(Ќайти("—правочник,ƒокумент,ѕеречисление,—чет", ѕриемник_“ип) > 0)) “огда
				
		≈сли  ѕустое«начение(ѕравило¬ыгрузки) = 1 “огда
			“	=	“ип«начени€—тр(«н);
			≈сли (ѕустое«начение(«н) = 1) » (“ = "—трока") “огда
				ѕриемник.”далитьѕодчиненный(–еквизит);
			»наче
				”становитьјтрибут(–еквизит,	"“ип«начени€", 	“);
			 онец≈сли;
		»наче≈сли ѕустое«начение(Ќайтиѕравило(«н, , ѕравило¬ыгрузки)) = 0 “огда
			”становитьјтрибут(–еквизит,	"“ип«начени€", 	г“аб эшѕравил.ѕриемник_“ип);
			”становитьјтрибут(–еквизит,	"¬ид«начени€", 	г“аб эшѕравил.ѕриемник_¬ид);
		 онец≈сли;
	 онец≈сли;
	
	
	≈сли ѕрерватьѕослеќбработки = 1 “огда
		¬озврат("#ѕрервать");
	»наче
		¬озврат("");
	 онец≈сли;
	
 онец‘ункции		//	ƒобавить–еквизит()

//--------------------------------------------------------------------------------------------------
                                                                                 
ѕроцедура ¬ыгрузитьќбъект—правочника(»сточник, ѕриемник, “аб–еквизитов, »дѕравила, —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила)
	    
	“ип»сточника	=	“ип«начени€—тр(»сточник);
	                                                                  
	“аб–еквизитов.¬ыбрать—троки();
	ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
	    ‘лЌе¬ыгружать»сторию		=	1;
		—пособ¬ыгрузки				=	“аб–еквизитов.—пособ¬ыгрузки;
		
		≈сли “ип»сточника = "—правочник" “огда
			Ёто√руппа				=	»сточник.Ёто√руппа();
			
			»сточник_“ипјтрибута	=	“аб–еквизитов.»сточник_“ипјтрибута;
			ѕриемник_“ипјтрибута 	=	“аб–еквизитов.ѕриемник_“ипјтрибута;
		      
			≈сли 	(Ќайти(»сточник_“ипјтрибута, "Ё") > 0) » (Ёто√руппа = 1)	“огда ѕродолжить  онец≈сли;
			≈сли	(Ќайти(»сточник_“ипјтрибута, "√") > 0) » (Ёто√руппа = 0)	“огда ѕродолжить  онец≈сли;
			
			≈сли (—пособ¬ыгрузки = "¬сю»сторию") »ли (—пособ¬ыгрузки = "¬сю»сторию–учную") “огда
				≈сли (Ћев(»сточник_“ипјтрибута, 1)="ѕ") » (Ћев(ѕриемник_“ипјтрибута, 1)="ѕ") “огда
					‘лЌе¬ыгружать»сторию	=	0;
					»сточник_»д				=	“аб–еквизитов.»сточник_»д;
					ѕриемник_»д				=	“аб–еквизитов.ѕриемник_»д;
					»стори€					=	—оздатьќбъект("ѕериодический");
					»стори€.»спользоватьќбъект(»сточник_»д, »сточник);
					
					ƒатаЌачала¬ыборки		=	‘ормƒатаЌач;
					≈сли ѕустое«начение(‘ормƒатаЌач) = 0 “огда
						»стори€.ќбратныйѕор€док(1);
						»стори€.¬ыбрать«начени€(, ‘ормƒатаЌач);
						≈сли »стори€.ѕолучить«начение() = 1 “огда
							ƒатаЌачала¬ыборки	=	»стори€.ƒата«нач;
						 онец≈сли;
					 онец≈сли;
					        
					
					»стори€.ќбратныйѕор€док(0);
					≈сли »стори€.¬ыбрать«начени€(ƒатаЌачала¬ыборки, ‘ормƒата он) = 0 “огда ѕродолжить;  онец≈сли;
					–еквизит—»сторией	=	ѕриемник.—оздатьѕодчиненныйЁлемент("–еквизит");
					”становитьјтрибут(–еквизит—»сторией,	"»дентификатор", 	ѕриемник_»д);
					ѕока »стори€.ѕолучить«начение() = 1 ÷икл
						≈сли —пособ¬ыгрузки = "¬сю»сторию–учную" “огда
							≈сли ѕустое«начение(»стори€.“екущийƒокумент()) = 0 “огда ѕродолжить  онец≈сли;
						 онец≈сли;
						–езультат = ƒобавить–еквизит(“аб–еквизитов, »сточник, –еквизит—»сторией, »стори€, —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
					 онец÷икла;
				 онец≈сли;
			 онец≈сли;		//	если способ выгрузки "¬ыгружать историю"
		 онец≈сли;
		
		≈сли ‘лЌе¬ыгружать»сторию = 1 “огда
			–езультат = ƒобавить–еквизит(“аб–еквизитов, »сточник, ѕриемник, "#ѕолучить", —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
			≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
		 онец≈сли;
	 онец÷икла;		//	по правилам реквизитов
	
	«аписатьќбъект¬‘айл(ѕриемник);
	
 онецѕроцедуры		//	¬ыгрузитьќбъект—правочника()

//--------------------------------------------------------------------------------------------------
                                                                                                    
ѕроцедура ¬ыгрузить онстанты(“аб–еквизитов, »дѕравила)
                  
	“аб–еквизитов.¬ыбрать—троки();
	ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
		                  
		»сточник_“ипјтрибута	=	“аб–еквизитов.»сточник_“ипјтрибута;
		ѕриемник_“ипјтрибута 	=	“аб–еквизитов.ѕриемник_“ипјтрибута;
		      
		»сточник_»д				=	“аб–еквизитов.»сточник_»д;
		ѕриемник_»д				=	“аб–еквизитов.ѕриемник_»д;
		—пособ¬ыгрузки			=	“аб–еквизитов.—пособ¬ыгрузки;
		
		≈сли	ѕустое«начение(ѕриемник_»д) = 1		“огда	ѕродолжить	 онец≈сли;
		
		XML_DOM					=	гXMLјнализатор.—оздатьƒокумент();
		ѕриемник				=	XML_DOM.—оздать”зел(1, " онстанта");
		                   
		»сточникѕериодический	=	?(Ћев(»сточник_“ипјтрибута, 1)="ѕ", 1, 0);
		ѕриемникѕериодический	=	?(Ћев(ѕриемник_“ипјтрибута, 1)="ѕ", 1, 0);
		
		≈сли	(»сточникѕериодический = 1) » (ѕриемникѕериодический = 1) » ( Ќайти(—пособ¬ыгрузки, "¬сю»сторию")>0 ) “огда
			»стори€	=	—оздатьќбъект("ѕериодический");
			»стори€.»спользоватьќбъект(»сточник_»д);
			
			ƒатаЌачала¬ыборки		=	‘ормƒатаЌач;
			≈сли ѕустое«начение(‘ормƒатаЌач) = 0 “огда
				»стори€.ќбратныйѕор€док(1);
				»стори€.¬ыбрать«начени€(, ‘ормƒатаЌач);
				≈сли »стори€.ѕолучить«начение() = 1 “огда
					ƒатаЌачала¬ыборки	=	»стори€.ƒата«нач;
				 онец≈сли;
			 онец≈сли;
			
			≈сли »стори€.¬ыбрать«начени€(ƒатаЌачала¬ыборки, ‘ормƒата он) = 0 “огда ѕродолжить  онец≈сли;
			”становитьјтрибут(ѕриемник,	"»дентификатор", 	ѕриемник_»д);
			ѕока »стори€.ѕолучить«начение() = 1 ÷икл
				≈сли —пособ¬ыгрузки = "¬сю»сторию–учную" “огда
					≈сли ѕустое«начение(»стори€.“екущийƒокумент()) = 0 “огда ѕродолжить  онец≈сли;
				 онец≈сли;
				–езультат = ƒобавить–еквизит(“аб–еквизитов,  онстанта, ѕриемник, »стори€);
			 онец÷икла;
		»наче
			–езультат = ƒобавить–еквизит(“аб–еквизитов,  онстанта, ѕриемник, "#ѕолучить");
		 онец≈сли;
		≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
	
		«аписатьќбъект¬‘айл(ѕриемник);
		
	 онец÷икла;
	
 онецѕроцедуры		//	¬ыгрузить онстанты()

//--------------------------------------------------------------------------------------------------

ѕроцедура ¬ыгрузить алендари(ѕравило, »дѕравила)

	≈сли (ѕустое«начение(‘ормƒатаЌач)=1) »ли (ѕустое«начение(‘ормƒата он) = 1) “огда
		«аписатьќшибку("ƒл€ выгрузки календарей необходимо выбрать конкретный период!", "!");
		¬озврат;
	 онец≈сли;
	
	≈сли ѕустое«начение(ѕравило.¬ыбрать”зел("«начение[@»сточник = ""ѕраздники""]")) = 0 “огда
		ѕраздники	=	—оздатьќбъект("ѕраздники");
		≈сли ѕраздники.¬ыбратьƒаты(‘ормƒатаЌач, ‘ормƒата он) = 1 “огда
			XML_DOM					=	гXMLјнализатор.—оздатьƒокумент();
			ѕриемник				=	XML_DOM.—оздать”зел(1, " алендарь");
			”становитьјтрибут(ѕриемник,	"¬ид", 	"ѕраздники");
			ѕока ѕраздники.—ледующа€ƒата() = 1 ÷икл
				ƒень	=	ѕриемник.—оздатьѕодчиненныйЁлемент("ƒень");
				”становитьјтрибут(ƒень,	"ƒата", 	‘ормат(ѕраздники.ƒата, "ƒƒƒћћ√√√√") );
				”становитьјтрибут(ƒень,	"«начение",	ѕраздники.«начение);
			 онец÷икла;
			«аписатьќбъект¬‘айл(ѕриемник);
		 онец≈сли;
	 онец≈сли;    
	
	¬иды алендарей	=	ѕравило.¬ыбрать”злы("«начение[@»сточник != ""ѕраздники""]");
	ƒл€ —ч = 0 ѕо ¬иды алендарей. оличество”злов() - 1 ÷икл
		Ёл алендарь		=	¬иды алендарей.ѕолучить”зел(—ч);
		¬ид»сточника	=	Ёл алендарь.ѕолучитьјтрибут("»сточник");
		¬идѕриемника	=	Ёл алендарь.ѕолучитьјтрибут("ѕриемник");
		
		 алендарь		=	—оздатьќбъект(" алендарь." + ¬ид»сточника);
		≈сли  алендарь.¬ыбратьƒаты(‘ормƒатаЌач, ‘ормƒата он) = 1 “огда
			XML_DOM					=	гXMLјнализатор.—оздатьƒокумент();
			ѕриемник				=	XML_DOM.—оздать”зел(1, " алендарь");
			”становитьјтрибут(ѕриемник,	"¬ид", 					¬идѕриемника);
			”становитьјтрибут(ѕриемник,	"ƒатаЌачала",			‘ормат(‘ормƒатаЌач, "ƒƒƒћћ√√√√") );
			”становитьјтрибут(ѕриемник,	"ƒатаќкончани€",		‘ормат(‘ормƒата он, "ƒƒƒћћ√√√√") );
			”становитьјтрибут(ѕриемник,	"”читыватьѕраздники",	1);
			ѕока  алендарь.—ледующа€ƒата() = 1 ÷икл
				ƒень	=	ѕриемник.—оздатьѕодчиненныйЁлемент("ƒень");
				”становитьјтрибут(ƒень,	"ƒата", 	‘ормат( алендарь.ƒата, "ƒƒƒћћ√√√√") );
				”становитьјтрибут(ƒень,	"«начение",	 алендарь.«начение);
			 онец÷икла;
			«аписатьќбъект¬‘айл(ѕриемник);
		 онец≈сли;
	 онец÷икла;
	
 онецѕроцедуры		//	¬ыгрузить алендари()

//--------------------------------------------------------------------------------------------------

ѕроцедура ¬ыгрузитьƒокумент(»сточник, ѕриемник, “аб–еквизитов, “аб–еквизитов—трок, »дѕравила, —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила)
	
	//-----------------		–еквизиты	----------------------
	
	“аб–еквизитов.¬ыбрать—троки();
	ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
		–езультат = ƒобавить–еквизит(“аб–еквизитов, »сточник, ѕриемник, "#ѕолучить", —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
		≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
	 онец÷икла;
	
	//-----------------		—троки	----------------------
	
	≈сли “аб–еквизитов—трок. оличество—трок() > 0 “огда
		    
		—троки≈сть		=	0;
		≈сли “ип«начени€—тр(»сточник) = "ƒокумент" “огда
			—троки≈сть	=	»сточник.¬ыбрать—троки();
		 онец≈сли;
		
		≈сли —троки≈сть = 1 “огда
			ѕока »сточник.ѕолучить—троку() = 1 ÷икл
				Ёл_—трока	=	ѕриемник.—оздатьѕодчиненныйЁлемент("—трока");
				“аб–еквизитов—трок.¬ыбрать—троки();
				ѕока “аб–еквизитов—трок.ѕолучить—троку() = 1 ÷икл
					–езультат = ƒобавить–еквизит(“аб–еквизитов—трок, »сточник, Ёл_—трока, "#ѕолучить", —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
					≈сли (–езультат = "#ѕрервать") »ли (–езультат = "#ѕрерватьѕеребор—трок") “огда ѕрервать  онец≈сли;
				 онец÷икла;
				≈сли –езультат = "#ѕрерватьѕеребор—трок" “огда ѕрервать  онец≈сли;
			 онец÷икла;
		»наче
			‘лаг—трокиќписаны¬ѕараметрах	=	0;
			≈сли “ип«начени€—тр(ѕараметрыѕравила) = "—писок«начений" “огда
				≈сли ѕустое«начение(ѕараметрыѕравила.ѕолучить("#—трока")) = 0 “огда
					‘лаг—трокиќписаны¬ѕараметрах	=	1;
					Ќовый—писок						=	—оздатьќбъект("—писок«начений");
					ƒл€ —чѕараметров = 1 ѕо ѕараметрыѕравила.–азмер—писка() ÷икл
						—тр–еквизит		=	"";
						«нач–еквизита	=	ѕараметрыѕравила.ѕолучить«начение(—чѕараметров, —тр–еквизит);
						≈сли —тр–еквизит = "#—трока" “огда ѕродолжить  онец≈сли;
						Ќовый—писок.ƒобавить«начение(«нач–еквизита, —тр–еквизит);
					 онец÷икла;
				 онец≈сли;
			 онец≈сли;
			
			≈сли ‘лаг—трокиќписаны¬ѕараметрах = 1 “огда
				ƒл€ —чѕараметров = 1 ѕо ѕараметрыѕравила.–азмер—писка() ÷икл
					—тр–еквизит		=	"";
					«нач–еквизита	=	ѕараметрыѕравила.ѕолучить«начение(—чѕараметров, —тр–еквизит);
					≈сли —тр–еквизит <> "#—трока" “огда ѕродолжить  онец≈сли;
					ќкончательный—писокѕараметров	=	—оздатьќбъект("—писок«начений");
					Ќовый—писок.¬ыгрузить(ќкончательный—писокѕараметров);
					ƒл€ —сс = 1 ѕо «нач–еквизита.–азмер—писка() ÷икл
						—сс—тр	=	"";
						—сс«н	=	«нач–еквизита.ѕолучить«начение(—сс, —сс—тр);
						ќкончательный—писокѕараметров.ƒобавить«начение(—сс«н, —сс—тр);
					 онец÷икла;
					Ёл_—трока	=	ѕриемник.—оздатьѕодчиненныйЁлемент("—трока");
					“аб–еквизитов—трок.¬ыбрать—троки();
					ѕока “аб–еквизитов—трок.ѕолучить—троку() = 1 ÷икл
						–езультат = ƒобавить–еквизит(“аб–еквизитов—трок, »сточник, Ёл_—трока, "#ѕолучить", —пособ«агрузкиѕо”молчанию, ќкончательный—писокѕараметров);
						≈сли (–езультат = "#ѕрервать") »ли (–езультат = "#ѕрерватьѕеребор—трок") “огда ѕрервать  онец≈сли;
					 онец÷икла;
					≈сли –езультат = "#ѕрерватьѕеребор—трок" “огда ѕрервать  онец≈сли;
				 онец÷икла;
			»наче
				//	дл€ правил вида: "–Ўƒ -> –“ƒ" (когда в источнике нет табличной части) - сливаем все в одну строку
				Ёл_—трока	=	ѕриемник.—оздатьѕодчиненныйЁлемент("—трока");
				“аб–еквизитов—трок.¬ыбрать—троки();
				ѕока “аб–еквизитов—трок.ѕолучить—троку() = 1 ÷икл
					≈сли “аб–еквизитов—трок.»сточник_“ипјтрибута = "–“ƒ" “огда ѕродолжить  онец≈сли; // м.б. в документе просто нет строк
					–езультат = ƒобавить–еквизит(“аб–еквизитов—трок, »сточник, Ёл_—трока, "#ѕолучить", —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
					≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
				 онец÷икла;
			 онец≈сли;
		 онец≈сли;
		
	 онец≈сли;
	              
	«аписатьќбъект¬‘айл(ѕриемник);
	
 онецѕроцедуры		//	¬ыгрузитьƒокумент()

//--------------------------------------------------------------------------------------------------

‘ункци€ ѕолучить»дќбъекта»сточника(»сточник, »д—инхронизирующего–еквизита="")
    
	≈сли ѕустое«начение(—окрЋѕ(»сточник)) = 1 “огда ¬озврат("")  онец≈сли;
	
	—тр»сточник		=	"";
	“ип»сточника	=	“ип«начени€—тр(»сточник);

	≈сли		“ип»сточника	= "„исло" 			“огда	—тр»сточник	=	—трока(»сточник);
	»наче≈сли	“ип»сточника	= "—трока" 			“огда	—тр»сточник	=	—окрѕ(»сточник);
	»наче≈сли 	“ип»сточника	= "ƒата" 			“огда	—тр»сточник	=	‘ормат(»сточник, "ƒƒƒћћ√√√√");
	
	»наче≈сли 	“ип»сточника	= "ѕеречисление"	“огда	—тр»сточник	=	»сточник.»дентификатор();
		
	»наче≈сли 	“ип»сточника	= "ѕлан—четов" 		“огда	—тр»сточник	=	»сточник.»дентификатор();
	»наче≈сли 	“ип»сточника	= "¬ид—убконто"		“огда	—тр»сточник	=	»сточник.»дентификатор();
	»наче≈сли 	“ип»сточника	= " алендарь" 		“огда	—тр»сточник	=	»сточник.¬ид();
	»наче≈сли 	“ип»сточника	= "¬ид–асчета" 		“огда	—тр»сточник	=	»сточник. од;
		
	»наче≈сли 	“ип»сточника	= "—чет" 			“огда	—тр»сточник	=	»сточник. од;
		
	»наче≈сли 	“ип»сточника	= "—правочник"		“огда
		
		≈сли ѕустое«начение(»д—инхронизирующего–еквизита) = 1 “огда »д—инхронизирующего–еквизита = "Ќаименование"	 онец≈сли;
		—тр»сточник	=	—окрЋѕ(»сточник.ѕолучитьјтрибут(»д—инхронизирующего–еквизита));
		
	»наче≈сли 	“ип»сточника	= "ƒокумент"		“огда

		//≈сли ѕустое«начение(»д—инхронизирующего–еквизита) = 1 “огда »д—инхронизирующего–еквизита = "Ќомерƒок"		 онец≈сли;
		//—тр»сточник	=	—окрЋѕ(»сточник.ѕолучитьјтрибут(»д—инхронизирующего–еквизита));
		
		—тр»сточник	=	—окрЋѕ(»сточник);
	
	»наче
		
		«аписатьќшибку("Ќеизвестный тип объекта:   " + “ип»сточника);
		
	 онец≈сли;
	          
	¬озврат(—тр»сточник);
	
 онец‘ункции		//	ѕолучить»дќбъекта»сточника()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ¬ыгрузитьѕоѕравилу(«нач »сточник="", ѕравило="", »дѕравила="", ”зел—сылки=1, ѕараметрыѕравила="", «нач “ипѕриемника="", «нач ¬идѕриемника="", Ќе—инхронизироватьѕоƒопѕараметрам=0)
	  
	ѕерем	“аб–еквизитов;
	ѕерем	“аб–еквизитовѕоиска;
	ѕерем	“аб–еквизитов—трок;
	
	≈сли Ќайтиѕравило(»сточник, ѕравило, »дѕравила, “ипѕриемника, ¬идѕриемника) = 0	“огда	¬озврат("")	 онец≈сли;

	
	“ип»сточника			=	“ип«начени€—тр(»сточник);
	≈сли (“ипѕриемника = "") »ли (“ипѕриемника = "Ќеопределенный") “огда
		“ипѕриемника		=	г“аб эшѕравил.ѕриемник_“ип;
	 онец≈сли;
	
	
	ѕреобразование			=	г“аб эшѕравил.ѕреобразование;
	ѕравилоѕереадресации	=	г“аб эшѕравил.ѕравилоѕереадресации;
	
	≈сли ѕустое«начение(ѕреобразование)			= 0	“огда	»сточник =	¬ыполнитьѕреобразование(ѕреобразование, »сточник)		 онец≈сли;
	≈сли ѕустое«начение(ѕравилоѕереадресации)	= 0	“огда	¬озврат		¬ыгрузить(»сточник, ѕравилоѕереадресации, ”зел—сылки)	 онец≈сли;
	
	
	≈сли 		“ипѕриемника	=	"—правочник"	“огда	“ег	=	"ќбъект—правочника";
	»наче≈сли 	“ипѕриемника	=	"ƒокумент"		“огда	“ег	=	"ƒокумент";
	»наче≈сли 	“ипѕриемника	=	" онстанта"		“огда
		г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
		¬ыгрузить онстанты(“аб–еквизитов, »дѕравила);
		¬озврат("");
	»наче≈сли 	ѕустое«начение(“ипѕриемника) = 1	“огда	//	???
		//“ег			=	“ип»сточника;
		“ег				=	"ќбъект—правочника";
		“ипѕриемника	=	“ип»сточника;
	»наче
	    //-------	Ќайдем идентифицирующее значение объекта ----------------
		
		»д—инхронизирующего–еквизита	=	г“аб эшѕравил.»д—инхронизирующего–еквизита;
		»дќбъекта»сточника				=	ѕолучить»дќбъекта»сточника(»сточник, »д—инхронизирующего–еквизита);	// на пустое не провер€ем специально
		//”зел«начени€					=	ѕравило.¬ыбрать”зел("«начение[@»сточник=""" + »дќбъекта»сточника + """]");
		//≈сли ѕустое«начение(”зел«начени€) = 0 “огда ¬озврат(”зел«начени€.ѕолучитьјтрибут("ѕриемник"))  онец≈сли;

		¬ыборка”злов«начений			=	ѕравило.¬ыбрать”злы("«начение[@»сточник=""" + »дќбъекта»сточника + """]");
		 олво”злов						=	¬ыборка”злов«начений. оличество”злов();
		”зелЌайден						=	0;
		≈сли		 олво”злов = 1 “огда
			”зелЌайден		=	1;
			”зел«начени€	=	¬ыборка”злов«начений.ѕолучить”зел(0);
			//¬озврат ¬ыборка”злов«начений.ѕолучить”зел(0).ѕолучитьјтрибут("ѕриемник");
		»наче≈сли	 олво”злов > 1 “огда	//	в таком случае считаем что услови€ заданы об€зательно
			ƒл€ —ч = 0 ѕо  олво”злов - 1 ÷икл
				”зел«начени€	=	¬ыборка”злов«начений.ѕолучить”зел(—ч);
				≈сли ”слови€¬ыполн€ютс€(”зел«начени€.¬ыбрать”зел("”слови€"), »сточник) = 1 “огда
					”зелЌайден	=	1;
					ѕрервать;
					//¬озврат ”зел«начени€.ѕолучитьјтрибут("ѕриемник");
				 онец≈сли;
			 онец÷икла;
		 онец≈сли;
		
		≈сли ”зелЌайден = 1 “огда
			≈сли ѕустое«начение(”зел«начени€.ѕолучитьјтрибут("≈стьѕроцедура")) = 1 “огда
				¬озврат ”зел«начени€.ѕолучитьјтрибут("ѕриемник");
			»наче
				»дѕравила«начени€	=	”зел«начени€.ѕолучитьјтрибут("»д");
				«н					=	ƒополнительныеѕреобразовани€("ѕравило«начени€", »дѕравила«начени€, »сточник, ”зел«начени€.ѕолучитьјтрибут("ѕриемник"));	// на вс€кий случай передадим туда значение приемника
				¬озврат(«н);
			 онец≈сли;
		 онец≈сли;
		   
		//	¬ значени€х не нашли, тогда попробуем правила реквизитов посмотреть
		
		г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
		
        “аб–еквизитов.¬ыбрать—троки();
        ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
			–езультат	=	ƒобавить–еквизит(“аб–еквизитов, »сточник, , , , ѕараметрыѕравила);		//	обработка методов со стороны приемника
			≈сли ѕустое«начение(–езультат) = 0 “огда	¬озврат(–езультат)	 онец≈сли;
         онец÷икла;
		                                         
		≈сли		ѕустое«начение(ѕреобразование) = 0		“огда
			¬озврат(»сточник);
		»наче≈сли	ѕустое«начение(»дќбъекта»сточника) = 0	“огда
			«аписатьќшибку("Ќе найдено соответствие дл€ значени€ источника:  " + “ип»сточника + "." + г“аб эшѕравил.»сточник_¬ид + "." + »дќбъекта»сточника,  "!");
		 онец≈сли;
		
		¬озврат("");
	 онец≈сли;
    
	
	// если объект не виртуальный и источник пустой
	≈сли	(ѕустое«начение(г“аб эшѕравил.»сточник_“ип) = 0)	»
			(ѕустое«начение(—окрЋѕ(»сточник)) = 1)				»
			(ѕустое«начение(ѕараметрыѕравила) = 1)				“огда	¬озврат("")  онец≈сли;
	
	                                                         
	г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
	г“аб эшѕравил.“аб–еквизитовѕоиска.¬ыгрузить(“аб–еквизитовѕоиска);
	г“аб эшѕравил.“аб–еквизитов—трок.¬ыгрузить(“аб–еквизитов—трок);
	
	ѕараметры«агрузки			=	г“аб эшѕравил.ѕараметры«агрузки;
	
	«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
	—татус”далени€				=	г“аб эшѕараметров«агрузки.—татус”далени€;
	—пособ«агрузкиѕо”молчанию	=	г“аб эшѕараметров«агрузки.—пособ«агрузки;
	ЌовыеЌе—оздавать			=	г“аб эшѕараметров«агрузки.ЌовыеЌе—оздавать;
	—татусѕроведени€			=	г“аб эшѕараметров«агрузки.—татусѕроведени€;
	
	
	≈сли ќбъект”же¬ыгружен(»сточник, “аб–еквизитовѕоиска, »дѕравила, ”зел—сылки, , ѕараметрыѕравила, ЌовыеЌе—оздавать, Ќе—инхронизироватьѕоƒопѕараметрам) = 1 “огда ¬озврат("")  онец≈сли;
	
	
	≈сли ѕустое«начение(»сточник) = 0 “огда
	    ≈сли		“ип»сточника = "—правочник"	“огда
			»сточник.»спользоватьƒату(‘ормƒата он, 1);
		»наче≈сли	“ип»сточника = "—чет"		“огда
			»сточник.»спользоватьƒату(‘ормƒата он);
		 онец≈сли;
	 онец≈сли;
	
	
	XML_DOM					=	гXMLјнализатор.—оздатьƒокумент();
	ѕриемник				=	XML_DOM.—оздать”зел(1, “ег);
	        
	≈сли (ѕустое«начение(”зел—сылки) = 0) » (”зел—сылки <> 1) “огда
		ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
		”зел—сылки	=	ѕриемник.¬ыбрать”зел("—сылка");
	 онец≈сли;
	
	
	”становитьјтрибут(ѕриемник,	"ѕравило", »дѕравила);
	≈сли	(Ќайти("—правочник,ƒокумент", “ипѕриемника) > 0) »
			(Ќайти("—правочник,ƒокумент", “ип»сточника) > 0) “огда
		”становитьјтрибут(ѕриемник,	"ѕометитьЌа”даление",	ѕометка”далени€(»сточник, —татус”далени€));
	 онец≈сли;
	
	
	≈сли 		“ипѕриемника	= "—правочник"		“огда
		
	    ≈сли		“ип»сточника = "—правочник"	“огда
			”становитьјтрибут(ѕриемник,	"Ёто√руппа", »сточник.Ёто√руппа());
		»наче≈сли	“ип»сточника = "—чет"		“огда
			”становитьјтрибут(ѕриемник,	"Ёто√руппа", »сточник.Ёто√руппа());
		 онец≈сли;
		¬ыгрузитьќбъект—правочника(»сточник, ѕриемник, “аб–еквизитов, »дѕравила, —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
		
	»наче≈сли 	“ипѕриемника	= "ƒокумент"		“огда
		
		≈сли “ип»сточника = "ƒокумент"	“огда
			”становитьјтрибут(ѕриемник,	"ќтменитьѕроведение",	ќтменитьѕроведение(»сточник, —татусѕроведени€));
		 онец≈сли;
		¬ыгрузитьƒокумент(»сточник, ѕриемник, “аб–еквизитов, “аб–еквизитов—трок, »дѕравила, —пособ«агрузкиѕо”молчанию, ѕараметрыѕравила);
		
	 онец≈сли;
    
	
	¬озврат("");
	
 онец‘ункции		//	¬ыгрузитьѕоѕравилу()
            
//--------------------------------------------------------------------------------------------------

‘ункци€ ¬ыгрузить»тогиѕоѕравилу(«нач »сточник="", ѕравило="", »дѕравила="", ”зел—сылки=1)

	ѕерем	“аб–еквизитов;
	ѕерем	“аб–еквизитовѕоиска;
	ѕерем	“аб–еквизитов—трок;
	
	≈сли Ќайтиѕравило(»сточник, ѕравило, »дѕравила) = 0	“огда	¬озврат("")	 онец≈сли;
    
	“ипѕриемника					=	г“аб эшѕравил.ѕриемник_“ип;
	“ип»сточника					=	“ип«начени€—тр(»сточник);
	
	ѕараметры«агрузки				=	г“аб эшѕравил.ѕараметры«агрузки;
	ѕреобразование					=	г“аб эшѕравил.ѕреобразование;
	ѕравилоѕереадресации			=	г“аб эшѕравил.ѕравилоѕереадресации;
	»д—инхронизирующего–еквизита	=	г“аб эшѕравил.»д—инхронизирующего–еквизита;
	
	¬ид”слови€						=	г“аб эшѕравил.¬ид”слови€;
	”слови€							=	г“аб эшѕравил.”слови€;
	             
	
	г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
	г“аб эшѕравил.“аб–еквизитовѕоиска.¬ыгрузить(“аб–еквизитовѕоиска);
	г“аб эшѕравил.“аб–еквизитов—трок.¬ыгрузить(“аб–еквизитов—трок);
	
	
	XML_DOM							=	гXMLјнализатор.—оздатьƒокумент();
	ѕриемник						=	XML_DOM.—оздать”зел(1, "ƒокумент");
	
	
	”зел—сылки						=	—оздать”зел—сылки(»сточник, “аб–еквизитовѕоиска, "");
	≈сли (ѕустое«начение(”зел—сылки) = 0) » (”зел—сылки <> 1) “огда
		ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
		”зел—сылки	=	ѕриемник.¬ыбрать”зел("—сылка");
	 онец≈сли;
	
	
	«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
	—татус”далени€				=	г“аб эшѕараметров«агрузки.—татус”далени€;
	—пособ«агрузкиѕо”молчанию	=	г“аб эшѕараметров«агрузки.—пособ«агрузки;
	—татусѕроведени€			=	г“аб эшѕараметров«агрузки.—татусѕроведени€;

	”становитьјтрибут(ѕриемник,	"ѕравило", 				»дѕравила);
	//”становитьјтрибут(ѕриемник,	"ѕометитьЌа”даление",	ѕометка”далени€(»сточник, —татус”далени€));
	//”становитьјтрибут(ѕриемник,	"ќтменитьѕроведение",	ќтменитьѕроведение(»сточник, г“аб эшѕараметров«агрузки.—татусѕроведени€));
	
	//-----------------		–еквизиты	----------------------
	    
	“аб–еквизитов.¬ыбрать—троки();
	ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
		–езультат = ƒобавить–еквизит(“аб–еквизитов, »сточник, ѕриемник, "#ѕолучить", —пособ«агрузкиѕо”молчанию);
		≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
	 онец÷икла;
	                              
	//-----------------		—троки	----------------------
	
	≈сли “аб–еквизитов—трок. оличество—трок() > 0 “огда
		
		Ќомер—троки = 1;
		
		ѕока 1 = 1 ÷икл
			                  
			Ёл_—трока	=	ѕриемник.—оздатьѕодчиненныйЁлемент("—трока");
			“аб–еквизитов—трок.¬ыбрать—троки();
			ѕока “аб–еквизитов—трок.ѕолучить—троку() = 1 ÷икл
				–езультат = ƒобавить–еквизит(“аб–еквизитов—трок, »сточник, Ёл_—трока, "#ѕолучить", —пособ«агрузкиѕо”молчанию);
				≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;	//	ѕолучить след. строку
			 онец÷икла;
			
			Ќомер—троки = Ќомер—троки+1;
			
			≈сли ‘ормћакс олвоѕроводок < Ќомер—троки “огда
				ѕрервать;
			»наче≈сли »сточник.ѕолучить»тог() = 0 “огда
				ѕрервать;
			 онец≈сли;
			
			≈сли ¬ид”слови€ = 1 “огда	//	т.е. условие задано
				ѕока ”слови€¬ыполн€ютс€(”слови€, »сточник) = 0 ÷икл
					‘лѕрервать = 0;
					≈сли »сточник.ѕолучить»тог() = 0 “огда
						‘лѕрервать = 1;
						ѕрервать;
					 онец≈сли;
				 онец÷икла;
				≈сли ‘лѕрервать = 1 “огда ѕрервать  онец≈сли;
			 онец≈сли;
			
		 онец÷икла;
		
	 онец≈сли;
	
	
	«аписатьќбъект¬‘айл(ѕриемник);
	                 
	
	≈сли	(—татусѕроведени€ = "ѕровести")		» 
			(ѕустое«начение(”зел—сылки) = 0)	» (”зел—сылки <> 1) “огда
		XML_DOM						=	гXMLјнализатор.—оздатьƒокумент();
		ѕриемник					=	XML_DOM.—оздать”зел(1, "ѕровестиƒокумент");
		ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
	    ”становитьјтрибут(ѕриемник,	"ѕравило", »дѕравила);
		«аписатьќбъект¬‘айл(ѕриемник);
	 онец≈сли;
	
              
	¬озврат("");
	
 онец‘ункции		//	¬ыгрузить»тогиѕоѕравилу()

//--------------------------------------------------------------------------------------------------

‘ункци€ ¬ыгрузить(»сточник, »дѕравила="", ”зел—сылки=0, ѕараметрыѕравила="", «нач “ипѕриемника="", «нач ¬идѕриемника="")
	
	≈сли ѕустое«начение(»дѕравила) = 0 “огда
		¬озврат	¬ыгрузитьѕоѕравилу(»сточник, , »дѕравила, ”зел—сылки, ѕараметрыѕравила, “ипѕриемника, ¬идѕриемника);
	 онец≈сли;
	
	
	≈сли (ѕустое«начение(—окрЋѕ(»сточник)) = 1) » (“ипѕриемника <> "Ќеопределенный") “огда
		¬озврат("");
	 онец≈сли;
	
	
	“ип»сточника	=	“ип«начени€—тр(»сточник);
	
	≈сли		ѕустое«начение(“ипѕриемника) = 0	“огда
		
		≈сли		Ќайти("—правочник,ƒокумент,—чет,Ќеопределенный", “ипѕриемника) = 0 “огда
			¬озврат	ѕолучить»дќбъекта»сточника(»сточник);
		»наче≈сли	(“ипѕриемника = "Ќеопределенный") » (Ќайти("—правочник,ƒокумент,ѕеречисление,—чет", “ип»сточника) = 0) “огда
			¬озврат	ѕолучить»дќбъекта»сточника(»сточник);
		»наче
			¬озврат ¬ыгрузитьѕоѕравилу(»сточник, , »дѕравила, ”зел—сылки, ѕараметрыѕравила, “ипѕриемника, ¬идѕриемника);
		 онец≈сли;
		
	»наче≈сли	Ќайти("—правочник,ƒокумент", “ип»сточника) = 0 “огда
		
		¬озврат	ѕолучить»дќбъекта»сточника(»сточник);
		
	»наче
		
		¬озврат ¬ыгрузитьѕоѕравилу(»сточник, , »дѕравила, ”зел—сылки, ѕараметрыѕравила, “ипѕриемника, ¬идѕриемника);
		
	 онец≈сли;
	
 онец‘ункции		//	¬ыгрузить()

//--------------------------------------------------------------------------------------------------

‘ункци€ »нтерактивно«аданныеќбъекты(Ёл_ѕравило, »дѕравила, »м€ѕравила)
    
	Ќом—тр			=	"";
	
	≈сли г“абќбъектов.Ќайти«начение(»дѕравила, Ќом—тр, "»дѕравила") = 1 “огда
		—писокќбъектов	=	г“абќбъектов.ѕолучить«начение(Ќом—тр, "—писокќбъектов");
		≈сли ѕустое«начение(—писокќбъектов) = 0 “огда
			≈сли гЅезќткрыти€‘ормы = 1 “огда
				—ообщить("ќбрабатываетс€ правило:  " + »м€ѕравила);
			»наче
				“абќбласть4.“екст	=	»м€ѕравила;
				г онт.“аблица.ѕоказать();
			 онец≈сли;
		    ƒл€ —чќбъектов = 1 ѕо —писокќбъектов.–азмер—писка() ÷икл
				ќбъект	=	—писокќбъектов.ѕолучить«начение(—чќбъектов);
				¬ыгрузитьѕоѕравилу(ќбъект, Ёл_ѕравило, »дѕравила);
		     онец÷икла;
			¬озврат(1);
		 онец≈сли;
	 онец≈сли;
	
	¬озврат(0);
	
 онец‘ункции	//	»нтерактивно«аданныеќбъекты()

//--------------------------------------------------------------------------------------------------
                                                                                                     
‘ункци€ ¬ыгрузитьƒанныеѕоѕравилу(Ёл_ѕравило)
    
	»дѕравила				=	Ёл_ѕравило.ѕолучитьјтрибут("»д");
	»м€ѕравила				=	Ёл_ѕравило.ѕолучитьјтрибут("»м€");
	ѕо—сылкам				=	Ёл_ѕравило.ѕолучитьјтрибут("ѕо—сылкам");
	≈стьѕроцедура¬ыборки	=	Ёл_ѕравило.ѕолучитьјтрибут("≈стьѕроцедура¬ыборки");
	»спользовать¬ладельцев	=	Ёл_ѕравило.ѕолучитьјтрибут("»спользовать¬ладельцев");
    
	
	≈сли »нтерактивно«аданныеќбъекты(Ёл_ѕравило, »дѕравила, »м€ѕравила)	=	1	“огда	¬озврат(1)	 онец≈сли;
	≈сли ѕустое«начение(„исло(ѕо—сылкам))								=	0	“огда	¬озврат(1)	 онец≈сли;	//	продолжаем перебор правил...
        
	
	≈сли ѕустое«начение(≈стьѕроцедура¬ыборки) = 0 “огда
	    –езультат	=	ƒополнительныеѕреобразовани€("ѕравило¬ыборкиќбъектов", »дѕравила );
		≈сли –езультат = "#ѕрервать" “огда
			ѕредупреждение("¬ыгрузка данных прекращена согласно инструкции правила: '" + »м€ѕравила + "' !");
			¬озврат("¬озврат");
		 онец≈сли;
	 онец≈сли;
                                                                           
	
	≈сли ‘орм‘л¬ыгружать“олько»нтерактивные = 1 “огда ¬озврат(1)  онец≈сли;
	
	
	≈сли гЅезќткрыти€‘ормы = 1 “огда
		—ообщить("ќбрабатываетс€ правило:  " + »м€ѕравила);
	»наче
		“абќбласть4.“екст	=	»м€ѕравила;
		г онт.“аблица.ѕоказать();
	 онец≈сли;
	
	
	«агрузитьѕравило(Ёл_ѕравило, »дѕравила);
	
	»сточник_“ип		=	г“аб эшѕравил.»сточник_“ип;
	»сточник_¬ид		=	г“аб эшѕравил.»сточник_¬ид;
	
	ѕриемник_“ип		=	г“аб эшѕравил.ѕриемник_“ип;
	ѕриемник_¬ид		=	г“аб эшѕравил.ѕриемник_¬ид;
	
	
	
	≈сли ѕустое«начение(≈стьѕроцедура¬ыборки) = 1 “огда
		≈сли ѕустое«начение(»сточник_“ип) = 1 “огда	//	возможно это виртуальный объект...
			¬ыгрузитьѕоѕравилу(, Ёл_ѕравило, »дѕравила);
			¬озврат(1);
		 онец≈сли;
	 онец≈сли;
	
	
	//----	¬ыборки	-------------
	
	≈сли 			ѕустое«начение(≈стьѕроцедура¬ыборки) = 0		“огда
		
	»наче≈сли		»сточник_“ип	=	"—правочник"				“огда
		    
		ќбъект¬ыгрузки = —оздатьќбъект("—правочник." + »сточник_¬ид);
		≈сли ѕустое«начение(»спользовать¬ладельцев) = 1 “огда
			ќбъект¬ыгрузки.¬ыбратьЁлементы(0);
			ѕока ќбъект¬ыгрузки.ѕолучитьЁлемент() = 1 ÷икл
				¬ыгрузитьѕоѕравилу(ќбъект¬ыгрузки.“екущийЁлемент(), Ёл_ѕравило, »дѕравила);
			 онец÷икла;
		»наче
			»д¬ладельца			=	ћетаданные.—правочник(»сточник_¬ид).¬ладелец.»дентификатор;
			«апрос				=	"//ѕравило[(ќбъект»сточник/@“ип = ""—правочник"")and(ќбъект»сточник/@¬ид = """ + »д¬ладельца + """)]";
			ѕравила¬ладельца	=	гѕравила.¬ыбрать”злы(«апрос);
			ƒл€ —ч = 0 ѕо ѕравила¬ладельца. оличество”злов() - 1 ÷икл
				ѕравило¬ладельца			=	ѕравила¬ладельца.ѕолучить”зел(—ч);
				»дѕравила¬ладельца			=	ѕравило¬ладельца.ѕолучитьјтрибут("»д");
				//—писок¬ыгруженных¬ладельцев	=	—писок—писков¬ыгруженныхќбъектов.ѕолучить(»дѕравила¬ладельца);
				Ќом—тр						=	"";
				≈сли “аб¬ыгруженныхќбъектов.Ќайти«начение(»дѕравила¬ладельца, Ќом—тр, "»дѕравила") = 0 “огда ѕродолжить  онец≈сли;
				“абќбъектов	=	“аб¬ыгруженныхќбъектов.ѕолучить«начение(Ќом—тр, "“абќбъектов");
				//≈сли “ип«начени€—тр(—писок¬ыгруженных¬ладельцев) <> "—писок«начений" “огда ѕродолжить  онец≈сли;
				//ƒл€ —ч¬ладельцев = 1 ѕо —писок¬ыгруженных¬ладельцев.–азмер—писка() ÷икл
				“абќбъектов.¬ыбрать—троки();
				ѕока “абќбъектов.ѕолучить—троку() = 1 ÷икл
					//—истѕредставление¬ладельца	=	"";
					//—писок¬ыгруженных¬ладельцев.ѕолучить«начение(—ч¬ладельцев, —истѕредставление¬ладельца);
					—истѕредставление¬ладельца	=	“абќбъектов.ќбъект;
					≈сли Ќайти(—истѕредставление¬ладельца, "}") > 0 “огда
						ќтделить–азделителем(—истѕредставление¬ладельца, "}", 1);
					    Ёлемент¬ладелец	=	«начение»з—троки¬нутр(—истѕредставление¬ладельца);
					»наче
						Ёлемент¬ладелец	=	—истѕредставление¬ладельца;
					 онец≈сли;
					ќбъект¬ыгрузки.»спользовать¬ладельца(Ёлемент¬ладелец);
					ќбъект¬ыгрузки.¬ыбратьЁлементы(1);
					ѕока ќбъект¬ыгрузки.ѕолучитьЁлемент() = 1 ÷икл
						¬ыгрузитьѕоѕравилу(ќбъект¬ыгрузки.“екущийЁлемент(), Ёл_ѕравило, »дѕравила);
					 онец÷икла;
				 онец÷икла;
			 онец÷икла;
		 онец≈сли;
		
	»наче≈сли		»сточник_“ип	=	"ƒокумент"					“огда
		
		ќбъект¬ыгрузки	=	—оздатьќбъект("ƒокумент." + »сточник_¬ид);
		ќбъект¬ыгрузки.¬ыбратьƒокументы(‘ормƒатаЌач, ‘ормƒата он);
		ѕока ќбъект¬ыгрузки.ѕолучитьƒокумент() = 1 ÷икл
			¬ыгрузитьѕоѕравилу(ќбъект¬ыгрузки.“екущийƒокумент(), Ёл_ѕравило, »дѕравила);
		 онец÷икла;
	
	»наче≈сли		»сточник_“ип	=	"–егистр"					“огда
		                           
		ќбъект¬ыгрузки	=	—оздатьќбъект("–егистр." + »сточник_¬ид);
		
		ќбъект¬ыгрузки.¬ременный–асчет(1);
		–ассчитать–егистрыѕо(ѕолучитьѕозицию“ј());
		ќбъект¬ыгрузки.¬ыбрать»тоги();
		ѕока ќбъект¬ыгрузки.ѕолучить»тог() = 1 ÷икл
			¬ыгрузить»тогиѕоѕравилу(ќбъект¬ыгрузки, Ёл_ѕравило, »дѕравила);
		 онец÷икла;
		
	»наче≈сли		»сточник_“ип	=	"—чет"						“огда

		ќбъект¬ыгрузки = —оздатьќбъект("—чет." + »сточник_¬ид);
		ќбъект¬ыгрузки.¬ыбрать—чета();
		ѕока ќбъект¬ыгрузки.ѕолучить—чет() = 1 ÷икл
			¬ыгрузитьѕоѕравилу(ќбъект¬ыгрузки.“екущий—чет(), Ёл_ѕравило, »дѕравила);
		 онец÷икла;

	»наче≈сли		»сточник_“ип	=	" онстанта"					“огда
		
		¬ыгрузитьѕоѕравилу(, Ёл_ѕравило, »дѕравила);
		
	»наче≈сли		»сточник_“ип	=	" алендарь"					“огда
		
		¬ыгрузить алендари(Ёл_ѕравило, »дѕравила);
		
	»наче≈сли		»сточник_“ип	=	"ќпераци€"					“огда
	»наче≈сли		»сточник_“ип	=	"¬ид—убконто"				“огда
		
		ƒл€ —ч¬идов—убконто = 1 ѕо ¬иды—убконто. оличество«начений() ÷икл
			¬ыгрузитьѕоѕравилу(¬иды—убконто.«начениеѕоЌомеру(—ч¬идов—убконто), Ёл_ѕравило, »дѕравила);
		 онец÷икла;
		
	»наче≈сли		»сточник_“ип	=	"ѕеречисление"				“огда
		                                  
		¬идѕеречислени€	=	ѕеречисление.ѕолучитьјтрибут(»сточник_¬ид);
		ƒл€ —ч«наченийѕеречислени€ = 1 ѕо ¬идѕеречислени€. оличество«начений() ÷икл
			¬ыгрузитьѕоѕравилу(¬идѕеречислени€.«начениеѕоЌомеру(—ч«наченийѕеречислени€), Ёл_ѕравило, »дѕравила);
		 онец÷икла;
		
	»наче≈сли		»сточник_“ип	=	"ѕлан—четов"				“огда	
	»наче≈сли		»сточник_“ип	=	"¬ид–асчета"				“огда
	»наче≈сли		»сточник_“ип	=	"∆урнал–асчетов"			“огда
	 онец≈сли;

	
	//	над этим еще нужно поработать...
	
	//г—писокќбработанныхѕравил.ƒобавить«начение(»дѕравила);
	//ѕоз	=	г—писокЌеобработанныхѕравил.Ќайти«начение(»дѕравила);
	//≈сли ѕустое«начение(ѕоз) = 0 “огда
	//	г—писокЌеобработанныхѕравил.”далить«начение(ѕоз);
	// онец≈сли;
	
	//≈сли ‘орм‘л«апоминать—сылки = 0 “огда
	//	—писок¬ыгруженныхќбъектов	=	—писок—писков¬ыгруженныхќбъектов.ѕолучить(»дѕравила);
	//	ѕоз							=	—писок—писков¬ыгруженныхќбъектов.Ќайти«начение(—писок¬ыгруженныхќбъектов);
	//	≈сли ѕустое«начение(ѕоз) = 0 “огда
	//		—писок—писков¬ыгруженныхќбъектов.”далить«начение(ѕоз);
	//	 онец≈сли;
	// онец≈сли;
	
	
	¬озврат(1);
	
 онец‘ункции		//	¬ыгрузитьƒанныеѕоѕравилу()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ѕодготовить“аблицуƒл€ѕроведени€()
	
	г“аб эшѕравил.Ќова€ олонка("ѕор€док", "—трока");
	г“аб эшѕравил.¬ыбрать—троки();
	ѕока г“аб эшѕравил.ѕолучить—троку() = 1 ÷икл
		»д						=	г“аб эшѕравил.»д;
		ѕриемник_¬ид			=	г“аб эшѕравил.ѕриемник_¬ид;
		г“аб эшѕравил.ѕор€док	=	—тр«аменить(»д, ѕриемник_¬ид + "_", "");
	 онец÷икла;
	
	
	г“аб эшѕравил.—ортировать("»сточник_“ип + , »сточник_¬ид + , ѕор€док +");
	              
	
	г“аб эшѕравил.”далить олонку("ѕор€док");
	
	
	 опи€“абѕравил	=	—оздатьќбъект("“аблица«начений");
	г“аб эшѕравил.¬ыгрузить( опи€“абѕравил);
	
	
	“аб¬идовƒокументов	=	—оздатьќбъект("“аблица«начений");
	“аб¬идовƒокументов.Ќова€ олонка("¬идƒокумента", "—трока");
	“аб¬идовƒокументов.Ќова€ олонка("—писокѕравил",	"—писок«начений");	//	(Ќомер—троки таблицы правил, »дѕравила)
	
	
	г“аб эшѕравил.¬ыбрать—троки();
	ѕока г“аб эшѕравил.ѕолучить—троку() = 1 ÷икл
		≈сли г“аб эшѕравил.»сточник_“ип <> "ƒокумент" “огда ѕродолжить  онец≈сли;
		                                         
		¬идƒокумента			=	г“аб эшѕравил.»сточник_¬ид;
		»дѕравила				=	г“аб эшѕравил.»д;
		ѕравилоѕереадресации	=	г“аб эшѕравил.ѕравилоѕереадресации;
		Ќом—тр					=	"";
		
		≈сли “аб¬идовƒокументов.Ќайти«начение(¬идƒокумента, Ќом—тр, "¬идƒокумента") = 0 “огда
			“аб¬идовƒокументов.Ќова€—трока(1);
			“аб¬идовƒокументов.¬идƒокумента	=	¬идƒокумента;
			“аб¬идовƒокументов.—писокѕравил	=	—оздатьќбъект("—писок«начений");
		»наче
			“аб¬идовƒокументов.ѕолучить—трокуѕоЌомеру(Ќом—тр);
		 онец≈сли;
		“аб¬идовƒокументов.—писокѕравил.ƒобавить«начение(г“аб эшѕравил.Ќомер—троки, »дѕравила);
		        
		
		≈сли ѕустое«начение(ѕравилоѕереадресации) = 0 “огда
			Ќомѕравилаѕереадр	=	"";
			≈сли   опи€“абѕравил.Ќайти«начение(ѕравилоѕереадресации, Ќомѕравилаѕереадр, "»д") = 1 “огда
				“аб¬идовƒокументов.—писокѕравил.ƒобавить«начение(Ќомѕравилаѕереадр, ѕравилоѕереадресации);
			 онец≈сли;
		 онец≈сли;                    
		
		
	 онец÷икла;
	
	¬озврат(“аб¬идовƒокументов);
	
 онец‘ункции		//	ѕодготовить“аблицуƒл€ѕроведени€()

//--------------------------------------------------------------------------------------------------

‘ункци€ ѕолучить«начение олонки(“аб, »д олонкиѕоиска, «нѕоиска, »д олонки¬озврата)

	Ќом—тр = "";
	≈сли “аб.Ќайти«начение(«нѕоиска, Ќом—тр, »д олонкиѕоиска) = 0 “огда
		¬озврат "";
	»наче
		¬озврат “аб.ѕолучить«начение(Ќом—тр, »д олонки¬озврата);
	 онец≈сли;
	
 онец‘ункции

//--------------------------------------------------------------------------------------------------
                                                                                                    
ѕроцедура ”становитьѕериоды(ƒок, ѕриемник, »дѕравилаƒок="")
	
	ƒл€ —ч∆урналов = 1 ѕо ћетаданные.∆урнал–асчетов() ÷икл
		
		¬ид∆–	=	ћетаданные.∆урнал–асчетов(—ч∆урналов).»дентификатор;
		∆–		=	—оздатьќбъект( "∆урнал–асчетов." + ¬ид∆–);
		ѕравило	=	"";
		
		≈сли ∆–.¬ыбрать«аписиѕоƒокументу(ƒок)	=	0	“огда	ѕродолжить	 онец≈сли;
		≈сли Ќайтиѕравило(∆–, ѕравило, , , , »дѕравилаƒок)			=	0	“огда	ѕродолжить	 онец≈сли;
		                               
		ѕараметры«агрузки	=	г“аб эшѕравил.ѕараметры«агрузки;
		¬ид∆–ѕриемника		=	г“аб эшѕравил.ѕриемник_¬ид;
		
		∆–.ѕолучить«апись();
		
		//	установим период 
		
		¬ѕериоде∆–			=	ѕриемник.—оздатьѕодчиненныйЁлемент("¬ѕериоде∆–");
		”становитьјтрибут(¬ѕериоде∆–,	"¬ид∆–", 	¬ид∆–ѕриемника);
		”становитьјтрибут(¬ѕериоде∆–,	"ƒата", 	‘ормат(∆–.ѕериод–егистрации.ƒатаЌачала, "ƒƒƒћћ√√√√") );
		                                                           
	 онец÷икла;		//	по журналам расчетов
	
 онецѕроцедуры		//	”становитьѕериоды()

//--------------------------------------------------------------------------------------------------

ѕроцедура ¬ыгрузить«аписи(ƒок, »дѕравилаƒок, ”зел—сылки)
	    
	ѕерем	“аб–еквизитов;
	ѕерем	ѕриемник;
	
	ƒл€ —ч∆урналов = 1 ѕо ћетаданные.∆урнал–асчетов() ÷икл
		
		¬ид∆–	=	ћетаданные.∆урнал–асчетов(—ч∆урналов).»дентификатор;
		∆–		=	—оздатьќбъект( "∆урнал–асчетов." + ¬ид∆–);
		
		≈сли ∆–.¬ыбрать«аписиѕоƒокументу(ƒок.“екущийƒокумент())	= 0 “огда ѕродолжить  онец≈сли;
		
		≈сли ѕустое«начение(ѕриемник) = 1 “огда
			XML_DOM				=	гXMLјнализатор.—оздатьƒокумент();
			ѕриемник			=	XML_DOM.—оздать”зел(1, "«аписи∆–ƒокумента");
			ѕриемник.”становитьјтрибут("ѕравило", »дѕравилаƒок);
			ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
		 онец≈сли;
		        
		//‘лѕрервать			=	∆–.ѕолучить«апись();
		//ѕравило	=	"";
		//≈сли Ќайтиѕравило(∆–, ѕравило) = 0 “огда ѕродолжить  онец≈сли;
		//ѕараметры«агрузки	=	г“аб эшѕравил.ѕараметры«агрузки;
		//¬ид∆–ѕриемника		=	г“аб эшѕравил.ѕриемник_¬ид;
		//г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
		
		—осто€ние("¬ыгружаютс€ записи журнала расчетов '" + ¬ид∆– + "' по документу:  " + ƒок);
		
		//«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
		//—пособ«агрузкиѕо”молчанию	=	г“аб эшѕараметров«агрузки.—пособ«агрузки;
		                                                                         
		—пособ«агрузкиѕо”молчанию	=	"";
		
		—ч«аписей	=	1;
		
		ѕока ∆–.ѕолучить«апись() = 1 ÷икл
			ѕравило = "";
			≈сли Ќайтиѕравило(∆–, ѕравило, , , , »дѕравилаƒок) = 0 “огда ѕродолжить  онец≈сли;
			//ѕараметры«агрузки	=	г“аб эшѕравил.ѕараметры«агрузки;
			¬ид∆–ѕриемника		=	г“аб эшѕравил.ѕриемник_¬ид;
			г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
			
			«апись∆– = ѕриемник.—оздатьѕодчиненныйЁлемент("«апись∆–");
			”становитьјтрибут(«апись∆–,	"¬ид∆–", 	¬ид∆–ѕриемника);
			”становитьјтрибут(«апись∆–,	"ƒата", 	‘ормат(∆–.ѕериод–егистрации.ƒатаЌачала, "ƒƒƒћћ√√√√") );
			    
			“аб–еквизитов.¬ыбрать—троки();
			ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
				–езультат = ƒобавить–еквизит(“аб–еквизитов, ∆–, «апись∆–, "#ѕолучить", —пособ«агрузкиѕо”молчанию);
				≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;	//	ѕолучить след. запись
			 онец÷икла;
			
			≈сли ѕустое«начение(«апись∆–.¬ыбрать”зел("–еквизит[@»дентификатор = ""¬ид–асч""]")) = 1 “огда
				ѕриемник.”далитьѕодчиненный(«апись∆–);	//	если не указан вид расчета
			 онец≈сли;
			
			—ч«аписей	=	—ч«аписей + 1;
			≈сли —ч«аписей % 10 = 0 “огда
				—осто€ние("¬ыгружаютс€ записи ∆– '" + ¬ид∆– + "' по документу: " + ƒок + "   ¬ыгружено: " + —ч«аписей);
			 онец≈сли;
		 онец÷икла;		//	по запис€м
		
	 онец÷икла;			//	по журналам расчетов
	            
	
	≈сли ѕустое«начение(ѕриемник) = 0 “огда
		«аписатьќбъект¬‘айл(ѕриемник);
	 онец≈сли;
	
 онецѕроцедуры		//	¬ыгрузить«аписи()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ —оздатьЌовуюѕроводку(”зел, —четƒт="", —чет т="", —умма="",  олво="", ¬алюта="", ¬ал—умма="", —одержаниеѕроводки="", Ќомер∆урнала="", »дѕлана—четов="")
                                 
	≈сли ”зел.»м€“эга = "ѕроводка" “огда
		”зелќперации =	”зел.–одитель;
		”зелќперации.”далитьѕодчиненный(”зел);	// удал€ем  проводку созданную автоматически
		”зел = ”зелќперации;
	 онец≈сли;
	                        
	
	”зелѕроводки = ”зел.—оздатьѕодчиненныйЁлемент("ѕроводка");
	
	
	≈сли ѕустое«начение(—четƒт) = 0 “огда
		”зелѕроводки.”становитьјтрибут("—четƒт",		—четƒт);
	 онец≈сли;
	
	≈сли ѕустое«начение(—чет т) = 0 “огда
		”зелѕроводки.”становитьјтрибут("—чет т",		—чет т);
	 онец≈сли;
	
	≈сли ѕустое«начение(»дѕлана—четов) = 0 “огда
		”зелѕроводки.”становитьјтрибут("ѕлан—четов",	»дѕлана—четов);
	 онец≈сли;
	
	                                                             
	≈сли ѕустое«начение(—умма) = 0 “огда
		–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
		–еквизитѕроводки.”становитьјтрибут("»дентификатор", "—умма");
		–еквизитѕроводки.”становитьјтрибут("«начение",		 —умма);
	 онец≈сли;
	
	≈сли ѕустое«начение(¬ал—умма) = 0 “огда
		–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
		–еквизитѕроводки.”становитьјтрибут("»дентификатор", "¬ал—умма");
		–еквизитѕроводки.”становитьјтрибут("«начение",		 ¬ал—умма);
	 онец≈сли;
	
	≈сли ѕустое«начение( олво) = 0 “огда
		–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
		–еквизитѕроводки.”становитьјтрибут("»дентификатор", " оличество");
		–еквизитѕроводки.”становитьјтрибут("«начение",		  олво);
	 онец≈сли;
	
	≈сли ѕустое«начение(—одержаниеѕроводки) = 0 “огда
		–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
		–еквизитѕроводки.”становитьјтрибут("»дентификатор", "—одержаниеѕроводки");
		–еквизитѕроводки.”становитьјтрибут("«начение",		 —одержаниеѕроводки);
	 онец≈сли;
	
	≈сли ѕустое«начение(Ќомер∆урнала) = 0 “огда
		–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
		–еквизитѕроводки.”становитьјтрибут("»дентификатор", "Ќомер∆урнала");
		–еквизитѕроводки.”становитьјтрибут("«начение",		 Ќомер∆урнала);
	 онец≈сли;
	
	≈сли ѕустое«начение(¬алюта) = 0 “огда
		”зел—сылки			=	1;
		«начение			=	¬ыгрузить(¬алюта, , ”зел—сылки);
		≈сли ”зел—сылки <> 1 “огда
			–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
			–еквизитѕроводки.”становитьјтрибут("»дентификатор", "¬алюта");
			–еквизитѕроводки.ƒобавитьѕодчиненный(”зел—сылки);
		 онец≈сли;
	 онец≈сли;
	
	¬озврат(”зелѕроводки);
	
 онец‘ункции		//	—оздатьЌовуюѕроводку()

//--------------------------------------------------------------------------------------------------
       
‘ункци€ ƒобавить«начение—убконто(ѕравило, ќпераци€, ”зелѕроводки="", ”зелќперации="", ƒт»ли т, «нач «н="#ѕолучить")
	
	»дѕравила–еквизитов	=	"";
	«агрузитьѕравило–еквизитов«начени€(ѕравило, »дѕравила–еквизитов);
	
	»сточник_»д				=	г“аб эш–еквизитов«начений.»сточник_»д;
	
	ѕриемник_»д				=	г“аб эш–еквизитов«начений.ѕриемник_»д;
	ѕриемник_“ип			=	г“аб эш–еквизитов«начений.ѕриемник_“ип;
	ѕриемник_¬ид			=	г“аб эш–еквизитов«начений.ѕриемник_¬ид;
	ѕриемник_ƒлина			=	г“аб эш–еквизитов«начений.ѕриемник_ƒлина;
	
	//”слови€				=	г“аб эш–еквизитов«начений.”слови€;
	¬ид”слови€				=	г“аб эш–еквизитов«начений.¬ид”слови€;
	
	≈стьѕроцедура			=	г“аб эш–еквизитов«начений.≈стьѕроцедура;
	
	ѕараметрыѕравила		=	г“аб эш–еквизитов«начений.ѕараметрыѕравила;
	
	ѕреобразование			=	г“аб эш–еквизитов«начений.ѕреобразование;
	ѕравило¬ыгрузки			=	г“аб эш–еквизитов«начений.ѕравило;


	
	≈сли (ƒт»ли т = "ƒт") » («н = "#ѕолучить") “огда
		»сточник = ќпераци€.ƒебет;
	»наче
		»сточник = ќпераци€. редит;
	 онец≈сли;
	
	                                             
	≈сли	(«н = "#ѕолучить") » (ѕустое«начение(»сточник_»д) = 0)	“огда
		«н	=	»сточник.—убконто(¬иды—убконто.«начениеѕо»дентификатору(»сточник_»д));
		≈сли “ип«начени€—тр(«н) = "—правочник" “огда
			«н.»спользоватьƒату(‘ормƒата он, 1);
		 онец≈сли;
	 онец≈сли;

	
	≈сли ¬ид”слови€ = 1 “огда
		”слови€	=	г“аб эш–еквизитов«начений.”слови€;
		≈сли ”слови€¬ыполн€ютс€(”слови€, «н) = 0 “огда ¬озврат(0)  онец≈сли;
	 онец≈сли;
	
	
    —писокƒопѕараметровѕравила	=	"";
	≈сли ѕустое«начение(≈стьѕроцедура) = 0 “огда
		—писокƒопѕараметровѕравила	=	—оздатьќбъект("—писок«начений");
		«н	=	ƒополнительныеѕреобразовани€("ѕравило–еквизита«начени€", »дѕравила–еквизитов, ќпераци€, ”зелѕроводки, —писокƒопѕараметровѕравила);
		≈сли		«н = 0 “огда
			¬озврат(0);
		»наче≈сли	«н = "#ѕрервать" “огда
			¬озврат("#ѕрервать");	//	Ќе обрабатывать остальные правила субконто
		 онец≈сли;
	 онец≈сли;
	
	
	≈сли		ѕустое«начение(ѕреобразование) = 0	“огда
		«н	=	¬ыполнитьѕреобразование(ѕреобразование, «н, «н, ѕравило¬ыгрузки, ѕриемник_ƒлина);
	»наче≈сли	«н = "#ѕолучить" “огда	// значит это виртуальный объект (которого нет в базе источнике)
		«н				=	"";
	 онец≈сли;
	
	//≈сли ѕустое«начение(ѕравило¬ыгрузки) = 1 “огда
	//	≈сли Ќайтиѕравилоƒл€јтрибута«начени€(«н, , ѕравило¬ыгрузки, ѕравило) = 0 “огда	¬озврат(0)	 онец≈сли;
	// онец≈сли;

	
	≈сли	ѕустое«начение(ѕараметрыѕравила) = 0	“огда
		ѕараметрыѕравила = ѕолучитьѕараметрыѕравила(ѕараметрыѕравила, ќпераци€, «н, —писокƒопѕараметровѕравила);
	 онец≈сли;
	
	
	
	”зел—сылки				=	1;		// означает что нам нужна ссылка
	«начение				=	¬ыгрузить(«н, ѕравило¬ыгрузки, ”зел—сылки, ѕараметрыѕравила, ѕриемник_“ип, ѕриемник_¬ид);
	
	
	≈сли ѕустое«начение(”зелѕроводки)	= 1 “огда ¬озврат(0)  онец≈сли;
	≈сли ѕустое«начение(ѕриемник_»д)	= 1 “огда ¬озврат(0)  онец≈сли;
	
	//-------------- xml --------------
	
	–еквизит	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("—убконто" + ƒт»ли т);
	”становитьјтрибут(–еквизит,	"»дентификатор",	ѕриемник_»д);
	
	≈сли ”зел—сылки <> 1 “огда	// значит узел ссылки создан
		–еквизит.ƒобавитьѕодчиненный(”зел—сылки);
	»наче
		”становитьјтрибут(–еквизит,	"«начение", 	«начение);
	 онец≈сли;
	
	≈сли	(ѕустое«начение(ѕриемник_¬ид) = 1) » ( Ќайти("—правочник,ƒокумент,—чет", ѕриемник_“ип) > 0 )	“огда
		≈сли ѕустое«начение(Ќайтиѕравило(«н, , ѕравило¬ыгрузки)) = 0 “огда
			”становитьјтрибут(–еквизит,	"¬ид«начени€", 	г“аб эшѕравил.ѕриемник_¬ид);
		 онец≈сли;
	 онец≈сли;
	
 онец‘ункции		//	ƒобавить«начение—убконто()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ ¬ыгрузить орреспонденцию(ќпераци€, —чет, ƒт»ли т, ”зелѕроводки, ”зелќперации, «нач »дѕравила="")

	≈сли ѕустое«начение(—чет) = 1 “огда ¬озврат(1)  онец≈сли;
	
	≈сли ƒт»ли т = "ƒт" “огда
		 орреспонденци€ = ќпераци€.ƒебет;
	»наче
		 орреспонденци€ = ќпераци€. редит;
	 онец≈сли;

	ѕравило	=	"";
	≈сли Ќайтиѕравило(—чет, ѕравило, »дѕравила)	= 0	“огда	¬озврат(0)	 онец≈сли;
	
	//	≈сли счет задан вручную, то ищем правило по приемнику
	»д—чета				=	ѕолучить»дќбъекта»сточника(—чет);
	«апрос				=	"«начение[@" + ?(“ип«начени€—тр(—чет)="—чет", "»сточник", "ѕриемник") + "=""" + »д—чета + """]";
	//”зел«начени€		=	ѕравило.¬ыбрать”зел(«апрос);
	
	¬ыборка”злов«начений	=	ѕравило.¬ыбрать”злы(«апрос);
	 олво”злов				=	¬ыборка”злов«начений. оличество”злов();
	”зелЌайден				=	0;
	≈сли		 олво”злов = 1 “огда
		”зелЌайден		=	1;
		”зел«начени€	=	¬ыборка”злов«начений.ѕолучить”зел(0);
	»наче≈сли	 олво”злов > 1 “огда	//	в таком случае считаем что услови€ заданы об€зательно
		ƒл€ —ч = 0 ѕо  олво”злов - 1 ÷икл
			”зел«начени€	=	¬ыборка”злов«начений.ѕолучить”зел(—ч);
			≈сли ”слови€¬ыполн€ютс€(”зел«начени€.¬ыбрать”зел("”слови€"), ќпераци€) = 1 “огда
				”зелЌайден = 1;
				ѕрервать;
			 онец≈сли;
		 онец÷икла;
	 онец≈сли;
	≈сли ”зелЌайден = 0 “огда
		«аписатьќшибку("” правила - " + »дѕравила + " - не найдено соответствие дл€ значени€: " + —чет, "!");
		¬озврат(0);
	 онец≈сли;
	
	//≈сли ѕустое«начение(”зел«начени€) = 1 “огда
	//	«аписатьќшибку("” правила - " + »дѕравила + " - не найдено соответствие дл€ значени€: " + —чет, "!");
	//	¬озврат;
	// онец≈сли;
	
	”становитьјтрибут(”зелѕроводки, "—чет" + ƒт»ли т,	”зел«начени€.ѕолучитьјтрибут("ѕриемник"));
	
	
	≈сли ѕустое«начение(”зел«начени€.ѕолучитьјтрибут("≈стьѕроцедура")) = 0 “огда
		»дѕравила«начени€	=	”зел«начени€.ѕолучитьјтрибут("»д");
		«н					=	ƒополнительныеѕреобразовани€("ѕравило«начени€", »дѕравила«начени€, ќпераци€, ”зелѕроводки);
		≈сли «н = "#”далить“екущуюѕроводку" “огда
			¬озврат(0);
			//”зелќперации.”далитьѕодчиненный(”зелѕроводки);
		 онец≈сли;
		¬озврат(1);
	 онец≈сли;
	
	
	ѕравила—убконто	=	”зел«начени€.¬ыбрать”злы("–еквизит");
	ƒл€ —чѕравил = 0 ѕо ѕравила—убконто. оличество”злов() - 1 ÷икл
		ѕравило—убконто	=	ѕравила—убконто.ѕолучить”зел(—чѕравил);
		–езультат		=	ƒобавить«начение—убконто(ѕравило—убконто, ќпераци€, ”зелѕроводки, ”зелќперации, ƒт»ли т, "#ѕолучить");
		≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
	 онец÷икла;
	               
	¬озврат(1);
	
 онец‘ункции		//	¬ыгрузить орреспонденцию()

//--------------------------------------------------------------------------------------------------

ѕроцедура ¬ыгрузитьќперациюƒокумента(ƒокќперации, ѕриемник, »дѕравила="")
	                                 
	ѕерем	“аб–еквизитов;
	ѕерем	“аб–еквизитов—трок;
	ѕерем	ѕравило;
	
	ќпераци€	=	ƒокќперации.ќпераци€;
	
	≈сли Ќайтиѕравило(ќпераци€, ѕравило, »дѕравила) = 0	“огда	¬озврат	 онец≈сли;

	г“аб эшѕравил.“аб–еквизитов.¬ыгрузить(“аб–еквизитов);
	г“аб эшѕравил.“аб–еквизитов—трок.¬ыгрузить(“аб–еквизитов—трок);
	
	”зелќперации	=	ѕриемник.—оздатьѕодчиненныйЁлемент("ќпераци€");
	”становитьјтрибут(”зелќперации,	"ѕравило", 	»дѕравила);
	
	«агрузитьѕараметры«агрузки("", г“аб эшѕравил.ѕараметры«агрузки);
	—пособ«агрузкиѕо”молчанию	=	г“аб эшѕараметров«агрузки.—пособ«агрузки;
	
	“аб–еквизитов.¬ыбрать—троки();
	ѕока “аб–еквизитов.ѕолучить—троку() = 1 ÷икл
		–езультат = ƒобавить–еквизит(“аб–еквизитов, ќпераци€, ”зелќперации, "#ѕолучить", —пособ«агрузкиѕо”молчанию);
		≈сли –езультат = "#ѕрервать" “огда ѕрервать  онец≈сли;
	 онец÷икла;
	
	
	ќпераци€.¬ыбратьѕроводки();
	ѕока ќпераци€.ѕолучитьѕроводку() = 1 ÷икл
		
		”зелѕроводки	=	”зелќперации.—оздатьѕодчиненныйЁлемент("ѕроводка");
		”становитьјтрибут(”зелѕроводки,	"—ложна€", 	ќпераци€.—ложна€ѕроводка() );
		
		≈сли ќпераци€.ѕлан—четов() <> ќсновнойѕлан—четов() “огда
			”становитьјтрибут(”зелѕроводки,	"ѕлан—четов", 	ќпераци€.ѕлан—четов().»дентификатор());
		 онец≈сли;
		
		“аб–еквизитов—трок.¬ыбрать—троки();
		ѕока “аб–еквизитов—трок.ѕолучить—троку() = 1 ÷икл
			
			»дѕравила–еквизитов		=	“аб–еквизитов—трок.»д;
			¬ид”слови€				=	“аб–еквизитов—трок.¬ид”слови€;
			≈стьѕроцедура			=	“аб–еквизитов—трок.≈стьѕроцедура;
			
			≈сли		¬ид”слови€ = 1 “огда	//	условие задано по операции
				”слови€					=	“аб–еквизитов—трок.”слови€;
				≈сли ”слови€¬ыполн€ютс€(”слови€, ќпераци€) = 0 “огда ѕродолжить  онец≈сли;
			»наче≈сли	¬ид”слови€ = 2 “огда	//	условие задано по реквизиту (атрибуту) проводки
				”слови€					=	“аб–еквизитов—трок.”слови€;
			 онец≈сли;
			
			»сточник_»д				=	“аб–еквизитов—трок.»сточник_»д;
			»сточник_“ипјтрибута	=	“аб–еквизитов—трок.»сточник_“ипјтрибута;
			
			ѕриемник_»д				=	“аб–еквизитов—трок.ѕриемник_»д;
			ѕриемник_“ипјтрибута	=	“аб–еквизитов—трок.ѕриемник_“ипјтрибута;
			ѕриемник_“ип			=	“аб–еквизитов—трок.ѕриемник_“ип;
			ѕриемник_¬ид			=	“аб–еквизитов—трок.ѕриемник_¬ид;
			ѕриемник_ƒлина			=	“аб–еквизитов—трок.ѕриемник_ƒлина;
			
			ѕреобразование			=	“аб–еквизитов—трок.ѕреобразование;
			ѕравило¬ыгрузки			=	“аб–еквизитов—трок.ѕравило;
			
			ѕараметрыѕравила		=	“аб–еквизитов—трок.ѕараметрыѕравила;
			//ѕолучить»зѕараметров	=	“аб–еквизитов—трок.ѕолучить»зѕараметров;
			
			—пособ«агрузки			=	“аб–еквизитов—трок.—пособ«агрузки;
			
			
			                  
			ѕрерватьѕослеќбработки	=	0;
			≈сли		ѕустое«начение(≈стьѕроцедура) = 0	“огда
				«н	=	ƒополнительныеѕреобразовани€("ѕравило–еквизита", »дѕравила–еквизитов, ќпераци€, ”зелѕроводки);
				≈сли		«н = 0 “огда
					ѕродолжить;
				»наче≈сли	«н = "#ѕрервать" “огда
					ѕрервать;	//	ѕолучить следующую проводку
				»наче≈сли	«н = "#ѕрерватьѕослеќбработки" “огда
					≈стьѕроцедура			=	0;
					ѕрерватьѕослеќбработки	=	1;
				»наче≈сли	«н = "#”далить“екущуюѕроводку" “огда
					”зелќперации.”далитьѕодчиненный(”зелѕроводки);
					ѕрервать;	//	ѕолучить следующую проводку
				 онец≈сли;
			 онец≈сли;
			
			
			//	получаем значение реквизита объекта источника
			                                                     
			≈сли ѕустое«начение(≈стьѕроцедура) = 1 “огда
				
				≈сли		»сточник_“ипјтрибута = "ћ"			“огда
					«н	=	ѕолучить«начениећетодом(ќпераци€, »сточник_»д);
				»наче≈сли	»сточник_»д = "—четƒт"				“огда
					«н	=	ќпераци€.ƒебет.—чет;
				»наче≈сли	»сточник_»д = "—чет т"				“огда
					«н	=	ќпераци€. редит.—чет;
				»наче≈сли	ѕустое«начение(»сточник_»д) = 1		“огда
					«н	=	"";
				»наче
					«н	=	ќпераци€.ѕолучитьјтрибут(»сточник_»д);
				 онец≈сли;
				
			 онец≈сли;
			
			
			≈сли ¬ид”слови€ = 2 “огда	//	т.е. задано условие по реквизиту (атрибуту) проводки
				≈сли ”слови€¬ыполн€ютс€(”слови€, «н) = 0 “огда ѕродолжить  онец≈сли;
			 онец≈сли;
			
			
			//	выполн€ем преобразовани€
			
			≈сли		ѕустое«начение(ѕреобразование) = 0	“огда
				«н	=	¬ыполнитьѕреобразование(ѕреобразование, ќпераци€, «н, ѕравило¬ыгрузки, ѕриемник_ƒлина);
			 онец≈сли;
            
			                                                         
			≈сли	ѕустое«начение(»сточник_»д) = 0		“огда
				≈сли	(—пособ«агрузки				=	"«амещатьЌеѕустыми")	»ли 
						((—пособ«агрузкиѕо”молчанию	=	"«амещатьЌеѕустыми")	»	(ѕустое«начение(—пособ«агрузки) = 1))	“огда
					≈сли ѕустое«начение(«н) = 1 “огда ѕродолжить  онец≈сли;
				 онец≈сли;
			 онец≈сли;
		
			
			//	устанавливаем реквизиты приемника
			
			≈сли		ѕриемник_“ипјтрибута = "ћ"	“огда
				
				≈сли ѕриемник_»д = "ѕлан—четов()" “огда
					”становитьјтрибут(”зелѕроводки,	"ѕлан—четов", 	«н);
				 онец≈сли;
				
			»наче≈сли	ѕриемник_»д = "—четƒт"		“огда
				
				≈сли ¬ыгрузить орреспонденцию(ќпераци€,	«н,	"ƒт",	”зелѕроводки,	”зелќперации,	ѕравило¬ыгрузки) = 0 “огда
					”зелќперации.”далитьѕодчиненный(”зелѕроводки);
					ѕрервать;	//	ѕолучить следующую проводку
				 онец≈сли;
				
			»наче≈сли	ѕриемник_»д = "—чет т"		“огда
				
				≈сли ¬ыгрузить орреспонденцию(ќпераци€,	«н,	" т",	”зелѕроводки,	”зелќперации,	ѕравило¬ыгрузки) = 0 “огда
					”зелќперации.”далитьѕодчиненный(”зелѕроводки);
					ѕрервать;	//	ѕолучить следующую проводку
				 онец≈сли;
				
			»наче	//	–еквизиты проводки
				
				”зел—сылки			=	1;		// означает что нам нужна ссылка
				«начение			=	¬ыгрузить(«н, ѕравило¬ыгрузки, ”зел—сылки, ѕараметрыѕравила, ѕриемник_“ип, ѕриемник_¬ид);
				         
				
				≈сли (”зел—сылки = 1) » (ѕустое«начение(«начение) = 1) “огда ѕродолжить  онец≈сли;	//	пустые здесь не выгружаем однозначно
				–еквизитѕроводки	=	”зелѕроводки.—оздатьѕодчиненныйЁлемент("–еквизит");
				”становитьјтрибут(–еквизитѕроводки, "»дентификатор",	ѕриемник_»д);
				≈сли		”зел—сылки <> 1 “огда	// узел ссылки создан
					–еквизитѕроводки.ƒобавитьѕодчиненный(”зел—сылки);
				»наче
					”становитьјтрибут(–еквизитѕроводки,	"«начение",	«начение);
				 онец≈сли;
				≈сли	(ѕриемник_“ип	=	"Ќеопределенный") »ли
						((ѕустое«начение(ѕриемник_¬ид) = 1) » (Ќайти("—правочник,ƒокумент,—чет", ѕриемник_“ип) > 0)) “огда
					≈сли ѕустое«начение(Ќайтиѕравило(«н, , ѕравило¬ыгрузки)) = 0 “огда
						”становитьјтрибут(–еквизитѕроводки,	"“ип«начени€", 	г“аб эшѕравил.ѕриемник_“ип);
						”становитьјтрибут(–еквизитѕроводки,	"¬ид«начени€", 	г“аб эшѕравил.ѕриемник_¬ид);
					 онец≈сли;
				 онец≈сли;
				
			 онец≈сли;
			              
			≈сли ѕрерватьѕослеќбработки = 1 “огда ѕрервать  онец≈сли;	//	ѕолучить следующую проводку
			
		 онец÷икла;		//	по реквизитам
		
	 онец÷икла;		//	по проводкам

 онецѕроцедуры		//	¬ыгрузитьќперациюƒокумента()

//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ «аписатьѕроведениеƒокументаѕоѕравилу(ƒок, Ќом—тр)
    
	ѕерем	“аб–еквизитовѕоиска;
	
	г“аб эшѕравил.ѕолучить—трокуѕоЌомеру( Ќом—тр );
	
	//”слови€					=	г“аб эшѕравил.”слови€;
	//¬ид”слови€				=	г“аб эшѕравил.¬ид”слови€;
	
	»дѕравила					=	г“аб эшѕравил.»д;
	ѕараметры«агрузки			=	г“аб эшѕравил.ѕараметры«агрузки;
	//ѕравило					=	г“аб эшѕравил.ѕравило;
	
	”зел—сылки					=	1;
	
	г“аб эшѕравил.“аб–еквизитовѕоиска.¬ыгрузить(“аб–еквизитовѕоиска);
	
	
	≈сли		ќбъект”же¬ыгружен(ƒок, “аб–еквизитовѕоиска, »дѕравила, ”зел—сылки, "ѕроведение") = 0 “огда
		¬озврат(0);		//	возможно документ выгружен по другому правилу
	»наче≈сли	(ѕустое«начение(”зел—сылки) = 1) »ли (”зел—сылки = 1) “огда
		¬озврат(1); 	//	получить следующий документ из выборки
	 онец≈сли;
	
	
	«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
	
	//«амещатьЌайденные			=	г“аб эшѕараметров«агрузки.«амещатьЌайденные;
	—татусѕроведени€			=	г“аб эшѕараметров«агрузки.—татусѕроведени€;
	//«агружать«аписи∆–			=	г“аб эшѕараметров«агрузки.«агружать«аписи∆–;
	    
	
	//≈сли	«амещатьЌайденные = 0 “огда ¬озврат(1)  онец≈сли;	//	откуда нам знать найдетс€ он или нет...
	
	
	≈сли Ќужноѕровести(ƒок, —татусѕроведени€) = 0 “огда ¬озврат(0)  онец≈сли;	//	возможно документ нужно проводить по другому правилу
	
	
	//	“.к. объект уже выгружен по данному правилу, значит он удовлетвор€ет услови€м
	//
	//≈сли ¬ид”слови€ = 1 “огда	//	т.е. условие задано
	//	≈сли ”слови€¬ыполн€ютс€(”слови€, ƒок, »дѕравила) = 0 “огда ¬озврат(0)  онец≈сли; //	попробуем по следующему правилу
	// онец≈сли;
	
		 
	ќбъектћƒ					=	ћетаданные.ƒокумент(ƒок.¬ид());
	XML_DOM						=	гXMLјнализатор.—оздатьƒокумент();
	ѕриемник					=	XML_DOM.—оздать”зел(1, "ѕровестиƒокумент");
	ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
	
    ”становитьјтрибут(ѕриемник, "ѕравило", »дѕравила);
	
	
	//----------	≈сли документ бухгалтерский	----------------------
	
	≈сли ќбъектћƒ.Ѕухгалтерский”чет	=	1 “огда
		≈сли	ƒок.—уществуетќпераци€() = 1	“огда
			—татусѕроводок		=	г“аб эшѕараметров«агрузки.—татусѕроводок;
			«агружатьќперации	=	г“аб эшѕараметров«агрузки.«агружатьќперации;
			ѕравилоќпераций		=	г“аб эшѕараметров«агрузки.ѕравилоќпераций;
			”становитьјтрибут(ѕриемник,	"¬ыключитьѕроводки",	¬ыключитьѕроводки(ƒок, —татусѕроводок));
			≈сли	(ѕустое«начение(«агружатьќперации) = 0) » (ќбъектћƒ.—оздаватьќперацию <> "“олькоѕриѕроведении") “огда
				¬ыгрузитьќперациюƒокумента(ƒок, ѕриемник, ѕравилоќпераций);
			 онец≈сли;
		 онец≈сли;
	 онец≈сли;
	
	
	//----------	≈сли документ расчетный	--------------------------
	
	≈сли ќбъектћƒ.–асчет = 1 “огда
		”становитьѕериоды(ƒок, ѕриемник, »дѕравила);
	 онец≈сли;
	
	
	«аписатьќбъект¬‘айл(ѕриемник);
	
	¬озврат(0);		//	существуют ситуации, когда один документ превращаетс€ в несколько по разным правилам...
		
 онец‘ункции		//	«аписатьѕроведениеƒокументаѕоѕравилу()

//--------------------------------------------------------------------------------------------------
                                                                                                    
ѕроцедура ѕроведениеƒокументов()
	
	“аб¬идовƒокументов	=	ѕодготовить“аблицуƒл€ѕроведени€();
	    
	—ч					=	0;
	ƒокѕроведени€		=	—оздатьќбъект("ƒокумент");
	ƒокѕроведени€.ќбратныйѕор€док(0);
	//ƒокѕроведени€.¬ыбратьƒокументы(‘ормƒатаЌач, ‘ормƒата он);		// нужно учесть док-ты, выгружаемые по ссылкам
	ƒокѕроведени€.¬ыбратьƒокументы();
	ѕока ƒокѕроведени€.ѕолучитьƒокумент() = 1 ÷икл
		¬идƒокумента	=	ƒокѕроведени€.¬ид();
		—писокѕравил	=	ѕолучить«начение олонки(“аб¬идовƒокументов, "¬идƒокумента", ¬идƒокумента, "—писокѕравил");
		≈сли ѕустое«начение(—писокѕравил) = 1 “огда ѕродолжить  онец≈сли;
		
		//—писокѕравил.—ортироватьѕоѕредставлению();
		
		ƒл€ —чѕравил = 1 ѕо —писокѕравил.–азмер—писка() ÷икл
			
			≈сли «аписатьѕроведениеƒокументаѕоѕравилу(ƒокѕроведени€.“екущийƒокумент(), —писокѕравил.ѕолучить«начение(—чѕравил)) = 1 “огда
				ѕрервать;	//	получить из выборки следующий документ
			 онец≈сли;
			
		 онец÷икла;
		
	 онец÷икла;

 онецѕроцедуры		//	ѕроведениеƒокументов()
              
//--------------------------------------------------------------------------------------------------
                                                                                                    
‘ункци€ «аписи∆–ƒокументаѕоѕравилу(ƒок, Ќом—тр)
    
	ѕерем	“аб–еквизитовѕоиска;
	
	г“аб эшѕравил.ѕолучить—трокуѕоЌомеру( Ќом—тр );
	
	//”слови€					=	г“аб эшѕравил.”слови€;
	//¬ид”слови€				=	г“аб эшѕравил.¬ид”слови€;
	
	»дѕравила					=	г“аб эшѕравил.»д;
	ѕараметры«агрузки			=	г“аб эшѕравил.ѕараметры«агрузки;
	//ѕравило					=	г“аб эшѕравил.ѕравило;
	”зел—сылки					=	1;
	
	г“аб эшѕравил.“аб–еквизитовѕоиска.¬ыгрузить(“аб–еквизитовѕоиска);
	    
	
	≈сли		ќбъект”же¬ыгружен(ƒок, “аб–еквизитовѕоиска, »дѕравила, ”зел—сылки, "ѕроведение") = 0 “огда
		¬озврат(0);		//	документ может быть выгружен по другому правилу
	»наче≈сли	(ѕустое«начение(”зел—сылки) = 1) »ли (”зел—сылки = 1) “огда
		¬озврат(1); 	//	получить следующий документ из выборки
	 онец≈сли;
	
	
	«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
	
	//«амещатьЌайденные			=	г“аб эшѕараметров«агрузки.«амещатьЌайденные;
	«агружать«аписи∆–			=	г“аб эшѕараметров«агрузки.«агружать«аписи∆–;
	                 
	//≈сли ѕустое«начение(«амещатьЌайденные) = 1 “огда	¬озврат(0)	 онец≈сли;		//	откуда нам знать найдетс€ он или нет...
	
	≈сли ѕустое«начение(«агружать«аписи∆–) = 1 “огда ¬озврат(0)  онец≈сли;	//	записи могут выгружатьс€ по другому правилу
	
	
	//	“.к. объект уже выгружен по данному правилу, значит он удовлетвор€ет услови€м
	//
	//≈сли ¬ид”слови€ = 1 “огда	//	т.е. условие задано
	//	≈сли ”слови€¬ыполн€ютс€(”слови€, ƒок, »дѕравила) = 0 “огда ¬озврат(0)  онец≈сли;		//	попробуем по следующему правилу
	// онец≈сли;
	             
	¬ыгрузить«аписи(ƒок, »дѕравила, ”зел—сылки);
	
	¬озврат(0);
		
 онец‘ункции		//	«аписи∆–ƒокументаѕоѕравилу()

//--------------------------------------------------------------------------------------------------

ѕроцедура «аписи∆–ƒокументов()
	
	“аб¬идовƒокументов	=	ѕодготовить“аблицуƒл€ѕроведени€();
	    
	—ч					=	0;
	ƒокѕроведени€		=	—оздатьќбъект("ƒокумент");
	ƒокѕроведени€.ќбратныйѕор€док(0);
	ƒокѕроведени€.”становить‘ильтр(1, 1, 0, 1, 2, 1);
	//ƒокѕроведени€.¬ыбратьƒокументы(‘ормƒатаЌач, ‘ормƒата он);
	ƒокѕроведени€.¬ыбратьƒокументы();
	ѕока ƒокѕроведени€.ѕолучитьƒокумент() = 1 ÷икл
		¬идƒокумента	=	ƒокѕроведени€.¬ид();
		—писокѕравил	=	ѕолучить«начение олонки(“аб¬идовƒокументов, "¬идƒокумента", ¬идƒокумента, "—писокѕравил");
		≈сли ѕустое«начение(—писокѕравил) = 1 “огда ѕродолжить  онец≈сли;
		            
		//—писокѕравил.—ортироватьѕоѕредставлению();
		
		ƒл€ —чѕравил = 1 ѕо —писокѕравил.–азмер—писка() ÷икл
			
			≈сли «аписи∆–ƒокументаѕоѕравилу(ƒокѕроведени€.“екущийƒокумент(), —писокѕравил.ѕолучить«начение(—чѕравил)) = 1 “огда
				ѕрервать;	//	получить следующий документ из выборки
			 онец≈сли;
			
		 онец÷икла;
		
	 онец÷икла;

 онецѕроцедуры		//	«аписи∆–ƒокументов()

//--------------------------------------------------------------------------------------------------

ѕроцедура «аписатьќперациюЅух»тогов(ƒок)
		                                             
	»дѕравила	=	"";
	”зел—сылки	=	1;
	¬ыгрузить(ƒок, »дѕравила, ”зел—сылки, г олвоќпераций—ќстатками);
	
	//	“.к. объект реально существует только в пам€ти, то «начение¬—троку¬нутр() возвращает
	//	всегда одно и то же, поэтому указываем параметр "г олвоќпераций—ќстатками", дабы функци€
	//	ќбъект”же¬ыгружен() правильно отрабатывала...
	
	XML_DOM						=	гXMLјнализатор.—оздатьƒокумент();
	ѕриемник					=	XML_DOM.—оздать”зел(1, "ѕровестиƒокумент");
	ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
	
    ”становитьјтрибут(ѕриемник,	"ѕравило", »дѕравила);
	
	¬ыгрузитьќперациюƒокумента(ƒок, ѕриемник);
	
	«аписатьќбъект¬‘айл(ѕриемник);
	
 онецѕроцедуры		//	«аписатьќперациюЅух»тогов()

//--------------------------------------------------------------------------------------------------

ѕроцедура јрхивированиеƒокументов()
	
	ѕерем	“аб–еквизитовѕоиска;
	    
	—писок∆–	=	—оздатьќбъект("—писок«начений");
	ƒл€ —ч = 1 по ћетаданные.∆урнал–асчетов() ÷икл
		»д∆–	=	ћетаданные.∆урнал–асчетов(—ч).»дентификатор;
		—писок∆–.ƒобавить«начение( —оздатьќбъект("∆урнал–асчетов." + »д∆–), »д∆–);
	 онец÷икла;
	
	“аб¬идовƒокументов	=	ѕодготовить“аблицуƒл€ѕроведени€();
	
	XML_DOM				=	гXMLјнализатор.—оздатьƒокумент();
	ѕриемник			=	XML_DOM.—оздать”зел(1, "јрхивироватьƒокументы");
	
	ƒок					=	—оздатьќбъект("ƒокумент");
	
	ƒок.ќбратныйѕор€док(0);
	ƒок.”становить‘ильтр(1, 1, 0, 1, 2, 1);
	//ƒок.¬ыбратьƒокументы(‘ормƒатаЌач, ‘ормƒата он);
	ƒок.¬ыбратьƒокументы();
	ѕока ƒок.ѕолучитьƒокумент() = 1 ÷икл
		¬идƒокумента	=	ƒок.¬ид();
		—писокѕравил	=	ѕолучить«начение олонки(“аб¬идовƒокументов, "¬идƒокумента", ¬идƒокумента, "—писокѕравил");
		≈сли ѕустое«начение(—писокѕравил) = 1 “огда ѕродолжить  онец≈сли;
		            
		//—писокѕравил.—ортироватьѕоѕредставлению();
		
		ƒл€ —чѕравил = 1 ѕо —писокѕравил.–азмер—писка() ÷икл
			
			г“аб эшѕравил.ѕолучить—трокуѕоЌомеру( —писокѕравил.ѕолучить«начение(—чѕравил) );
			
			”зел—сылки					=	1;
			
			//”слови€					=	г“аб эшѕравил.”слови€;
			//¬ид”слови€				=	г“аб эшѕравил.¬ид”слови€;
			
			»дѕравила					=	г“аб эшѕравил.»д;
			ѕараметры«агрузки			=	г“аб эшѕравил.ѕараметры«агрузки;
			//ѕравило					=	г“аб эшѕравил.ѕравило;
			ѕриемник_¬ид				=	г“аб эшѕравил.ѕриемник_¬ид;
			
			
			г“аб эшѕравил.“аб–еквизитовѕоиска.¬ыгрузить(“аб–еквизитовѕоиска);

			
			≈сли		ќбъект”же¬ыгружен(ƒок.“екущийƒокумент(), “аб–еквизитовѕоиска, »дѕравила, ”зел—сылки, "ѕроведение") = 0	“огда
				ѕродолжить;		//	возможно документ архивный по другому правилу
			»наче≈сли	(ѕустое«начение(”зел—сылки) = 1) »ли (”зел—сылки = 1) “огда
				ѕрервать;		//	получить следующий документ из выборки
			 онец≈сли;		
			  
			
			//	“.к. объект уже выгружен по данному правилу, значит он удовлетвор€ет услови€м
			//
			//≈сли ¬ид”слови€ = 1 “огда	//	т.е. условие задано
			//	≈сли ”слови€¬ыполн€ютс€(”слови€, ƒок, »дѕравила) = 0 “огда ѕродолжить  онец≈сли;	//	попробуем по следующему правилу
			// онец≈сли;
			
			
			«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
			—татус–асчетныхƒокументов	=	г“аб эшѕараметров«агрузки.—татус–асчетныхƒокументов;
			                         
			≈сли —татус–асчетныхƒокументов = "Ќејрхивировать" “огда ѕродолжить  онец≈сли;	//	возможно нужно архивировать по другому правилу
				                              
			”зел—сылки.”становитьјтрибут("¬ид", ѕриемник_¬ид);
			
			
			≈сли —татус–асчетныхƒокументов = "јрхивировать" “огда
				ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
				ѕродолжить;
			 онец≈сли;
			             
			
			//	≈сли —татус–асчетныхƒокументов = "јвто"
			            
			ƒл€ —ч∆– = 1 по —писок∆–.–азмер—писка() ÷икл
				∆– = —писок∆–.ѕолучить«начение(—ч∆–);
				
				∆–.¬ыбрать«аписиѕоƒокументу(ƒок.“екущийƒокумент());
				≈сли ∆–.ѕолучить«апись()=1 “огда
					Ќайтиѕравило(∆–, , , , , »дѕравила);
					ѕериодичность	=	г“аб эшѕравил.”никальность;
					ƒатаќтсчета		=	г“аб эшѕравил.ƒатаќтсчета;
					
					≈сли		ѕериодичность = "ƒень" тогда
						ƒатаЌачалаѕериодаѕриемника = ∆–. онец“екущегоѕериода();
					»наче≈сли ѕериодичность = "Ќедел€" тогда
						ƒатаЌачалаѕериодаѕриемника = ЌачЌедели(∆–. онец“екущегоѕериода());
						—мещение = ƒатаќтсчета - ЌачЌедели(ƒатаќтсчета);
						ƒатаЌачалаѕериодаѕриемника = ƒатаЌачалаѕериодаѕриемника + —мещение;
					»наче≈сли ѕериодичность = "ћес€ц" тогда
						ƒатаЌачалаѕериодаѕриемника = Ќачћес€ца(∆–. онец“екущегоѕериода());
						—мещение = ƒатаќтсчета - Ќачћес€ца(ƒатаќтсчета);
						ƒатаЌачалаѕериодаѕриемника = ƒатаЌачалаѕериодаѕриемника + —мещение;
					»наче≈сли ѕериодичность = " вартал" тогда
						ƒатаЌачалаѕериодаѕриемника = Ќач вартала(∆–. онец“екущегоѕериода());
						—мещение = ƒатаќтсчета - Ќач вартала(ƒатаќтсчета);
						ƒатаЌачалаѕериодаѕриемника = ƒатаЌачалаѕериодаѕриемника + —мещение;
					»наче≈сли ѕериодичность = "√од" тогда
						ƒатаЌачалаѕериодаѕриемника = Ќач√ода(∆–. онец“екущегоѕериода());
						—мещение = ƒатаќтсчета - Ќач√ода(ƒатаќтсчета);
						ƒатаЌачалаѕериодаѕриемника = ƒатаЌачалаѕериодаѕриемника + —мещение;
					 онец≈сли;
					//≈сли ∆–.ѕериод–егистрации.ƒатаЌачала < ∆–.“екущийѕериод().ƒатаЌачала “огда
					≈сли ∆–.ѕериод–егистрации.ƒатаЌачала < ƒатаЌачалаѕериодаѕриемника “огда
						ѕриемник.ƒобавитьѕодчиненный(”зел—сылки);
						ѕрервать;	//	прервать перебор записей ∆–
					 онец≈сли;
				 онец≈сли;
			 онец÷икла;
			
		 онец÷икла;		//	по списку правил
		
	 онец÷икла;			//	по документам
	
	
	≈сли ѕустое«начение(ѕриемник.¬ыбрать”зел("—сылка")) = 0 “огда	//	если хоть одна есть...
		«аписатьќбъект¬‘айл(ѕриемник);
	 онец≈сли;

 онецѕроцедуры		//	јрхивированиеƒокументов()

//--------------------------------------------------------------------------------------------------

ѕроцедура ”становитьѕараметрыѕо”молчанию()

	г“аб эшѕараметров«агрузки.Ќова€—трока();
	г“аб эшѕараметров«агрузки.»д						=	"ѕараметрыѕо”молчанию";
	г“аб эшѕараметров«агрузки.ƒата						=	–абоча€ƒата();
	г“аб эшѕараметров«агрузки.«амещатьЌайденные			=	1;
	г“аб эшѕараметров«агрузки.—пособ«агрузки			=	"«амещатьЌеѕустыми";
	г“аб эшѕараметров«агрузки.ЌовыеЌе—оздавать			=	0;
	г“аб эшѕараметров«агрузки.—татус”далени€			=	"јвто";
	г“аб эшѕараметров«агрузки.—татусѕроводок			=	"јвто";
	г“аб эшѕараметров«агрузки.—татусѕроведени€			=	"јвто";
	г“аб эшѕараметров«агрузки.—татус–асчетныхƒокументов	=	"јвто";
	г“аб эшѕараметров«агрузки.«агружатьќперации			=	1;
	г“аб эшѕараметров«агрузки.ѕравилоќпераций			=	"";
	г“аб эшѕараметров«агрузки.«агружать«аписи∆–			=	1;
	
 онецѕроцедуры		//	”становитьѕараметрыѕо”молчанию()
                          
//--------------------------------------------------------------------------------------------------ь

ѕроцедура »нициализировать—истемныеќбласти“аблицы()

	“абќбласть2	=	г онт.“аблица.ќбласть(1, 1, 1, 2);
	“абќбласть2.ќбъединить();
	“абќбласть2.√оризонтальноеѕоложение(3);
	“абќбласть2. онтроль(1);
	“абќбласть2.¬ысота—троки(18);
	“абќбласть2.–амкаќбвести(2, 2, 2, 2);
	“абќбласть2.“екст	=	"Ќачало выгрузки  -  " + “екущее¬рем€();
	
	“абќбласть3	=	г онт.“аблица.ќбласть(1, 3, 1, 4);
	“абќбласть3.ќбъединить();
	“абќбласть3.√оризонтальноеѕоложение(3);
	“абќбласть3. онтроль(1);
	“абќбласть3.¬ысота—троки(18);
	“абќбласть3.–амкаќбвести(2, 2, 2, 2);
	“абќбласть3.“екст	=	" онец выгрузки -  ";

	“абќбласть1	=	г онт.“аблица.ќбласть(2, 1, 2, 4);
	“абќбласть1.ќбъединить();
	“абќбласть1.√оризонтальноеѕоложение(3);
	“абќбласть1. онтроль(1);
	“абќбласть1.¬ысота—троки(22);
	“абќбласть1.“екст	=	"ќбрабатываетс€ правило:";
	
	“абќбласть4	=	г онт.“аблица.ќбласть(3, 1, 3, 4);
	“абќбласть4.ќбъединить();
	“абќбласть4.√оризонтальноеѕоложение(3);
	“абќбласть4. онтроль(1);
	“абќбласть4.¬ысота—троки(22);
	“абќбласть4.“екст	=	"";

	//г онт.“аблица.ѕоказать();
	
 онецѕроцедуры

//--------------------------------------------------------------------------------------------------

ѕроцедура ¬ыгрузитьƒанные()
	                                 
	≈сли ћетаданные.ѕлан—четов(1).¬ыбран() = 1 “огда
		гЅух»тоги = —оздатьќбъект("Ѕухгалтерские»тоги");
	 онец≈сли;
	
	»нициализировать—истемныеќбласти“аблицы();

	г—четчик¬ыгруженныхќбъектов				=	0;
	//—писок—писков¬ыгруженныхќбъектов		=	—оздатьќбъект("—писок«начений"); 
	
	—писок”зловƒобавл€емыхѕослеѕроведени€	=	—оздатьќбъект("—писок«начений");
	
	“аб¬ыгруженныхќбъектов					=	—оздатьќбъект("“аблица«начений");
	“аб¬ыгруженныхќбъектов.Ќова€ олонка("»дѕравила",	"—трока");
	“аб¬ыгруженныхќбъектов.Ќова€ олонка("“абќбъектов",	"“аблица«начений");
	
	//г—писокќбработанныхѕравил				=	—оздатьќбъект("—писок«начений");
	//г—писокЌеобработанныхѕравил			=	—оздатьќбъект("—писок«начений");
	
	г“аб эш–еквизитов«начений.”далить—троки();
	г“аб эшѕравил.”далить—троки();
	г“аб эшѕараметров«агрузки.”далить—троки();
	”становитьѕараметрыѕо”молчанию();
	

	ѕравилаќбмена							=	гѕравила.¬ыбрать”зел("ѕравилаќбмена");
	                                                                                  
	
	г‘айлƒанных								=	гXMLјнализатор.—оздатьѕоследовательно«аписываемыйƒокумент();
	г‘айлƒанных.»м€‘айла					=	‘орм»м€‘айлаƒанных;
	
	јтрибутыЁлемента						=	г‘айлƒанных.јтрибутыЁлемента;
	јтрибутыЁлемента.”становитьјтрибут("¬ерси€‘ормата",				"1.0");
	јтрибутыЁлемента.”становитьјтрибут("»д онфигурацииѕриемника",	ѕравилаќбмена.ѕолучитьјтрибут("»д онфигурацииѕриемника"),	0);
	јтрибутыЁлемента.”становитьјтрибут("»дѕравил онвертации",		ѕравилаќбмена.ѕолучитьјтрибут("»д"), 						0);
	јтрибутыЁлемента.”становитьјтрибут("ƒатаЌачала",				ѕолучить»дќбъекта»сточника(‘ормƒатаЌач)  );
	јтрибутыЁлемента.”становитьјтрибут("ƒатаќкончани€",				ѕолучить»дќбъекта»сточника(‘ормƒата он)  );
	//јтрибутыЁлемента.”становитьјтрибут(" омментарий",				,	0);
	
	г‘айлƒанных.ќткрытьЁлемент("‘айлќбмена");
	 
	
	//≈сли ‘орм‘л¬ключатьѕравила¬‘айл = 1 “огда
		г‘айлƒанных.¬ключитьЁлемент(ѕравилаќбмена);
		г‘айлƒанных.—бросить();
	// онец≈сли;
	 
	
	//-----		«агружаем правила с выборками	---------------------------
	
	//≈сли ‘орм‘л¬ыгружать“олько»нтерактивные	= 0	“огда
	//	¬ыборкаѕравил = гѕравила.¬ыбрать”злы("//ѕравило[@ѕо—сылкам=0]");
	//	ƒл€ —ч = 0 ѕо ¬ыборкаѕравил. оличество”злов() - 1 ÷икл
	//		Ёл_ѕравило	=	¬ыборкаѕравил.ѕолучить”зел(—ч);
	//		«агрузитьѕравило(Ёл_ѕравило);
	//	 онец÷икла;
	//	г“аб эшѕравил.¬ыгрузить(г—писокЌеобработанныхѕравил, , , "»д");
	// онец≈сли;
                                     
	//-----		ѕоследовательно обрабатываем правила конвертации	-------
	
	¬ыборкаѕравил = гѕравила.¬ыбрать”злы("//ѕравило");
	ƒл€ —ч = 0 ѕо ¬ыборкаѕравил. оличество”злов() - 1 ÷икл
		Ёл_ѕравило	=	¬ыборкаѕравил.ѕолучить”зел(—ч);
		≈сли ¬ыгрузитьƒанныеѕоѕравилу(Ёл_ѕравило) = "¬озврат" “огда ¬озврат  онец≈сли;
	 онец÷икла;
	
	
	//-----		ќбработка архивных расчетных документов		---------------
	          
	≈сли (ћетаданные.∆урнал–асчетов() > 0) » (ѕустое«начение(‘орм‘лЌеќбрабатыватьѕроведение) = 1) “огда
		≈сли гЅезќткрыти€‘ормы = 1 “огда
			//—ообщить("¬ыполн€етс€ обработка архивных расчетных документов");
		»наче
			“абќбласть4.“екст	=	"ќбработка архивных расчетных документов";
			г онт.“аблица.ѕоказать();
		 онец≈сли;
		јрхивированиеƒокументов();
	 онец≈сли;
	                                                                       
	
	//-----		ѕроведение документов	-----------------------------------
	                    
	≈сли ѕустое«начение(‘орм‘лЌеќбрабатыватьѕроведение) = 1 “огда
		≈сли гЅезќткрыти€‘ормы = 1 “огда
			//—ообщить("¬ыполн€етс€ обработка проведенных документов");
		»наче
			“абќбласть4.“екст		=	"ќбработка проведенных документов";
			г онт.“аблица.ѕоказать();
		 онец≈сли;
		ѕроведениеƒокументов();
	 онец≈сли;

	
	//-----		¬ыгрузка xml-объектов, добавленных в предопределенный список в скриптах	---------------
	
	ƒл€ —ч = 1 ѕо —писок”зловƒобавл€емыхѕослеѕроведени€.–азмер—писка() ÷икл
		«аписатьќбъект¬‘айл(—писок”зловƒобавл€емыхѕослеѕроведени€.ѕолучить«начение(—ч));
	 онец÷икла;
	
	
	//-----		¬ыгрузка запсией ∆– расчетных документов		---------------
	
	≈сли (ћетаданные.∆урнал–асчетов() > 0) » (ѕустое«начение(‘орм‘лЌеќбрабатыватьѕроведение) = 1) “огда
		≈сли гЅезќткрыти€‘ормы = 1 “огда
			//—ообщить("¬ыполн€етс€ выгрузка записей журналов расчетов");
		»наче
			“абќбласть4.“екст	=	"¬ыгрузка записей журналов расчетов";
			г онт.“аблица.ѕоказать();
		 онец≈сли;
		«аписи∆–ƒокументов();
	 онец≈сли;
	
	
	//-----		‘ормирование и выгрузка бух. итогов	-----------------------
	
	≈сли (‘орм‘лЌе¬ыгружатьЅух»тоги = 0) » (ћетаданные.ѕлан—четов(1).¬ыбран() = 1) “огда
		≈сли гЅезќткрыти€‘ормы = 1 “огда
			—ообщить("¬ыполн€етс€ выгрузка бухгалтерских итогов");
		»наче
			“абќбласть4.“екст			=	"¬ыгрузка бухгалтерских итогов";
			г онт.“аблица.ѕоказать();
		 онец≈сли;
		г олвоќпераций—ќстатками	=	1;
		«акрытие—четов();
	 онец≈сли;
	
	
	//-----		”становка текущих периодов журналов расчетов	-----------
	
	ƒл€ —ч∆урналов = 1 ѕо ћетаданные.∆урнал–асчетов() ÷икл
		¬ид∆–	=	ћетаданные.∆урнал–асчетов(—ч∆урналов).»дентификатор;
		∆–		=	—оздатьќбъект( "∆урнал–асчетов." + ¬ид∆–);
		
		≈сли Ќайтиѕравило(∆–) = 0 “огда ѕродолжить  онец≈сли;
		                               
		ѕараметры«агрузки			=	г“аб эшѕравил.ѕараметры«агрузки;
		¬ид∆–ѕриемника				=	г“аб эшѕравил.ѕриемник_¬ид;
		
		«агрузитьѕараметры«агрузки("", ѕараметры«агрузки);
		ƒата“екущегоѕериода∆–		=	г“аб эшѕараметров«агрузки.ƒата“екущегоѕериода∆–;
		≈сли ѕустое«начение(ƒата“екущегоѕериода∆–) = 1 “огда
			ƒата“екущегоѕериода∆–	=	∆–.“екущийѕериод().ƒатаЌачала;
		 онец≈сли;
		
		//	установим текущий период

		XML_DOM						=	гXMLјнализатор.—оздатьƒокумент();
		“екущийѕериод∆–				=	XML_DOM.—оздать”зел(1, "”становить“екущийѕериод∆–");
		”становитьјтрибут(“екущийѕериод∆–,	"¬ид∆–", 	¬ид∆–ѕриемника);
		”становитьјтрибут(“екущийѕериод∆–,	"ƒата", 	‘ормат(ƒата“екущегоѕериода∆–, "ƒƒƒћћ√√√√") );
		«аписатьќбъект¬‘айл(“екущийѕериод∆–);
	 онец÷икла;
	
	
	//---------------------------------------------------------------------
	
	
	г‘айлƒанных.«акрытьЁлемент();
	г‘айлƒанных.—бросить();
	г‘айлƒанных.«авершить();
           
	
	//г‘лаг¬ыгрузкаѕроизведена	=	1;
	
	—осто€ние("¬ыгрузка данных завершена!");


	≈сли гЅезќткрыти€‘ормы = 1 “огда
		—ообщить("¬ыгрузка данных завершена!");
		—ообщить("¬ыгружено объектов:   " + г—четчик¬ыгруженныхќбъектов);
	»наче
		“абќбласть3.“екст	=	" онец выгрузки -  " + “екущее¬рем€();
		“абќбласть1.“екст	=	"¬ыгрузка данных завершена!";
		“абќбласть4.“екст	=	"¬ыгружено объектов:   " + г—четчик¬ыгруженныхќбъектов;
		г онт.“аблица.ѕоказать();
	 онец≈сли;
	
	
 онецѕроцедуры		//	¬ыгрузитьƒанные()
            
//--------------------------------------------------------------------------------------------------

ѕроцедура ѕриќткрытии()
        
	—татус¬озврата(0);
	
	//≈сли ‘с.—уществует‘айл(гѕутьќбъекта_»сполн€емый од) = 1 “огда ‘с.”далить‘айл(гѕутьќбъекта_»сполн€емый од)  онец≈сли;
	
	гXMLјнализатор		=	—оздатьќбъект("AddIn.XMLParser");
	
	—писокѕараметров	=	‘орма.ѕараметр;
	≈сли ѕустое«начение(—писокѕараметров) = 1 “огда
		ѕредупреждение("ƒанна€ обработка не может использоватьс€ самосто€тельно!");
		¬озврат;
	 онец≈сли;
	
	г онт								=	—писокѕараметров.ѕолучить(" онтекст");
	                                                    
	гѕравила							=	—писокѕараметров.ѕолучить("гѕравила");
	г“абќбъектов						=	—писокѕараметров.ѕолучить("г“абќбъектов");
	
	гЅезќткрыти€‘ормы					=	—писокѕараметров.ѕолучить("Ѕезќткрыти€‘ормы");
	
	г—писокѕараметров					=	—писокѕараметров.ѕолучить("—писокѕараметров");
    
	                 
	≈сли “ип«начени€—тр(г—писокѕараметров) <> "—писок«начений" “огда
		г—писокѕараметров	=	—оздатьќбъект("—писок«начений");
	 онец≈сли;

	    
	Ќачальна€»нициализаци€();
	
	¬ыгрузитьƒанные();
	
 онецѕроцедуры		//	ѕриќткрытии()

//--------------------------------------------------------------------------------------------------

ѕроцедура Ќачальна€»нициализаци€()
	
	
	‘ормƒатаЌач							=	г онт.‘ормƒатаЌач;
	‘ормƒата он							=	г онт.‘ормƒата он;
	‘орм»м€‘айлаƒанных					=	г онт.‘орм»м€‘айлаƒанных;
                                                                        
	‘орм‘лЌе¬ыгружатьЅух»тоги			=	г онт.‘орм‘лЌе¬ыгружатьЅух»тоги;
	‘ормƒата–асчетаЅух»тогов			=	г онт.‘ормƒата–асчетаЅух»тогов;
	‘орм од—четаƒл€¬водаќстатков		=	г онт.‘орм од—четаƒл€¬водаќстатков;
	‘ормћакс олвоѕроводок				=	г онт.‘ормћакс олвоѕроводок;
	‘ормѕланы—четов						=	г онт.‘ормѕланы—четов;
	‘орм–азделители”чета				=	г онт.‘орм–азделители”чета;
	
	‘орм олвоЅуферизуемыхќбъектов		=	г онт.‘орм олвоЅуферизуемыхќбъектов;
	‘орм‘л¬ключатьѕравила¬‘айл			=	г онт.‘орм‘л¬ключатьѕравила¬‘айл;
	‘орм‘лЌеќбрабатыватьѕроведение		=	г онт.‘орм‘лЌеќбрабатыватьѕроведение;
	‘орм‘л¬ыгружать“олько»нтерактивные	=	г онт.‘орм‘л¬ыгружать“олько»нтерактивные;
	
	‘орм‘л«апоминать—сылки				=	г онт.‘орм‘л«апоминать—сылки;
	
	
	////////////////////////////////////////////////////////////////////////////////////////////////////
	//	

	–асположение‘айла(г—трѕуть, г»м€‘айла);
	
	гѕутьќбъекта_»сполн€емый од			=	 аталог»Ѕ() + "CDExpVar.txt";
	
	
	////////////////////////////////////////////////////////////////////////////////////////////////////
	//	»нициализаци€ кэш-таблиц
	
	г“аб эш–еквизитов	=	—оздатьќбъект("“аблица«начений");
	г“аб эш–еквизитов.Ќова€ олонка("»д",								"—трока");
	
	г“аб эш–еквизитов.Ќова€ олонка("»сточник_»д",						"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("»сточник_“ипјтрибута",				"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("»сточник_“ип",						"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("»сточник_¬ид",						"—трока");
	
	г“аб эш–еквизитов.Ќова€ олонка("ѕриемник_»д",						"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("ѕриемник_“ипјтрибута",				"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("ѕриемник_“ип",						"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("ѕриемник_¬ид",						"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("ѕриемник_ƒлина",					"„исло");
	
	г“аб эш–еквизитов.Ќова€ олонка("ѕреобразование",					"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("ѕравило",							"—трока");
	
	//г“аб эш–еквизитов.Ќова€ олонка("≈стьѕроцедура",					"„исло", 1, 0);
	//г“аб эш–еквизитов.Ќова€ олонка("ѕолучить»зѕараметров",			"„исло", 1, 0);
	
	г“аб эш–еквизитов.Ќова€ олонка("≈стьѕроцедура",						"„исло");	//	так работает быстрее
	г“аб эш–еквизитов.Ќова€ олонка("ѕолучить»зѕараметров",				"„исло");
	
	г“аб эш–еквизитов.Ќова€ олонка("ѕараметрыѕравила",					"—трока");
	
	г“аб эш–еквизитов.Ќова€ олонка("—пособ¬ыгрузки",					"—трока");
	г“аб эш–еквизитов.Ќова€ олонка("—пособ«агрузки",					"—трока");
	
	г“аб эш–еквизитов.Ќова€ олонка("”слови€");
	г“аб эш–еквизитов.Ќова€ олонка("¬ид”слови€", 						"„исло");	// 0 - не задано, 1 - по объекту, 2 - по реквизиту
	
	//--------------------
	
	г“аб эш–еквизитов«начений	=	—оздатьќбъект("“аблица«начений");
	г“аб эш–еквизитов«начений.Ќова€ олонка("»д",						"—трока");
	
	г“аб эш–еквизитов«начений.Ќова€ олонка("»сточник_»д",				"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("»сточник_“ип",				"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("»сточник_¬ид",				"—трока");
	
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕриемник_»д",				"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕриемник_“ип",				"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕриемник_¬ид",				"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕриемник_ƒлина",			"„исло");
	
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕреобразование",			"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕравило",					"—трока");
	г“аб эш–еквизитов«начений.Ќова€ олонка("≈стьѕроцедура",				"„исло");
	
	г“аб эш–еквизитов«начений.Ќова€ олонка("ѕараметрыѕравила",			"—трока");
	
	г“аб эш–еквизитов«начений.Ќова€ олонка("”слови€");
	г“аб эш–еквизитов«начений.Ќова€ олонка("¬ид”слови€", 				"„исло");	// 1 - условие задано
	
	//--------------------
	
	г“аб эшѕравил	=	—оздатьќбъект("“аблица«начений");
	г“аб эшѕравил.Ќова€ олонка("»д",									"—трока");
	
	г“аб эшѕравил.Ќова€ олонка("ѕравило");
	г“аб эшѕравил.Ќова€ олонка("”слови€");
	г“аб эшѕравил.Ќова€ олонка("¬ид”слови€", 							"„исло");	// 1 - условие задано
	
	г“аб эшѕравил.Ќова€ олонка("ѕо—сылкам",								"„исло");
	
	г“аб эшѕравил.Ќова€ олонка("»сточник_“ип",							"—трока");
	г“аб эшѕравил.Ќова€ олонка("»сточник_¬ид",							"—трока");
	
	г“аб эшѕравил.Ќова€ олонка("ѕриемник_“ип",							"—трока");
	г“аб эшѕравил.Ќова€ олонка("ѕриемник_¬ид",							"—трока");
	
	г“аб эшѕравил.Ќова€ олонка("»д—инхронизирующего–еквизита",			"—трока");
	
	г“аб эшѕравил.Ќова€ олонка("ѕреобразование",						"—трока");
	г“аб эшѕравил.Ќова€ олонка("ѕравилоѕереадресации",					"—трока");
	г“аб эшѕравил.Ќова€ олонка("ѕараметры«агрузки",						"—трока");
	
	≈сли ћетаданные.∆урнал–асчетов() > 0 “огда
		г“аб эшѕравил.Ќова€ олонка("”никальность",						"—трока");
		г“аб эшѕравил.Ќова€ олонка("ƒатаќтсчета",						"ƒата");
	 онец≈сли;
	
	г“аб эшѕравил.Ќова€ олонка("“аб–еквизитовѕоиска",					"“аблица«начений");
	г“аб эшѕравил.Ќова€ олонка("“аб–еквизитов",							"“аблица«начений");
	г“аб эшѕравил.Ќова€ олонка("“аб–еквизитов—трок",					"“аблица«начений");
	
	//--------------------
	
	г“аб эшѕараметров«агрузки	=	—оздатьќбъект("“аблица«начений");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("»д",						"—трока");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("ƒата",						"ƒата");
	
	г“аб эшѕараметров«агрузки.Ќова€ олонка("«амещатьЌайденные",			"„исло");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("ЌовыеЌе—оздавать",			"„исло");
	
	г“аб эшѕараметров«агрузки.Ќова€ олонка("—пособ«агрузки",			"—трока");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("—татус”далени€",			"—трока");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("—татусѕроводок",			"—трока");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("—татусѕроведени€",			"—трока");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("—татус–асчетныхƒокументов",	"—трока");
	
	г“аб эшѕараметров«агрузки.Ќова€ олонка("ƒата“екущегоѕериода∆–",		"ƒата");
	
	г“аб эшѕараметров«агрузки.Ќова€ олонка("«агружатьќперации",			"„исло");
	г“аб эшѕараметров«агрузки.Ќова€ олонка("«агружать«аписи∆–",			"„исло");
	
	г“аб эшѕараметров«агрузки.Ќова€ олонка("ѕравилоќпераций");
	
 онецѕроцедуры		//	Ќачальна€»нициализаци€()

//**************************************************************************************************
‘ункци€ ƒополнительныеѕреобразовани€(¬ид="", »д="", »сточник="", ѕриемник="", —писокѕараметровѕравила="")
	
	¬озврат(0);
	
 онец‘ункции
